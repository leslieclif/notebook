<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Leslie><link href=https://leslieclif.github.io/notebook/k8s/testing/ rel=canonical><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.1, mkdocs-material-7.0.3"><title>Consumer-driven contracts (CDC) - Leslie's Online Notebook</title><link rel=stylesheet href=../../assets/stylesheets/main.1655a90d.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.7fa14f5b.min.css><script src=../../assets/extra.js type=text/javascript></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/extra.css></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#consumer-driven-contracts-cdc class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Leslie's Online Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Consumer-driven contracts (CDC) </span> </div> </div> </div> <div class=md-header__options> <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon"> <a href=javascript:toggleScheme(); title="Dark mode" class=dark-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg> </a> <a href=javascript:toggleScheme(); title="Light mode" class=light-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg> </a> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> Leslie's Online Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../developer/ class=md-nav__link> Developer Setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Devops data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/ class=md-nav__link> Devops </a> </li> <li class=md-nav__item> <a href=../../devops/ci/ class=md-nav__link> CI </a> </li> <li class=md-nav__item> <a href=../../devops/cd/ class=md-nav__link> CD </a> </li> <li class=md-nav__item> <a href=../../devops/iac/ class=md-nav__link> IAC </a> </li> <li class=md-nav__item> <a href=../../devops/gitops/ class=md-nav__link> GitOps </a> </li> <li class=md-nav__item> <a href=../../devops/devops-engineer/ class=md-nav__link> Skills </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> IDE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDE data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> IDE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ide/ class=md-nav__link> IDE Tips and Tricks </a> </li> <li class=md-nav__item> <a href=../../ide/markdown/ class=md-nav__link> Markdown </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Server <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Server data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../server/ class=md-nav__link> Server Details </a> </li> <li class=md-nav__item> <a href=../../server/install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../server/mobile/ class=md-nav__link> Mobile </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ansible data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../learning/ansible/ansible/ class=md-nav__link> Ansible </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../install/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Learning <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Learning data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../learning/git/ class=md-nav__link> Git </a> </li> <li class=md-nav__item> <a href=../../learning/python/ class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../learning/vagrant/ class=md-nav__link> Vagrant </a> </li> <li class=md-nav__item> <a href=../../learning/terraform/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../learning/docker/docker-notes/ class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=../../learning/k8s/k8s-notes/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../learning/linux/linux/ class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../learning/linux/security/ class=md-nav__link> Linux_Security </a> </li> <li class=md-nav__item> <a href=../../learning/linux/firewall/ class=md-nav__link> Linux_Firewall </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#consumer-driven-contracts-cdc class=md-nav__link> Consumer-driven contracts (CDC) </a> <nav class=md-nav aria-label="Consumer-driven contracts (CDC)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-is-consumer-driven-contract-testing class=md-nav__link> What is consumer-driven contract testing? </a> </li> <li class=md-nav__item> <a href=#about-the-application class=md-nav__link> About the Application </a> </li> <li class=md-nav__item> <a href=#add-pact-broker class=md-nav__link> Add Pact Broker </a> </li> <li class=md-nav__item> <a href=#generate-pact-from-consumer class=md-nav__link> Generate Pact from Consumer </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Consumer-driven contracts (CDC)</h1> <h2 id=consumer-driven-contracts-cdc>Consumer-driven contracts (CDC)<a class=headerlink href=#consumer-driven-contracts-cdc title="Permanent link">&para;</a></h2> <p>CDC is a concept and testing approach that embraces the perspective of multiple consumers that communicate with providers. Typically, testing tends to define API contracts from the provider's perspective. Through a registry of contracts, multiple consumers now have a voice to provide producers their expectations on how data should be exchanged between the consumers and producers. 1. Set up a Pact Broker on Kubernetes 1. Write a consumer that defines and publishes Pact contracts 1. Deploy and run a few Spring Boot microservices on Kubernetes 1. Connect microservices to a database and public data source 1. Verify the consumer pacts against a producer 1. Find API defects and fix them</p> <h3 id=what-is-consumer-driven-contract-testing>What is consumer-driven contract testing?<a class=headerlink href=#what-is-consumer-driven-contract-testing title="Permanent link">&para;</a></h3> <p>The "consumer-driven" prefix simply states an additional philosophical position that advocates for better internal microservices design by putting the consumers of such APIs at the heart of the design process. Provider-driven APIs tend to be biased towards the data that is being exposed and the system that is exposing it. - <a href=https://pactflow.io/blog/author/matt/ >PACT</a> <div class=highlight><pre><span></span><code><span class=c1># Adding the Private Repo helmchart (Refer Chaos)</span>
helm repo add twuni https://helm.twun.io
helm install registry twuni/docker-registry <span class=se>\</span>
  --version <span class=m>1</span>.10.0 <span class=se>\</span>
  --namespace kube-system <span class=se>\</span>
  --set service.type<span class=o>=</span>NodePort <span class=se>\</span>
  --set service.nodePort<span class=o>=</span><span class=m>31500</span>
<span class=nb>export</span> <span class=nv>REGISTRY</span><span class=o>=</span><span class=m>2886795362</span>-31500-kira01.environments.katacoda.com
curl <span class=nv>$REGISTRY</span>/v2/_catalog <span class=p>|</span> jq
<span class=c1># Registry Proxy for localhost:5000</span>
<span class=c1># Docker tags require the address of the registry to be in the tag.</span>
<span class=c1># If we push and pull from the registry, the registry name tag must be the same when we are on the client or within Kubernetes. Within your cluster, the registry is available at localhost:5000. Use a port-forwarding command to make this client&#39;s localhost:5000 to be the same registry.</span>
kubectl port-forward -n kube-system service/registry-docker-registry <span class=m>5000</span>:5000 &gt; /dev/null <span class=p>&amp;</span>
<span class=c1># This port forwarding will run in the background for the remainder of this scenario.</span>
<span class=c1># Now you can access the registry via localhost.</span>
curl http://localhost:5000/v2/_catalog <span class=p>|</span> jq .
<span class=c1># This means when you push to localhost:5000, your container images will be routed to the private registry running as a service on Kubernetes.</span>

<span class=c1># But what happens in the Pod specification when you want to pull the image using the tag localhost:5000? </span>
<span class=c1># We can add a proxy that runs as a DaemonSet that will resolve localhost:5000 to the registry whenever a Pod requests a container from localhost:5000. Install the proxy.</span>
helm repo add incubator https://charts.helm.sh/incubator
<span class=c1># With the added repo, install the proxy daemons.</span>

helm install registry-proxy incubator/kube-registry-proxy <span class=se>\</span>
  --version <span class=m>0</span>.3.2 <span class=se>\</span>
  --namespace kube-system <span class=se>\</span>
  --set registry.host<span class=o>=</span>registry-docker-registry.kube-system <span class=se>\</span>
  --set registry.port<span class=o>=</span><span class=m>5000</span> <span class=se>\</span>
  --set <span class=nv>hostPort</span><span class=o>=</span><span class=m>5000</span>

<span class=c1># For mature environments, you would have an official host name with a load balancer and an ingress that would resolve to a hardened registry service, albeit still running on Kubernetes.</span>

<span class=c1># You will use docker push commands and YAML container references both using localhost:5000.</span>
</code></pre></div></p> <h3 id=about-the-application>About the Application<a class=headerlink href=#about-the-application title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Clone Source Code</span>
git clone https://github.com/javajon/cdc-with-k8s
<span class=nb>cd</span> ~/cdc-with-k8s
tree -d -L <span class=m>2</span>

<span class=c1># In summary, the aggregator serves data combining the daily COVID-19 metrics with the world population. </span>
</code></pre></div> <h3 id=add-pact-broker>Add Pact Broker<a class=headerlink href=#add-pact-broker title="Permanent link">&para;</a></h3> <ul> <li>The Pact broker is the key that enables separation between the consumers and producers. The pact broker is a registry, or a library, that serves the collections of contacts generated by the consumers during mock testing and referenced by the producers during verification. <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/cluster
<span class=c1># There are two Kubernetes manifest files that declare the Deployments for the Pact Broker and its associated Postgres database. </span>
kubectl apply -f pact-broker-postgres.yaml
kubectl apply -f pact-broker.yaml
<span class=c1># The database is used for storing the Pacts and is attached to a Persistent Volume (PV) reserved in this cluster.</span>
<span class=c1># Open the Pact Broker web interface and observe its contents.</span>
<span class=c1># The broker is essentially empty. It does have an Example App, but this is just a sample. </span>
</code></pre></div></li> </ul> <h3 id=generate-pact-from-consumer>Generate Pact from Consumer<a class=headerlink href=#generate-pact-from-consumer title="Permanent link">&para;</a></h3> <ul> <li>With the Pact framework, it's the consumers that create the Pacts. Independent of the producers or any service, the consumers write testing code that creates conversations with local mocked services. The Mocks are the consumer's perspectives of how the producers should react to the consumer's requests.</li> <li>This particular consumer is written in Node.js. It also uses Jest - a delightful JavaScript Testing Framework with a focus on simplicity.</li> <li><a href=https://www.mariedrake.com/post/contract-testing-with-pact-js-and-jest>CDC with Jest and Pact</a> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/pact
<span class=c1># Generate Pact Contracts</span>
npm install
<span class=c1># Produce the two Pact files:</span>
npm run test:consumer-a
npm run test:consumer-b
<span class=c1># Once complete, new Pact JSON files are in the pacts directory. Inspect one of the contract files:</span>
cat pacts/consumer_a-aggregator.json <span class=p>|</span> jq -C .

<span class=c1># Publish Pacts to Pact Broker</span>
<span class=c1># Define access to the Pact Broker:</span>
<span class=nb>export</span> <span class=nv>PACT_BROKER_URL</span><span class=o>=</span>https://2886795362-30111-kira01.environments.katacoda.com/
<span class=nb>export</span> <span class=nv>BROKER_USERNAME</span><span class=o>=</span>pactbroker
<span class=nb>export</span> <span class=nv>BROKER_PASSWORD</span><span class=o>=</span>pactbroker

<span class=c1># Publish the pact to the broker:</span>
npm run publish:pact

<span class=c1># Verify the pact has been published to the Pact Broker.</span>
</code></pre></div></li> <li>Run H2 Database</li> <li>A low-level container in this application is a small database that contains world population data. You will use it as a read-only datastore providing the populations for the countries of the world, as well as the populations and locations of major cities. </li> <li>Provided in this example is a SQL script that will seed a relational database, so we need to create an "initContainer" that will run next to the H2 container and seed it with the country and city population data when it starts. </li> <li>The InitContainer pattern is very common for ensuring Pods are in the correct state when started. <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/h2-seeder
<span class=c1># Take a look at the Dockerfile to see how when it runs is uses an H2 RunScript utility to inject the world.sql into the H2 database that is assumed to be local, in the same Pod.</span>
docker build -t localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1 .
<span class=c1># During the image build you can safely ignore the TLS certificate validation not implemented</span>
docker push localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
curl <span class=nv>$REGISTRY</span>/v2/_catalog <span class=p>|</span> jq
<span class=c1># Apply this manifest declaration to set up a Pod and Service for H2.</span>
kubectl apply -f ../cluster/h2-world.yaml

<span class=c1># The H2 database serves a convenient web interface for you to interact with the database. When you are presented with the connection information just put in jdbc:h2:/h2-data/world for the JDBC driver URL and leave the username and password blank.</span>

<span class=c1># Use the Connect button to enter the SQL explorer. Enter </span>
<span class=k>select</span> * from country
</code></pre></div></li> <li>Run World Population Microservice</li> <li>This is a Spring Boot based Microservice that simply reads world population data from the H2 database using SQL select calls. It offers REST endpoints to get the populations from <code>/countries</code> and <code>/cities</code>. Data is provided in the JSON format. <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/world-pop
<span class=c1># Build Microservice Container Image</span>
<span class=c1># Spring Boot with Gradle (or Maven) has a convenient task called bootBuildImage. Without having to write a Dockerfile this task will bundle the Java application into an optimized container image. Build and tag the microservice container image</span>
./gradlew bootBuildImage --imageName<span class=o>=</span>localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
docker push localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
curl <span class=nv>$REGISTRY</span>/v2/_catalog <span class=p>|</span> jq

<span class=c1># Start Microservice</span>
kubectl apply -f ../cluster/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>.yaml
<span class=c1># The microservice will be running in a moment.</span>

<span class=c1># Verify Microservice</span>
curl https://2886795296-30101-kira01.environments.katacoda.com/ping<span class=p>;</span> <span class=nb>echo</span>
curl https://2886795296-30101-kira01.environments.katacoda.com/countries <span class=p>|</span> jq .
curl https://2886795296-30101-kira01.environments.katacoda.com/cities <span class=p>|</span> jq .
</code></pre></div></li> <li>Run COVID-19 Microservice</li> <li>This is a Spring Boot based Microservice that reads COVID-19 metrics from a public CSV file. This microservice offers REST endpoints to get the data from the /metrics. Data is provided in the JSON format. <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/covid-19
./gradlew bootBuildImage --imageName<span class=o>=</span>localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
docker push localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
<span class=c1># Start Microservice</span>
kubectl apply -f ../cluster/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>.yaml
kubectl get pods,deployments,services -l <span class=nv>app</span><span class=o>=</span><span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>
<span class=c1># Verify Microservice</span>
curl https://2886795296-30102-kira01.environments.katacoda.com/ping<span class=p>;</span> <span class=nb>echo</span>
curl https://2886795296-30102-kira01.environments.katacoda.com/metrics <span class=p>|</span> jq .
</code></pre></div></li> <li>Run Aggregator Microservice</li> <li>This microservice is called the Aggregator as it follows the common architecture pattern of an aggregator. It provides a single API gateway to access the other two microservices: world-pop and covid-19. The data from the two other microservices are merged into responses where COVID-19 data is merged with population data. With population data, you can get visibility in infection rates based on per capita. <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/aggregator
./gradlew bootBuildImage --imageName<span class=o>=</span>localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
docker push localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.1
curl <span class=nv>$REGISTRY</span>/v2/_catalog <span class=p>|</span> jq
<span class=c1># Start Microservice</span>
kubectl apply -f ../cluster/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>.yaml
<span class=c1># Verify Microservice</span>
curl https://2886795296-30103-kira01.environments.katacoda.com/ping<span class=p>;</span> <span class=nb>echo</span>
curl https://2886795296-30103-kira01.environments.katacoda.com/countries <span class=p>|</span> jq .
<span class=c1># Get a single country.</span>
curl https://2886795296-30103-kira01.environments.katacoda.com/countries/ind <span class=p>|</span> jq .
<span class=c1># Get the top countries with the highest infections per capita:</span>
curl https://2886795296-30103-kira01.environments.katacoda.com/countries/percapita <span class=p>|</span> jq .
</code></pre></div></li> <li>Verify Application (Failed?)</li> <li>Now that everything is started let's verify the contracts against the actual service. <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/aggregator
<span class=c1># Verify the pacts on the producer side:</span>
./gradlew pactVerify
<span class=c1># You will see that the verification failed. This shows us that a consumer disagrees with the producer. This disagreement is fantastic because it&#39;s unveiling a defect before it rolls further to production.</span>
<span class=c1># If you inspect all the percentCases fields from the producer, they are all zero:</span>
curl https://2886795296-30103-kira01.environments.katacoda.com/countries/percapita <span class=p>|</span> jq . <span class=p>|</span> grep percentCases
<span class=c1># The consumer contracts all expect the percentage of infection values to be greater than zero. The consumer code is written with these rules.</span>
<span class=sb>`</span>expect<span class=o>(</span>Number<span class=o>(</span>response<span class=o>[</span><span class=m>0</span><span class=o>]</span>.percentCases<span class=o>))</span>.toBeGreaterThan<span class=o>(</span><span class=m>0</span>.0<span class=o>)</span><span class=p>;</span>
percentCases: term<span class=o>({</span> generate: <span class=s2>&quot;0.3333&quot;</span>, matcher: <span class=s2>&quot;^([0-9]*[1-9][0-9]*(\.[0-9]+)?|[0]+\.[0-9]*[1-9][0-9]*)</span>$<span class=s2>&quot;</span> <span class=o>})</span>,<span class=sb>`</span>
<span class=c1># So for some reason, the producer is producing only zeros. A typical defect on any normal day.</span>
</code></pre></div></li> <li>Make Correction</li> <li>The problem is in the producer (aggregator) code <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/cdc-with-k8s/aggregator
<span class=c1># Look at the code in models/Country.java:</span>
sed -n <span class=s1>&#39;{;=;p}&#39;</span> src/main/java/com/dijure/aggregator/models/Country.java <span class=p>|</span> sed <span class=s2>&quot;N;s/\n/ /g&quot;</span> <span class=p>|</span> sed -n <span class=s1>&#39;65,70p;!d&#39;</span>
<span class=c1># There&#39;s the bugger... Someone left in some testing code with an experimentation comment!</span>
<span class=c1># Find and remove the offending line:</span>
<span class=nv>OFFENDING_LINE</span><span class=o>=</span><span class=k>$(</span>sed -n <span class=s1>&#39;\|population = 0;|=&#39;</span> src/main/java/com/dijure/aggregator/models/Country.java<span class=k>)</span>
sed -i <span class=s2>&quot;</span><span class=si>${</span><span class=nv>OFFENDING_LINE</span><span class=si>}</span><span class=s2>d&quot;</span> src/main/java/com/dijure/aggregator/models/Country.java
<span class=c1># Verify the moth has been removed from the relay</span>
</code></pre></div></li> <li>Verify Application</li> <li>Rebuild the new container with an increased SemVer number. We bump the patch value, since it's a bug fix <div class=highlight><pre><span></span><code>./gradlew bootBuildImage --imageName<span class=o>=</span>localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.2
<span class=c1># Push the corrected container image to the private registry on your Kubernetes cluster</span>
docker push localhost:5000/<span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>:0.0.2
<span class=c1># Patch the current deployment to use the new container version</span>
kubectl patch deployment aggregator -p <span class=se>\</span>
  <span class=s1>&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;aggregator&quot;,&quot;image&quot;:&quot;localhost:5000/aggregator:0.0.2&quot;}]}}}}&#39;</span>
<span class=c1># Verify</span>
kubectl get pods,deployments,services -l <span class=nv>app</span><span class=o>=</span><span class=k>$(</span>basename <span class=nv>$PWD</span><span class=k>)</span>
<span class=c1># Finally, run the pactVerify task again, and let&#39;s see if that bug has been squashed:</span>
./gradlew pactVerify
</code></pre></div></li> <li>This means that your producer agrees with the contracts independently generated by all its consumers.</li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2022 - Leslie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> with emoji by <a href=https://github.com/twitter/twemoji target=_blank rel=noopener> Twemoji </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing"}, "version": null}</script> <script src=../../assets/javascripts/bundle.ca5457b8.min.js></script> </body> </html>