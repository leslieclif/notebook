<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Leslie><link href=https://leslieclif.github.io/notebook/base/terraform/tfe/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.1, mkdocs-material-7.0.3"><title>TFE (Standalone) - Leslie's Online Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/main.1655a90d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.7fa14f5b.min.css><script src=../../../assets/extra.js type=text/javascript></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/extra.css></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#tfe-standalone class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Leslie's Online Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> TFE (Standalone) </span> </div> </div> </div> <div class=md-header__options> <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon"> <a href=javascript:toggleScheme(); title="Dark mode" class=dark-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg> </a> <a href=javascript:toggleScheme(); title="Light mode" class=light-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg> </a> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> Leslie's Online Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../developer/ class=md-nav__link> Developer Setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Devops data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/ class=md-nav__link> Devops </a> </li> <li class=md-nav__item> <a href=../../../devops/ci/ class=md-nav__link> CI </a> </li> <li class=md-nav__item> <a href=../../../devops/cd/ class=md-nav__link> CD </a> </li> <li class=md-nav__item> <a href=../../../devops/iac/ class=md-nav__link> IAC </a> </li> <li class=md-nav__item> <a href=../../../devops/gitops/ class=md-nav__link> GitOps </a> </li> <li class=md-nav__item> <a href=../../../devops/devops-engineer/ class=md-nav__link> Skills </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> IDE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDE data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> IDE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ide/ class=md-nav__link> IDE Tips and Tricks </a> </li> <li class=md-nav__item> <a href=../../../ide/markdown/ class=md-nav__link> Markdown </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Server <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Server data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../server/ class=md-nav__link> Server Details </a> </li> <li class=md-nav__item> <a href=../../../server/install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../server/mobile/ class=md-nav__link> Mobile </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ansible data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../learning/ansible/ansible/ class=md-nav__link> Ansible </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../k8s/install/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Learning <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Learning data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../learning/git/ class=md-nav__link> Git </a> </li> <li class=md-nav__item> <a href=../../../learning/python/ class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../../learning/vagrant/ class=md-nav__link> Vagrant </a> </li> <li class=md-nav__item> <a href=../../../learning/terraform/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../../learning/docker/docker-notes/ class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=../../../learning/k8s/k8s-notes/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../learning/linux/linux/ class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../../learning/linux/security/ class=md-nav__link> Linux_Security </a> </li> <li class=md-nav__item> <a href=../../../learning/linux/firewall/ class=md-nav__link> Linux_Firewall </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#tfe-standalone class=md-nav__link> TFE (Standalone) </a> <nav class=md-nav aria-label="TFE (Standalone)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goals-vs-goals class=md-nav__link> Goals vs. !Goals </a> </li> <li class=md-nav__item> <a href=#how-to-use-this-repository-for-a-client class=md-nav__link> How to use this repository for a client </a> </li> <li class=md-nav__item> <a href=#all-examples class=md-nav__link> All Examples </a> <nav class=md-nav aria-label="All Examples"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-to-run-quick class=md-nav__link> How to Run (quick) </a> </li> <li class=md-nav__item> <a href=#potential-issues class=md-nav__link> Potential Issues </a> </li> <li class=md-nav__item> <a href=#modules class=md-nav__link> Modules </a> <nav class=md-nav aria-label=Modules> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tls class=md-nav__link> tls </a> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> networking </a> </li> <li class=md-nav__item> <a href=#external-services class=md-nav__link> external-services </a> </li> <li class=md-nav__item> <a href=#configs class=md-nav__link> configs </a> </li> <li class=md-nav__item> <a href=#key-vault class=md-nav__link> key-vault </a> </li> <li class=md-nav__item> <a href=#load-balancer class=md-nav__link> load-balancer </a> </li> <li class=md-nav__item> <a href=#tfe class=md-nav__link> tfe </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#specific-examples class=md-nav__link> Specific Examples </a> <nav class=md-nav aria-label="Specific Examples"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#public-load-balancer class=md-nav__link> Public Load Balancer </a> </li> <li class=md-nav__item> <a href=#public-application-gateway class=md-nav__link> Public Application Gateway </a> </li> <li class=md-nav__item> <a href=#private-application-gateway class=md-nav__link> Private Application Gateway </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#azure-highlights--gotchas class=md-nav__link> Azure Highlights &amp; Gotchas </a> <nav class=md-nav aria-label="Azure Highlights & Gotchas"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#virtual-machine-scale-sets class=md-nav__link> Virtual Machine Scale Sets </a> </li> <li class=md-nav__item> <a href=#public-azure-load-balancer class=md-nav__link> Public Azure Load Balancer </a> </li> <li class=md-nav__item> <a href=#private-azure-load-balancer class=md-nav__link> Private Azure Load Balancer </a> </li> <li class=md-nav__item> <a href=#azure-application-gateway class=md-nav__link> Azure Application Gateway </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#todo class=md-nav__link> TODO </a> </li> <li class=md-nav__item> <a href=#known-issues class=md-nav__link> Known Issues </a> <nav class=md-nav aria-label="Known Issues"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#private-azure-application-gateway-unable-to-set-specific-zones class=md-nav__link> Private Azure Application Gateway unable to set specific Zones </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#tools class=md-nav__link> Tools </a> <nav class=md-nav aria-label=Tools> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sshuttle class=md-nav__link> sshuttle </a> </li> <li class=md-nav__item> <a href=#pre-commit-terraform class=md-nav__link> pre-commit-terraform </a> </li> <li class=md-nav__item> <a href=#openssl class=md-nav__link> openssl </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>TFE (Standalone)</h1> <h2 id=tfe-standalone>TFE (Standalone)<a class=headerlink href=#tfe-standalone title="Permanent link">&para;</a></h2> <p>Terraform modules for deploying production ready Terraform Enterprise platform.</p> <h3 id=goals-vs-goals>Goals vs. !Goals<a class=headerlink href=#goals-vs-goals title="Permanent link">&para;</a></h3> <p><em>What is this repository meant to do?</em></p> <p>The goal of this repository is to accelerate the installation of TFE for our clients across several common scenarios. In other words, this should get you 80% (or more) of what you need to deploy TFE.</p> <p><em>What is this repository <strong>NOT</strong> meant to do?</em></p> <p>This repository does not claim or meant to be the single golden standard for the installation of TFE. It is not expected that this repository can be used as-is, with zero modification, rather is customized per installation by swapping out and modifying the existing submodules.</p> <h3 id=how-to-use-this-repository-for-a-client>How to use this repository for a client<a class=headerlink href=#how-to-use-this-repository-for-a-client title="Permanent link">&para;</a></h3> <blockquote> <p>Note: This is by no means the only way to interact with this repository, but simply the general idea of how it is intended to be used.</p> </blockquote> <ol> <li>Create a branch off of master.</li> <li>Pick the example that matches your use case the closest (see below).</li> <li>Create a folder specific to the client (i.e. ./clients/SOME-BIG_COMPANY) and copy over the example.</li> <li>Customize the code to your use case, testing in a sandbox environment.</li> <li>Test and Validate things work as expected.</li> <li>Zip up the code and ship to the client for code review, getting the code into their source control.</li> <li>Deploy and Validate in the client environment.</li> <li>Contribute back to master and example, submodule, or documentation changes that could be helpful.</li> </ol> <h3 id=all-examples>All Examples<a class=headerlink href=#all-examples title="Permanent link">&para;</a></h3> <p>All examples are very similar but differ by the choice of load balancing.</p> <p>This section is applicable for each example.</p> <h4 id=how-to-run-quick>How to Run (quick)<a class=headerlink href=#how-to-run-quick title="Permanent link">&para;</a></h4> <ul> <li><code>cd</code> into an example folder.</li> <li> <p>Create a <code>terraform.tfvars</code> file (check out the README.md in the examples folder for a complete list of variables) <div class=highlight><pre><span></span><code>namespace            = &quot;USERNAME-tfe&quot;
location             = &quot;centralus&quot;
domain               = &quot;company.com&quot;
subdomain            = &quot;tfe&quot;
distribution         = &quot;ubuntu&quot;
public_ip_allowlist  = [
  &quot;x.x.x.x&quot;, # Your current IP
]
tags = {
  owner = &quot;USERNAME&quot;
}
</code></pre></div></p> </li> <li> <p>Place your TFE License file in <code>./keys/tfe-license.rli</code></p> </li> <li>If using the <code>tls</code> module provided, please do the following first:</li> <li>Create a blank pfx file <code>touch ./keys/certificate.pfx</code>.</li> <li>Target apply the TLS module <code>terraform apply -target module.tls</code></li> <li>There is a concurrency issue, this will generate the PFX file format from the created cert.</li> <li>NOTE: Fix for this is in progress, feel free to create your own certs instead of using the provided tls module</li> <li><code>terraform plan</code> and <code>terraform apply</code></li> </ul> <h4 id=potential-issues>Potential Issues<a class=headerlink href=#potential-issues title="Permanent link">&para;</a></h4> <p>One potential issue is the need for TLS certificates that are publicly trusted, these examples use Let's Encrypt (sub-module <code>modules/tls-acme</code>) for such tasks however it does require you own a domain. You can instead use self-signed certificate (also available as a sub-module <code>modules/tls-private</code>), however this will lead to VCS integration challenges for Public SaaS Git Repo's.</p> <h4 id=modules>Modules<a class=headerlink href=#modules title="Permanent link">&para;</a></h4> <p>Examples are just wired up modules from the <code>/modules/</code> directory.</p> <h5 id=tls>tls<a class=headerlink href=#tls title="Permanent link">&para;</a></h5> <p>Helpful modules to generate TLS certificates.</p> <p>Optionally you can bring your own keys.</p> <p>There are two in this repository:</p> <ul> <li>tls-acme</li> <li>Uses Let's Encrypt.</li> <li>You must own a domain and have access to update DNS for the challenge.</li> <li>tls-private</li> <li>Creates a private CA and then generates a cert from that.</li> </ul> <h5 id=networking>networking<a class=headerlink href=#networking title="Permanent link">&para;</a></h5> <p>Creates the needed Azure Networking layer that is needed for the example to run.</p> <p>Resources created:</p> <ul> <li>Azure Virtual Network (Vnet)</li> <li>Azure Subnets</li> <li>Azure Network Security Group (NSG)</li> <li>Associated NSG Rules</li> <li>Bastion (Azure VM)</li> <li>Needed to access underlying TFE Instance.</li> <li>Optional if you can network route by other means (Express Route, etc&hellip;)</li> </ul> <h5 id=external-services>external-services<a class=headerlink href=#external-services title="Permanent link">&para;</a></h5> <p>Creates the external services needed, specifically the database and object storage.</p> <p>Resources created:</p> <ul> <li>Azure Postgres</li> <li>Azure Storage Account</li> </ul> <h5 id=configs>configs<a class=headerlink href=#configs title="Permanent link">&para;</a></h5> <p>Creates the configuration files and startup script needed to install TFE.</p> <p>To enable debugging, by default this module will create files in <code>.terraform/*</code> that have the exact same contents as what will be deployed to the instance.</p> <p>Specifically these files are created:</p> <ul> <li><code>.terraform/replicated-conf.json</code></li> <li>replicated config file</li> <li><code>.terraform/replicated-tfe-conf.json</code></li> <li>TFE config files</li> <li><code>.terraform/startup_script.sh</code></li> <li>startup script to run on VM first boot</li> </ul> <p>One handy trick to quickly develop/change these configs is to run a <code>terraform apply -target module.configs</code> and validate that these files look correct.</p> <p>To configure TLS use this block:</p> <div class=highlight><pre><span></span><code>tls_config = {
  self-signed = false # When true, the replicated config will be &quot;self-signed&quot;, when false it will be &quot;server-path&quot;
  cert        = &quot;FULL CHAIN PEM ENCODED CERT&quot;
  key         = &quot;CERT PRIVATE KEY&quot;
}
</code></pre></div> <p>To configure Airgap (if desired) use this block:</p> <div class=highlight><pre><span></span><code>tfe_airgap = {
  enabled        = true # When true adds airgap bits to startup script
  url            = &quot;URL TO DOWNLOAD AIRGAP BUNDLE&quot;
  replicated_url = &quot;URL TO DOWNLOAD REPLICATED TAR&quot;
}
</code></pre></div> <h5 id=key-vault>key-vault<a class=headerlink href=#key-vault title="Permanent link">&para;</a></h5> <p>Creates an Azure Key Vault and write secrets to it.</p> <p>This is helpful when you wish to keep secrets out of the startup script and rather have the instance pull these during first boot.</p> <p>Resource created:</p> <ul> <li>Azure Key Vault</li> <li>Firewall active to restrict to the subnet the instance is running on</li> </ul> <h5 id=load-balancer>load-balancer<a class=headerlink href=#load-balancer title="Permanent link">&para;</a></h5> <p>Helpful modules to create the load-balancer level.</p> <p>This will vary based on which example you are using.</p> <p>More details are in the "Specific Examples" section</p> <p>There are three in this repository:</p> <ul> <li>public-load-balancer</li> <li>TLS Pass-through</li> <li>Requires public IP</li> <li>public-application-gateway</li> <li>TLS Termination and Pass-through (Cert must be on both AAG and the instance)</li> <li>App Gateway v2</li> <li>private-application-gateway</li> <li>TLS Termination and Pass-through (Cert must be on both AAG and the instance)</li> <li>App Gateway v1</li> </ul> <h5 id=tfe>tfe<a class=headerlink href=#tfe title="Permanent link">&para;</a></h5> <p>Creates the infrastructure to run Terraform Enterprise.</p> <p>Resource created:</p> <ul> <li>Azure VM Scale Set (VMSS)</li> <li>Creates an Managed Service Identity (MSI)</li> <li>Authorizes the VMSS MSI to read secrets from Azure Key Vault</li> </ul> <h3 id=specific-examples>Specific Examples<a class=headerlink href=#specific-examples title="Permanent link">&para;</a></h3> <p>There are several end to end examples to demonstrate a few common scenarios.</p> <p>Each example can be run to go from nothing, to deployed TFE application.</p> <h4 id=public-load-balancer>Public Load Balancer<a class=headerlink href=#public-load-balancer title="Permanent link">&para;</a></h4> <p>The Azure Public Load Balancer is a layer-4 LB and offers the simplest solution Azure has to offer. In this mode you must do TLS pass-through and can not use a Web Application Firewall (WAF), although this is often mitigated with other firewall appliances that sit in front of the Load Balancer.</p> <p><strong>Requirements</strong></p> <ul> <li>TFE License (*.rli)</li> <li>Publicly Trusted TLS [VCS Integration and SSO]</li> <li>Public DNS Entry [VCS Integration and SSO]</li> </ul> <p>For more details view the example <a href=examples/public-load-balancer/ >README</a></p> <h4 id=public-application-gateway>Public Application Gateway<a class=headerlink href=#public-application-gateway title="Permanent link">&para;</a></h4> <p>The Azure Public Application Gateway is a layer-7 LB and offers more features at the cost of complexity (and reliability). In this mode you can do TLS termination, however, you must also serve the same certificate on the backend instances essentially creating a pass-through scenario. You can use a Web Application Firewall (WAF) in this configuration, however we do not at this time have specific configurations for TFE specifically, rather generic OWASP Top 10 type attack vector protections. Overall the Application Gateway typically causes more problems than it solves. In the Public configuration, Application Gateway can utilize version 2 of the PaaS in Azure.</p> <p><strong>Requirements</strong></p> <ul> <li>TFE License (*.rli)</li> <li>Publicly Trusted TLS [VCS Integration and SSO]</li> <li>Public DNS Entry [VCS Integration and SSO]</li> </ul> <p>For more details view the example <a href=examples/public-application-gateway/ >README</a></p> <h4 id=private-application-gateway>Private Application Gateway<a class=headerlink href=#private-application-gateway title="Permanent link">&para;</a></h4> <p>The Azure Private Application Gateway is a layer-7 LB and offers more features at the cost of complexity (and reliability). In this mode you can do TLS termination, however, you must also serve the same certificate on the backend instances essentially creating a pass-through scenario, you must also upload a private CA bundle to the Application Gateway. Overall the Application Gateway typically causes more problems than it solves. In the Private configuration, Application Gateway can utilize <strong>ONLY</strong> version 1 of the PaaS in Azure.</p> <p><strong>Requirements</strong></p> <ul> <li>TFE License (*.rli)</li> </ul> <p>For more details view the example <a href=examples/private-application-gateway/ >README</a></p> <h3 id=azure-highlights--gotchas>Azure Highlights &amp; Gotchas<a class=headerlink href=#azure-highlights--gotchas title="Permanent link">&para;</a></h3> <p>Notes around Azure specifics.</p> <h4 id=virtual-machine-scale-sets>Virtual Machine Scale Sets<a class=headerlink href=#virtual-machine-scale-sets title="Permanent link">&para;</a></h4> <p>The Azure VMSS is used in an attempt to self heal, but also recover from a zonal outage. These should <strong>always</strong> be kept to a scale of 1.</p> <p><strong>Self Healing</strong></p> <p>The goal is for the VMSS to monitor the TFE app health check and re-provision the instance automatically when there is an issue.</p> <p>Instance status can be obtained with the <a href=https://docs.microsoft.com/bs-latn-ba/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-health-extension>VMSS Health Extension</a> and enabled on a VMSS.</p> <p>The extension details can be found on the instance at <code>/var/lib/waagent/Microsoft.ManagedServices.ApplicationHealthLinux-1.0.0</code>.</p> <p>Specifically the <code>status</code> folder will contain logs of status calls to help identify if errors are occurring.</p> <blockquote> <p>Note: In the <code>status</code> folder there will be a file for each version of the extension you have deployed, numbered such as <code>4.status</code>. This file is replaced each time the health check is made, so do not expect new files, instead watch the time stamp. Testing shows this file is updated every 5 seconds.</p> </blockquote> <p>Health check must be on port 80, when using port 443 the health check failed without any good logs (my guess would be a TLS error since it doesn't have SANS entries for the instance IPs).</p> <div class=highlight><pre><span></span><code>{
  &quot;protocol&quot; : &quot;http&quot;,
  &quot;port&quot; : 80,
  &quot;requestPath&quot; : &quot;/_health_check&quot;
}
</code></pre></div> <p>Installing the extension will get you health checks, and you are able to see the status in the VMSS in the Azure portal. However, to turn on Automatic Instance Repair, the extension must be installed first. This presents a chicken/egg situation with Terraform.</p> <ul> <li>VMSS is created first.</li> <li>VMSS extension is added to the VMSS config.</li> <li>Automatic instance repair can now be turned on.</li> </ul> <p>Potential issues:</p> <ul> <li>With the health extension turned on, the threshold for instance action is less than 2 minutes. If the app restarts it will be enough to cause it to re-provision the instance. This is <strong>not</strong> configurable&hellip;</li> <li>Any instance must be alive for at least 30 minutes before action can be taken on it, so if the app fails to start on first boot, it will take 30 minutes before another attempt will be made. 30 mins is the minimum value.</li> <li>How to turn on automatic instance repair with Terraform on a VMSS during creation of the VMSS?</li> </ul> <h4 id=public-azure-load-balancer>Public Azure Load Balancer<a class=headerlink href=#public-azure-load-balancer title="Permanent link">&para;</a></h4> <p>The Public Azure Load Balancer is not capable of doing TLS Termination so you must place the full chain TLS Cert/Key in PEM format on the instance running TFE.</p> <p>Standard Load Balancers are zone redundant by default, no additional configuration needed.</p> <h4 id=private-azure-load-balancer>Private Azure Load Balancer<a class=headerlink href=#private-azure-load-balancer title="Permanent link">&para;</a></h4> <p>For a completely private TFE installation that is not reachable by the internet, the Private Azure Load Balancer will <strong>not</strong> work. Instead you must opt for the Private Application Gateway.</p> <p>This is due to a limitation with the Private Azure Load Balancer's inability to do loopback (i.e. the instance running TFE must be able to resolve to itself, from itself, through the Load Balancer)</p> <h4 id=azure-application-gateway>Azure Application Gateway<a class=headerlink href=#azure-application-gateway title="Permanent link">&para;</a></h4> <p>There are two versions indicated by SKU's such as "Standard" and "Standard_v2".</p> <p>Both versions are rather difficult to work with and lacking consistency found in other cloud providers.</p> <ul> <li>Private Application Gateway - must use v1 ("Standard") SKU's</li> </ul> <h3 id=todo>TODO<a class=headerlink href=#todo title="Permanent link">&para;</a></h3> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> Add RHEL support</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> Add airgap support</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Add WAF examples to the AAG's</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Figure out proper VMSS self healing configuration (i.e. can kill replicated/TFE, and the app will rebuild)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Determine cleaner way to generate a PFX from PEM encoded cert/issuer/keys</li> </ul> <h3 id=known-issues>Known Issues<a class=headerlink href=#known-issues title="Permanent link">&para;</a></h3> <p>Some Known Issues</p> <h4 id=private-azure-application-gateway-unable-to-set-specific-zones>Private Azure Application Gateway unable to set specific Zones<a class=headerlink href=#private-azure-application-gateway-unable-to-set-specific-zones title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code>Error: Error Creating/Updating Application Gateway &quot;tfe-aag-appgateway&quot; (Resource Group &quot;tfe-aag-rg&quot;): network.ApplicationGatewaysClient#CreateOrUpdate: Failure sending request: StatusCode=400 -- Original Error: Code=&quot;SubscriptionNotRegisteredForFeature&quot; Message=&quot;Subscription /subscriptions//resourceGroups//providers/Microsoft.Network/subscriptions/ is not registered for feature AllowApplicationGatewayZonePinning required to carry out the requested operation.&quot; Details=[]
</code></pre></div> <h3 id=tools>Tools<a class=headerlink href=#tools title="Permanent link">&para;</a></h3> <p>Here are a few helpful tools for working with this repository.</p> <h4 id=sshuttle><a href=https://github.com/sshuttle/sshuttle>sshuttle</a><a class=headerlink href=#sshuttle title="Permanent link">&para;</a></h4> <p>Poor man's VPN, allows proxy access through a bastion to get to private network instances.</p> <p><strong>config</strong> <div class=highlight><pre><span></span><code><span class=nv>ssh_ident</span><span class=o>=</span><span class=s2>&quot;./.terraform/id_rsa.pem&quot;</span>
<span class=nv>ssh_username</span><span class=o>=</span><span class=s2>&quot;tfeadmin&quot;</span>
<span class=nv>ssh_bastion</span><span class=o>=</span><span class=s2>&quot;bastion-credible-kitten.centralus.cloudapp.azure.com&quot;</span>
<span class=nv>ssh_cidr</span><span class=o>=</span><span class=s2>&quot;10.0.0.0/24&quot;</span>
<span class=nv>ssh_instance</span><span class=o>=</span><span class=s2>&quot;10.0.0.6&quot;</span>
</code></pre></div></p> <p><strong>bastion</strong> <div class=highlight><pre><span></span><code>ssh-add <span class=nv>$ssh_ident</span> <span class=o>&amp;&amp;</span> sshuttle -r <span class=s2>&quot;</span><span class=si>${</span><span class=nv>ssh_username</span><span class=si>}</span><span class=s2>@</span><span class=si>${</span><span class=nv>ssh_bastion</span><span class=si>}</span><span class=s2>&quot;</span> <span class=nv>$ssh_cidr</span>
</code></pre></div></p> <p><strong>client</strong> <div class=highlight><pre><span></span><code>ssh-add <span class=nv>$ssh_ident</span> <span class=o>&amp;&amp;</span> ssh <span class=s2>&quot;</span><span class=si>${</span><span class=nv>ssh_username</span><span class=si>}</span><span class=s2>@</span><span class=si>${</span><span class=nv>ssh_instance</span><span class=si>}</span><span class=s2>&quot;</span>
</code></pre></div></p> <h4 id=pre-commit-terraform><a href=https://github.com/antonbabenko/pre-commit-terraform>pre-commit-terraform</a><a class=headerlink href=#pre-commit-terraform title="Permanent link">&para;</a></h4> <p>Great utility for keep documentation up to date, also used for formatting and light validation.</p> <div class=highlight><pre><span></span><code>brew install pre-commit terraform-docs
</code></pre></div> <p>Ensure versions are at least: * pre-commit &gt;= 1.20.0 * terraform-docs &gt;= 0.8.2</p> <div class=highlight><pre><span></span><code>brew upgrade pre-commit terraform-docs
</code></pre></div> <p><a href=https://github.com/segmentio/terraform-docs>terraform-docs</a></p> <h4 id=openssl><a href=https://www.openssl.org/ >openssl</a><a class=headerlink href=#openssl title="Permanent link">&para;</a></h4> <p>TLS certificate manipulation.</p> <p><strong>Inspect a PFX for full chain</strong> <div class=highlight><pre><span></span><code>openssl pkcs12 -info -in certificate.pfx
</code></pre></div></p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2022 - Leslie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> with emoji by <a href=https://github.com/twitter/twemoji target=_blank rel=noopener> Twemoji </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.fb4a9340.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.ca5457b8.min.js></script> </body> </html>