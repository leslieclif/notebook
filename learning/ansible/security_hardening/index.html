<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Leslie><link href=https://leslieclif.github.io/notebook/learning/ansible/security_hardening/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-7.0.3"><title>Security Hardening for Applications and Networks - Leslie's Online Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/main.1655a90d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.7fa14f5b.min.css><script src=../../../assets/extra.js type=text/javascript></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/extra.css></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#security-hardening-for-applications-and-networks class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Leslie's Online Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Security Hardening for Applications and Networks </span> </div> </div> </div> <div class=md-header__options> <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon"> <a href=javascript:toggleScheme(); title="Dark mode" class=dark-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg> </a> <a href=javascript:toggleScheme(); title="Light mode" class=light-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg> </a> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> Leslie's Online Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../developer/ class=md-nav__link> Developer Setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> IDE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDE data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> IDE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ide/ class=md-nav__link> IDE Tips and Tricks </a> </li> <li class=md-nav__item> <a href=../../../ide/markdown/ class=md-nav__link> Markdown </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Server <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Server data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../server/ class=md-nav__link> Server Details </a> </li> <li class=md-nav__item> <a href=../../../server/install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../server/mobile/ class=md-nav__link> Mobile </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ansible data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ansible/ class=md-nav__link> Ansible </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../k8s/install/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Learning <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Learning data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../git/ class=md-nav__link> Git </a> </li> <li class=md-nav__item> <a href=../../python/ class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../vagrant/ class=md-nav__link> Vagrant </a> </li> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../docker/docker-notes/ class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=../../k8s/k8s-notes/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../linux/linux/ class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../linux/security/ class=md-nav__link> Linux_Security </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Devops data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/ class=md-nav__link> Index </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#security-hardening-for-applications-and-networks class=md-nav__link> Security Hardening for Applications and Networks </a> </li> <li class=md-nav__item> <a href=#security-hardening-with-benchmarks-such-as-cis-stigs-and-nist class=md-nav__link> Security hardening with benchmarks such as CIS, STIGs, and NIST </a> </li> <li class=md-nav__item> <a href=#operating-system-hardening-for-baseline-using-an-ansible-playbook class=md-nav__link> Operating system hardening for baseline using an Ansible playbook </a> </li> <li class=md-nav__item> <a href=#stigs-ansible-role-for-automated-security-hardening-for-linux-hosts class=md-nav__link> STIGs Ansible role for automated security hardening for Linux hosts </a> </li> <li class=md-nav__item> <a href=#continuous-security-scans-and-reports-for-openscap-using-ansible-tower class=md-nav__link> Continuous security scans and reports for OpenSCAP using Ansible Tower </a> </li> <li class=md-nav__item> <a href=#cis-benchmarks class=md-nav__link> CIS Benchmarks </a> <nav class=md-nav aria-label="CIS Benchmarks"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ubuntu-cis-benchmarks-server-level class=md-nav__link> Ubuntu CIS Benchmarks (server level) </a> </li> <li class=md-nav__item> <a href=#aws-benchmarks-cloud-provider-level class=md-nav__link> AWS benchmarks (cloud provider level) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#automating-security-audit-checks-for-networking-devices-using-ansible class=md-nav__link> Automating security audit checks for networking devices using Ansible </a> <nav class=md-nav aria-label="Automating security audit checks for networking devices using Ansible"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nmap-scanning-and-nse class=md-nav__link> Nmap scanning and NSE </a> </li> <li class=md-nav__item> <a href=#nmap-nse-scanning-playbook class=md-nav__link> Nmap NSE scanning playbook </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#automation-security-audit-checks-for-applications-using-ansible class=md-nav__link> Automation security audit checks for applications using Ansible </a> <nav class=md-nav aria-label="Automation security audit checks for applications using Ansible"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#source-code-analysis-scanners class=md-nav__link> Source code analysis scanners </a> </li> <li class=md-nav__item> <a href=#dependency-checking-scanners class=md-nav__link> Dependency-checking scanners </a> </li> <li class=md-nav__item> <a href=#running-web-application-security-scanners class=md-nav__link> Running web application security scanners </a> </li> <li class=md-nav__item> <a href=#framework-specific-security-scanners class=md-nav__link> Framework-specific security scanners </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#automated-patching-approaches-using-ansible class=md-nav__link> Automated patching approaches using Ansible </a> <nav class=md-nav aria-label="Automated patching approaches using Ansible"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rolling-updates class=md-nav__link> Rolling updates </a> </li> <li class=md-nav__item> <a href=#bluegreen-deployments class=md-nav__link> BlueGreen deployments </a> <nav class=md-nav aria-label="BlueGreen deployments"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bluegreen-deployment-setup-playbook class=md-nav__link> BlueGreen deployment setup playbook </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#continuous-security-scanning-for-docker-containers class=md-nav__link> Continuous Security Scanning for Docker Containers </a> <nav class=md-nav aria-label="Continuous Security Scanning for Docker Containers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understanding-continuous-security-concepts class=md-nav__link> Understanding continuous security concepts </a> </li> <li class=md-nav__item> <a href=#automating-vulnerability-assessments-of-docker-containers-using-ansible class=md-nav__link> Automating vulnerability assessments of Docker containers using Ansible </a> </li> <li class=md-nav__item> <a href=#docker-bench-for-security class=md-nav__link> Docker Bench for Security </a> </li> <li class=md-nav__item> <a href=#clair class=md-nav__link> Clair </a> </li> <li class=md-nav__item> <a href=#scheduled-scans-using-ansible-tower-for-docker-security class=md-nav__link> Scheduled scans using Ansible Tower for Docker security </a> </li> <li class=md-nav__item> <a href=#anchore--open-container-compliance-platform class=md-nav__link> Anchore – open container compliance platform </a> </li> <li class=md-nav__item> <a href=#anchore-engine-service-setup class=md-nav__link> Anchore Engine service setup </a> </li> <li class=md-nav__item> <a href=#anchore-cli-scanner class=md-nav__link> Anchore CLI scanner </a> </li> <li class=md-nav__item> <a href=#scheduled-scans-using-ansible-tower-for-operating-systems-and-kernel-security class=md-nav__link> Scheduled scans using Ansible Tower for operating systems and kernel security </a> </li> <li class=md-nav__item> <a href=#vuls--vulnerability-scanner class=md-nav__link> Vuls – vulnerability scanner </a> </li> <li class=md-nav__item> <a href=#scheduled-scans-for-file-integrity-checks-host-level-monitoring-using-ansible-for-various-compliance-initiatives class=md-nav__link> Scheduled scans for file integrity checks, host-level monitoring using Ansible for various compliance initiatives </a> </li> <li class=md-nav__item> <a href=#osquery class=md-nav__link> osquery </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> Summary </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#automating-lab-setups-for-forensics-collection-and-malware-analysis class=md-nav__link> Automating Lab Setups for Forensics Collection and Malware Analysis </a> <nav class=md-nav aria-label="Automating Lab Setups for Forensics Collection and Malware Analysis"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#virustotal--api-tool-set-up class=md-nav__link> VirusTotal API tool set up </a> </li> <li class=md-nav__item> <a href=#creating-ansible-playbooks-for-collection-and-storage-with-secure-backup-of-forensic-artifacts class=md-nav__link> Creating Ansible playbooks for collection and storage with secure backup of forensic artifacts </a> </li> <li class=md-nav__item> <a href=#collecting-log-artifacts-for-incident-response class=md-nav__link> Collecting log artifacts for incident response </a> </li> <li class=md-nav__item> <a href=#secure-backups-for-data-collection class=md-nav__link> Secure backups for data collection </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Security Hardening for Applications and Networks</h1> <h2 id=security-hardening-for-applications-and-networks>Security Hardening for Applications and Networks<a class=headerlink href=#security-hardening-for-applications-and-networks title="Permanent link">&para;</a></h2> <ul> <li>Security hardening is the most obvious task for any security-conscious endeavor. </li> <li>By doing the effort of securing systems, applications, and networks, one can achieve multiple security goals given as follows:<ul> <li>Ensuring that applications and networks are not compromised (sometimes)</li> <li>Making it difficult for compromises to stay hidden for long</li> <li>Securing by default ensures that compromises in one part of the network don't propagate further and more</li> </ul> </li> <li>We will build playbooks that will allow us to do the following things:<ul> <li>Secure our master images so that as soon as the applications and systems are part of the network, they offer decent security</li> <li>Execute audit processes so that we can verify and measure periodically if the applications, systems, and networks are in line with the security policies that are required by the organization</li> <li>Security hardening with benchmarks such as Center for Internet Security (CIS), Security Technical Implementation Guides (STIG), and National Institute of Standards and Technology (NIST)</li> <li>Automating security audit checks for networking devices using Ansible</li> <li>Automating security audit checks for applications using Ansible</li> <li>Automated patching approaches using Ansible</li> </ul> </li> </ul> <h2 id=security-hardening-with-benchmarks-such-as-cis-stigs-and-nist>Security hardening with benchmarks such as CIS, STIGs, and NIST<a class=headerlink href=#security-hardening-with-benchmarks-such-as-cis-stigs-and-nist title="Permanent link">&para;</a></h2> <ul> <li>Benchmarks provide a great way for anyone to gain assurance of their individual security efforts.</li> <li>Hardening for security mostly boils down to do the following: <ul> <li>Agreeing on what is the minimal set of configuration that qualifies as secure configuration. This is usually defined as a hardening benchmark or framework.</li> <li>Making changes to all the aspects of the system that are touched by such configuration.</li> <li>Measuring periodically if the application and system are still in line with the configuration or if there is any deviation.</li> <li>If any deviation is found, take corrective action to fix that. </li> <li>If no deviation is found, log that.</li> <li>Since software is always getting upgraded, staying on top of the latest configuration guidelines and benchmarks is most important.</li> </ul> </li> </ul> <h2 id=operating-system-hardening-for-baseline-using-an-ansible-playbook>Operating system hardening for baseline using an Ansible playbook<a class=headerlink href=#operating-system-hardening-for-baseline-using-an-ansible-playbook title="Permanent link">&para;</a></h2> <ul> <li>We will see how we can use existing playbooks from the community (Ansible Galaxy).</li> <li>The following playbook provides multiple security configurations, standards, and ways to protect operating system against different attacks and security vulnerabilities.</li> <li>Some of the tasks it will perform include the following:<ul> <li>Configures package management, for example, allows only signed packages</li> <li>Remove packages with known issues</li> <li>Configures pam and pam_limits modules</li> <li>Shadow password suite configuration</li> <li>Configures system path permissions</li> <li>Disable core dumps via soft limits</li> <li>Restrict root logins to system console</li> <li>Set SUIDs</li> <li>Configures kernel parameters via sysctl</li> </ul> </li> <li>Downloading and executing Ansible playbooks from galaxy is as simple as follows: <div class=highlight><pre><span></span><code>ansible-galaxy install dev-sec.os-hardening
</code></pre></div> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">dev-sec.os-hardening</span>
</code></pre></div></li> <li>The preceding playbook will detect the operating system and perform hardening steps based on the different guidelines. This can be configured as required by updating the default variables values. Refer to <a class="magiclink magiclink-github magiclink-repository" href=https://github.com/dev-sec/ansible-os-hardening title="GitHub Repository: dev-sec/ansible-os-hardening">dev-sec/ansible-os-hardening</a> for more details about the playbook.</li> </ul> <h2 id=stigs-ansible-role-for-automated-security-hardening-for-linux-hosts>STIGs Ansible role for automated security hardening for Linux hosts<a class=headerlink href=#stigs-ansible-role-for-automated-security-hardening-for-linux-hosts title="Permanent link">&para;</a></h2> <ul> <li>OpenStack has an awesome project named <a href=https://github.com/openstack/ansible-hardening>ansible-hardening</a>, which applies the security configuration changes as per the STIGs standards.</li> <li>It performs security hardening for the following domains:<ul> <li>accounts: User account security controls</li> <li>aide: Advanced Intrusion Detection Environment</li> <li>auditd: Audit daemon</li> <li>auth: Authentication</li> <li>file_perms: Filesystem permissions</li> <li>graphical: Graphical login security controls</li> <li>kernel: Kernel parameters</li> <li>lsm: Linux Security Modules</li> <li>misc: Miscellaneous security controls</li> <li>packages: Package managers</li> <li>sshd: SSH daemon</li> </ul> </li> <li>Download the role from the GitHub repository itself using ansible-galaxy as follows:<br> <div class=highlight><pre><span></span><code>ansible-galaxy install git+https://github.com/openstack/ansible-hardening
</code></pre></div> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">STIGs ansible-hardening for automated security hardening</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">servers</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>remote_user</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>remote_user_name</span><span class=nv> </span><span class=s>}}&quot;</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>remote_user_name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
    <span class=nt>security_ntp_servers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">time.nist.gov</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">time.google.com</span>

  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ansible-hardening</span>
</code></pre></div></li> </ul> <h2 id=continuous-security-scans-and-reports-for-openscap-using-ansible-tower>Continuous security scans and reports for OpenSCAP using Ansible Tower<a class=headerlink href=#continuous-security-scans-and-reports-for-openscap-using-ansible-tower title="Permanent link">&para;</a></h2> <ul> <li>OpenSCAP is a set of security tools, policies, and standards to perform security compliance checks against the systems by following SCAP. SCAP is the U.S. standard maintained by NIST.</li> <li>OpenSCAP follows these steps to perform scanning on your system:<ul> <li>Install SCAP Workbench or OpenSCAP Base (for more information, visit <a href=https://www.open-scap.org>https://www.open-scap.org</a>)</li> <li>Choose a policy</li> <li>Adjust your settings</li> <li>Evaluate the system </li> </ul> </li> <li>Check playbook reference at <a href=https://medium.com/@jackprice/ansible-openscap-for-compliance-automation-14200fe70663>https://medium.com/@jackprice/ansible-openscap-for-compliance-automation-14200fe70663</a>. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>oscap_profile</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">xccdf_org.ssgproject.content_profile_pci-dss</span>
    <span class=nt>oscap_policy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ssg-rhel7-ds</span>

  <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">install openscap scanner</span>
    <span class=nt>package</span><span class=p>:</span>
      <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
      <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
    <span class=nt>with_items</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">openscap-scanner</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scap-security-guide</span>

  <span class="p p-Indicator">-</span> <span class=nt>block</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">run openscap</span>
      <span class=nt>command</span><span class=p>:</span> <span class="p p-Indicator">&gt;</span>
        <span class=no>oscap xccdf eval</span>
        <span class=no>--profile {{ oscap_profile }}</span>
        <span class=no>--results-arf /tmp/oscap-arf.xml</span>
        <span class=no>--report /tmp/oscap-report.html</span>
        <span class=no>--fetch-remote-resources</span>
        <span class=no>/usr/share/xml/scap/ssg/content/{{ oscap_policy }}.xml</span>

    <span class=nt>always</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">download report</span>
      <span class=nt>fetch</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/oscap-report.html</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">./{{ inventory_hostname }}.html</span>
        <span class=nt>flat</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div></li> <li>We can use this playbook to perform continuously automated checks using Ansible Tower<ul> <li>First, we need to create a directory in Ansible Tower server in order to store this playbook with the awx user permission to add the custom playbook.</li> <li>Create a new project in Ansible Tower to perform the OpenSCAP setup and scan against the checks.</li> <li>Then, we have to create a new job to execute the playbook. Here, we can include the list of hosts, credentials for login, and other details required to perform the execution.</li> <li>This audit can be scheduled to perform frequently. </li> <li>We can also launch this job on demand when required. </li> <li>The output of the playbook will generate the OpenSCAP report, and it will be fetched to Ansible Tower. </li> <li>We can access this playbook at the /tmp/ location. Also, we can send this report to the other centralized reporting server if required.</li> <li>We can also set up notifications based on playbook execution results. By doing this, we can send this notifications to respective channels, such as email, slack, and message.</li> </ul> </li> </ul> <h2 id=cis-benchmarks>CIS Benchmarks<a class=headerlink href=#cis-benchmarks title="Permanent link">&para;</a></h2> <ul> <li>CIS has benchmarks for different type OS, software, and services. The following are some high-level categories:<ul> <li>Desktops and web browsers</li> <li>Mobile devices</li> <li>Network devices</li> <li>Security metrics</li> <li>Servers – operating systems</li> <li>Servers – other</li> <li>Virtualization platforms, cloud, and other</li> </ul> </li> <li></li> </ul> <h3 id=ubuntu-cis-benchmarks-server-level>Ubuntu CIS Benchmarks (server level)<a class=headerlink href=#ubuntu-cis-benchmarks-server-level title="Permanent link">&para;</a></h3> <ul> <li>CIS Benchmarks Ubuntu provides prescriptive guidance to establish a secure configuration posture for Ubuntu Linux systems running on x86 and x64 platforms. </li> <li>This benchmark is intended for system and application administrators, security specialists, auditors, help desk, and platform deployment personnel who plan to develop, deploy, assess, or secure solutions that incorporate Linux platform.</li> <li>Here are the high-level six domains that are part of CIS Ubuntu 16.04 LTS benchmarks:<ul> <li>Initial setup:<ul> <li>Filesystem configuration</li> <li>Configure software updates</li> <li>Filesystem integrity checking</li> <li>Secure boot settings</li> <li>Additional process hardening </li> <li>Mandatory access control</li> <li>Warning banners</li> </ul> </li> <li>Services:<ul> <li>Inted Services</li> <li>Special purpose services</li> <li>Service clients</li> </ul> </li> <li>Network configuration:<ul> <li>Network parameters (host only)</li> <li>Network parameters (host and router)</li> <li>IPv6</li> <li>TCP wrappers</li> <li>Uncommon network protocols</li> </ul> </li> <li>Logging and auditing:<ul> <li>Configure system accounting (auditd)</li> <li>Configure logging</li> </ul> </li> <li>Access, authentication, and authorization:<ul> <li>Configure cron</li> <li>SSH server configuration</li> <li>Configure PAM</li> <li>User accounts and environment</li> </ul> </li> <li>System maintenance:<ul> <li>System file permissions</li> <li>User and group settings <div class=highlight><pre><span></span><code><span class=c1># Playbooks</span>
git clone https://github.com/oguya/cis-ubuntu-14-ansible.git
<span class=nb>cd</span> cis-ubuntu-14-ansible
</code></pre></div></li> </ul> </li> </ul> </li> <li>Then, update the variables and inventory and execute the playbook using the following command. </li> <li>The variables are not required mostly, as this performs against different CIS checks unless, if we wanted to customize the benchmarks as per the organization. <div class=highlight><pre><span></span><code>ansible-playbook -i inventory cis.yml
</code></pre></div></li> <li>The preceding playbook will execute the CIS security benchmark against an Ubuntu server and performs all the checks listed in the CIS guidelines.</li> </ul> <h3 id=aws-benchmarks-cloud-provider-level>AWS benchmarks (cloud provider level)<a class=headerlink href=#aws-benchmarks-cloud-provider-level title="Permanent link">&para;</a></h3> <ul> <li>AWS CIS Benchmarks provides prescriptive guidance to configure security options for a subset of AWS with an emphasis on foundational, testable, and architecture agnostic settings. </li> <li>Here are the high-level domains, which are part of AWS CIS Benchmarks:<ul> <li>Identity and access management</li> <li>Logging</li> <li>Monitoring</li> <li>Networking</li> <li>Extra </li> </ul> </li> <li>Currently, there is a tool named prowler (<a class="magiclink magiclink-github magiclink-repository" href=https://github.com/Alfresco/prowler title="GitHub Repository: Alfresco/prowler">Alfresco/prowler</a>) based on AWS-CLI commands for AWS account security assessment and hardening.</li> <li>Before running the playbook, we have to provide AWS API keys to perform security audit. </li> <li>This can be created using IAM role in AWS service. If you have an already existing account with required privileges, these steps can be skipped.</li> <li>Create a new user in your AWS account with programmatic access.</li> <li>Apply the SecurityAudit policy for the user from existing policies in IAM console.</li> <li>Create the new user by following the steps. Make sure that you safely save the Access key ID and Secret access key for later use.</li> <li>The following playbook assume that you already have installed python and pip in your local system. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">AWS CIS Benchmarks playbook</span>
    <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
    <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class=nt>aws_access_key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">XXXXXXXX</span>
    <span class=nt>aws_secret_key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">XXXXXXXX</span>

    <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing aws cli and ansi2html</span>
        <span class="l l-Scalar l-Scalar-Plain">pip</span><span class="p p-Indicator">:</span>
        <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>

    <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">awscli</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ansi2html</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">downloading and setting up prowler</span>
        <span class="l l-Scalar l-Scalar-Plain">get_url</span><span class="p p-Indicator">:</span>
        <span class=nt>url</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://raw.githubusercontent.com/Alfresco/prowler/master/prowler</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/prowler</span>
        <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0755</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running prowler full scan</span>
        <span class="l l-Scalar l-Scalar-Plain">shell</span><span class="p p-Indicator">:</span> <span class=s>&quot;prowler</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>ansi2html</span><span class=nv> </span><span class=s>-la</span><span class=nv> </span><span class=s>&gt;</span><span class=nv> </span><span class=s>./aws-cis-report-{{</span><span class=nv> </span><span class=s>ansible_date_time.epoch</span><span class=nv> </span><span class=s>}}.html&quot;</span>
        <span class=nt>environment</span><span class=p>:</span>
        <span class=nt>AWS_ACCESS_KEY_ID</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>aws_access_key</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>AWS_SECRET_ACCESS_KEY</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>aws_secret_key</span><span class=nv> </span><span class=s>}}&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">AWS CIS Benchmarks report downloaded</span>
        <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;Report</span><span class=nv> </span><span class=s>can</span><span class=nv> </span><span class=s>be</span><span class=nv> </span><span class=s>found</span><span class=nv> </span><span class=s>at</span><span class=nv> </span><span class=s>./aws-cis-report-{{</span><span class=nv> </span><span class=s>ansible_date_time.epoch</span><span class=nv> </span><span class=s>}}.html&quot;</span>
</code></pre></div></li> <li>The playbook will trigger the setup and security audit scan for AWS CIS Benchmarks using the prowler tool.</li> <li>Prowler-generated HTML report can be downloaded in different formats as required and also scanning checks can be configured as required.</li> <li>More reference about the tool can be found at <a class="magiclink magiclink-github magiclink-repository" href=https://github.com/Alfresco/prowler title="GitHub Repository: Alfresco/prowler">Alfresco/prowler</a>.</li> </ul> <h2 id=automating-security-audit-checks-for-networking-devices-using-ansible>Automating security audit checks for networking devices using Ansible<a class=headerlink href=#automating-security-audit-checks-for-networking-devices-using-ansible title="Permanent link">&para;</a></h2> <ul> <li>We can use this to do security audit checks for networking devices.</li> </ul> <h3 id=nmap-scanning-and-nse>Nmap scanning and NSE<a class=headerlink href=#nmap-scanning-and-nse title="Permanent link">&para;</a></h3> <ul> <li>Network Mapper (Nmap) is a free open source software to perform network discovery, scanning, audit, and many others. It has a various amount of features such as OS detection, system fingerprinting, firewall detection, and many other features. </li> <li>Nmap Scripting Engine (Nmap NSE) provides advanced capabilities like scanning for particular vulnerabilities and attacks. </li> <li>We can also write and extend Nmap using our own custom script. </li> <li>Nmap is a <strong>swiss army knife</strong> for pen testers (security testers) and network security teams. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Basic NMAP Scan Playbook</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>top_ports</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
    <span class=nt>network_hosts</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scanme.nmap.org</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">192.168.11.0/24</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">check if nmap installed and install</span>
      <span class=nt>apt</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">nmap</span>
        <span class=nt>update_cache</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
      <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">top ports scan</span>
      <span class=nt>shell</span><span class=p>:</span> <span class=s>&quot;nmap</span><span class=nv> </span><span class=s>--top-ports</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>top_ports</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-Pn</span><span class=nv> </span><span class=s>-oA</span><span class=nv> </span><span class=s>nmap-scan-%Y-%m-%d</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>network_hosts|join(&#39;</span><span class=nv> </span><span class=s>&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div></li> <li>{{ network_hosts|join(' ') }} is a Jinja2 feature named filter arguments to parse the given network_hosts by space delimited network_hosts variable holds the list of IPs, network range (CIDR), hosts, and so on to perform scan using Nmap</li> <li>top_ports is the number that is ranging from 0 to 65535. Nmap by default picks commonly opened top ports</li> <li>-Pn specifies that scans the host if ping (ICMP) doesn't work also</li> <li>-oA gets the output in all formats, which includes gnmap (greppable format), Nmap, and XML</li> </ul> <h3 id=nmap-nse-scanning-playbook>Nmap NSE scanning playbook<a class=headerlink href=#nmap-nse-scanning-playbook title="Permanent link">&para;</a></h3> <ul> <li>This playbook will perform enumeration of directories used by popular web applications and servers using http-enum and finds options that are supported by an HTTP server using http-methods using Nmap scripts. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Advanced NMAP Scan using NSE</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>ports</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
    <span class=nt>scan_host</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">scanme.nmap.org</span> 

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Running Nmap NSE scan</span>
      <span class=nt>shell</span><span class=p>:</span> <span class=s>&quot;nmap</span><span class=nv> </span><span class=s>-Pn</span><span class=nv> </span><span class=s>-p</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>ports|join(&#39;,&#39;)</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>--script</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-oA</span><span class=nv> </span><span class=s>nmap-{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}-results-%Y-%m-%d</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>scan_host</span><span class=nv> </span><span class=s>}}&quot;</span>

      <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http-methods</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http-enum</span>
</code></pre></div></li> <li>The http-enum script runs additional tests against network ports where web servers are detected. </li> <li>We can see that two folders were discovered by the script and additionally all HTTP methods that are supported got enumerated as well. </li> </ul> <h2 id=automation-security-audit-checks-for-applications-using-ansible>Automation security audit checks for applications using Ansible<a class=headerlink href=#automation-security-audit-checks-for-applications-using-ansible title="Permanent link">&para;</a></h2> <ul> <li>Modern applications can get pretty complex fairly quickly. </li> <li>Having the ability to run automation to do security tasks is almost a mandatory requirement. </li> <li>The different types of application security scanning we can do can range from the following:<ul> <li>Run CI/CD scanning against the source code (for example, RIPS and brakeman).</li> <li>Dependency checking scanners (for example, OWASP dependency checker and snyk.io (<a href=https://snyk.io/ >https://snyk.io/</a>)).</li> <li>Once deployed then run the web application scanner (for example, Nikto, Arachni, and w3af).</li> <li>Framework-specific security scanners (for example, WPScan and Droopscan) and many other.</li> </ul> </li> </ul> <h3 id=source-code-analysis-scanners>Source code analysis scanners<a class=headerlink href=#source-code-analysis-scanners title="Permanent link">&para;</a></h3> <ul> <li>This is one of the first and common way to minimize the security risk while applications going to production. </li> <li>Source code analysis scanner also known as <strong>Static Application Security Testing (SAST)</strong> will help to find security issues by analyzing the source code of the application. </li> <li>Source code analysis is kind of white box testing and looking through code. </li> <li>This kind of testing methodology may not find 100% coverage of security vulnerabilities, and it requires manual testing as well. </li> <li>For example, finding logical vulnerabilities requires some kind of user interactions such as dynamic functionalities.</li> <li>For example, if you are scanning PHP code, then <a href=http://rips-scanner.sourceforge.net/ >RIPS</a>; if it's Ruby on Rails code, then it's <a href=https://brakemanscanner.org/ >Brakeman</a>; and if it's python, then <a href=https://wiki.openstack.org/wiki/Security/Projects/Bandit>Bandit</a></li> </ul> <h3 id=dependency-checking-scanners>Dependency-checking scanners<a class=headerlink href=#dependency-checking-scanners title="Permanent link">&para;</a></h3> <ul> <li>Most of the developers use third-party libraries while developing applications, and it's very common to see using open source plugins and modules inside their code.</li> <li>So dependency checks will allow us to find using components with known vulnerabilities (OWASP A9) issues in application code by scanning the libraries against the CVE and NIST vulnerability database.</li> <li>There are multiple projects out there in the market for performing these checks, and some of them includes the following:<ul> <li>OWASP Dependency-Check</li> <li>Snyk.io (<a href=https://snyk.io/ >https://snyk.io/</a>)</li> <li>Retire.js</li> <li>[:] SourceClear and many other</li> </ul> </li> </ul> <h3 id=running-web-application-security-scanners>Running web application security scanners<a class=headerlink href=#running-web-application-security-scanners title="Permanent link">&para;</a></h3> <ul> <li>This is the phase where the application went live to QA, stage, (or) Production. </li> <li>Then, we wanted to perform security scans like an attacker (black box view). </li> <li>At this stage, an application will have all the dynamic functionalities and server configurations applied.</li> <li>These scanner results tell us how good the server configured and any other application security issues before releasing the replica copy into the production.</li> <li>There are many tools in the market to do these jobs for you in both open source and commercial world.<ul> <li>Nikto</li> <li>Arachni</li> <li>w3af</li> <li>Acunetix</li> </ul> </li> </ul> <h3 id=framework-specific-security-scanners>Framework-specific security scanners<a class=headerlink href=#framework-specific-security-scanners title="Permanent link">&para;</a></h3> <ul> <li>This kind of check and scanning is to perform against specific to framework, CMS, and platforms. </li> <li>It allows to get more detailed results by validating against multiple security test cases and checks. <ul> <li>Scanning against WordPress CMS using <a href=https://github.com/wpscanteam/wpscan>WPScan</a></li> <li>Scanning against JavaScript libraries using <a href=https://retirejs.github.io/retire.js>Retire.js</a></li> <li>Scanning against Drupal CMS using <a href=https://github.com/droope/droopescan>Droopescan</a></li> </ul> </li> </ul> <h2 id=automated-patching-approaches-using-ansible>Automated patching approaches using Ansible<a class=headerlink href=#automated-patching-approaches-using-ansible title="Permanent link">&para;</a></h2> <ul> <li>Patching and updating is a task that everyone who has to manage production systems has to deal with. </li> <li>There are two approaches that we will look are as follows:<ul> <li>Rolling updates</li> <li>BlueGreen deployments</li> </ul> </li> </ul> <h3 id=rolling-updates>Rolling updates<a class=headerlink href=#rolling-updates title="Permanent link">&para;</a></h3> <ul> <li>Imagine that we have five web servers behind a load balancer. </li> <li>What we would like to do is a zero downtime upgrade of our web application. </li> <li>We want to achieve the following: <ul> <li>Tell the load balancer that web server node is down</li> <li>Bring down the web server on that node</li> <li>Copy the updated application files to that node</li> <li>Bring up the web server on that node</li> </ul> </li> <li>The first keyword for us to look at is serial. </li> <li>This ensures that the execution of the playbook is done serially rather than in parallel. </li> <li>We can choose to provide a percentage value or numeric value to serial.</li> <li>A great example for this way of doing updates is given in the following link <a href=https://sysadmincasts.com/episodes/47-zero-downtime-deployments-with-ansible-part-4-4>Episode #47 - Zero-downtime Deployments with Ansible</a></li> </ul> <h3 id=bluegreen-deployments>BlueGreen deployments<a class=headerlink href=#bluegreen-deployments title="Permanent link">&para;</a></h3> <ul> <li>The concept of BlueGreen is attributed to <a href=http://martinfowler.com/bliki/BlueGreenDeployment.html>Martin Fowler</a>.</li> <li>The idea is to consider our current live production workload as blue. Now what we want to do is upgrade the application. So a replica of blue is brought up behind the same load balancer. The replica of the infrastructure has the updated application.</li> <li>Once it is up and running, the load balancer configuration is switched from current blue to point to green. Blue keeps running in case there are any operational issues. Once we are happy with the progress, we can tear down the older host. </li> </ul> <h4 id=bluegreen-deployment-setup-playbook>BlueGreen deployment setup playbook<a class=headerlink href=#bluegreen-deployment-setup-playbook title="Permanent link">&para;</a></h4> <ul> <li>The following playbook will set up three nodes, which includes load balancer and two web server nodes. <ul> <li>The first playbook brings up three hosts. Two web servers running nginx behind a load balancer</li> <li>The second playbook switches what is live (blue) to green <div class=highlight><pre><span></span><code><span class=c1># inventory.yml</span>
<span class="p p-Indicator">[</span><span class=nv>proxyserver</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">proxy ansible_host=192.168.100.100 ansible_user=ubuntu ansible_password=passwordgoeshere</span>

<span class="l l-Scalar l-Scalar-Plain">[blue]</span>
<span class="l l-Scalar l-Scalar-Plain">blueserver ansible_host=192.168.100.10 ansible_user=ubuntu ansible_password=passwordgoeshere</span>

<span class="l l-Scalar l-Scalar-Plain">[green]</span>
<span class="l l-Scalar l-Scalar-Plain">greenserver ansible_host=192.168.100.20 ansible_user=ubuntu ansible_password=passwordgoeshere</span>

<span class="l l-Scalar l-Scalar-Plain">[webservers:children]</span>
<span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="l l-Scalar l-Scalar-Plain">green</span>

<span class="l l-Scalar l-Scalar-Plain">[prod:children]</span>
<span class="l l-Scalar l-Scalar-Plain">webservers</span>
<span class="l l-Scalar l-Scalar-Plain">proxyserver</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># main.yml</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running common role</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">prod</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>serial</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">100%</span>
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">common</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running haproxy role</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">proxyserver</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span> 
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">haproxy</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running webserver role</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span> 
  <span class=nt>serial</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">100%</span> 
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating blue code</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">blue</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span> 
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bluecode</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating green code</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">green</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span> 
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">greencode</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># common role</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing python if not installed</span>
  <span class=nt>raw</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test -e /usr/bin/python || (apt -y update &amp;&amp; apt install -y python-minimal)</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating and installing git, curl</span>
  <span class=nt>apt</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class=nt>update_cache</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  
  <span class=nt>with_items</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl</span>

<span class=c1># Also we can include common any monitoring and security hardening tasks</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># haproxy role</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">adding haproxy repo</span>
  <span class=nt>apt_repository</span><span class=p>:</span>
    <span class=nt>repo</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ppa:vbernat/haproxy-1.7</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating and installing haproxy</span>
  <span class=nt>apt</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">haproxy</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class=nt>update_cache</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating the haproxy configuration</span>
  <span class=nt>template</span><span class=p>:</span>
    <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">haproxy.cfg.j2</span>
    <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/haproxy/haproxy.cfg</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">starting the haproxy service</span>
  <span class=nt>service</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">haproxy</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># haproxy.cfg.j2</span>
<span class="l l-Scalar l-Scalar-Plain">global</span>
  <span class="l l-Scalar l-Scalar-Plain">log /dev/log local0</span>
  <span class="l l-Scalar l-Scalar-Plain">log /dev/log local1 notice</span>
  <span class="l l-Scalar l-Scalar-Plain">chroot /var/lib/haproxy</span>
  <span class="l l-Scalar l-Scalar-Plain">stats socket /run/haproxy/admin.sock mode 660 level admin</span>
  <span class="l l-Scalar l-Scalar-Plain">stats timeout 30s</span>
  <span class="l l-Scalar l-Scalar-Plain">user haproxy</span>
  <span class="l l-Scalar l-Scalar-Plain">group haproxy</span>
  <span class="l l-Scalar l-Scalar-Plain">daemon</span>

  <span class="l l-Scalar l-Scalar-Plain"># Default SSL material locations</span>
  <span class="l l-Scalar l-Scalar-Plain">ca-base /etc/ssl/certs</span>
  <span class="l l-Scalar l-Scalar-Plain">crt-base /etc/ssl/private</span>

  <span class="l l-Scalar l-Scalar-Plain"># Default ciphers to use on SSL-enabled listening sockets.</span>
  <span class="l l-Scalar l-Scalar-Plain"># For more information, see ciphers(1SSL). This list is from</span><span class="p p-Indicator">:</span>
  <span class=c1># https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</span>
  <span class=c1># An alternative list with additional directives can be obtained from</span>
  <span class=c1># https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy</span>
  <span class="l l-Scalar l-Scalar-Plain">ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS</span>
  <span class="l l-Scalar l-Scalar-Plain">ssl-default-bind-options no-sslv3</span>

<span class="l l-Scalar l-Scalar-Plain">defaults</span>
  <span class="l l-Scalar l-Scalar-Plain">log global</span>
  <span class="l l-Scalar l-Scalar-Plain">mode http</span>
  <span class="l l-Scalar l-Scalar-Plain">option httplog</span>
  <span class="l l-Scalar l-Scalar-Plain">option dontlognull</span>
        <span class="l l-Scalar l-Scalar-Plain">timeout connect 5000</span>
        <span class="l l-Scalar l-Scalar-Plain">timeout client 50000</span>
        <span class="l l-Scalar l-Scalar-Plain">timeout server 50000</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 400 /etc/haproxy/errors/400.http</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 403 /etc/haproxy/errors/403.http</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 408 /etc/haproxy/errors/408.http</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 500 /etc/haproxy/errors/500.http</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 502 /etc/haproxy/errors/502.http</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 503 /etc/haproxy/errors/503.http</span>
  <span class="l l-Scalar l-Scalar-Plain">errorfile 504 /etc/haproxy/errors/504.http</span>

<span class="l l-Scalar l-Scalar-Plain">frontend http_front</span>
   <span class="l l-Scalar l-Scalar-Plain">bind *:80</span>
   <span class="l l-Scalar l-Scalar-Plain">stats uri /haproxy?stats</span>
   <span class="l l-Scalar l-Scalar-Plain">default_backend http_back</span>

<span class="l l-Scalar l-Scalar-Plain">backend http_back</span>
   <span class="l l-Scalar l-Scalar-Plain">balance roundrobin</span>
   <span class="l l-Scalar l-Scalar-Plain">server {{ hostvars.blueserver.ansible_host }} {{ hostvars.blueserver.ansible_host }}:80 check</span>
   <span class="l l-Scalar l-Scalar-Plain">#server {{ hostvars.greenserver.ansible_host }} {{ hostvars.greenserver.ansible_host }}:80 check</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># nginx role</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing nginx</span>
  <span class=nt>apt</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class=nt>update_cache</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">starting the nginx service</span>
  <span class=nt>service</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># Code snipet for blue</span>
<span class="l l-Scalar l-Scalar-Plain">&lt;html&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">&lt;body bgcolor=&quot;blue&quot;&gt;</span>
       <span class="l l-Scalar l-Scalar-Plain">&lt;h1 align=&quot;center&quot;&gt;Welcome to Blue Deployment&lt;/h1&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">&lt;/body&gt;</span>
<span class="l l-Scalar l-Scalar-Plain">&lt;/html&gt;</span>

<span class="l l-Scalar l-Scalar-Plain"># Code snipet for green</span>
<span class="l l-Scalar l-Scalar-Plain">&lt;html&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">&lt;body bgcolor=&quot;green&quot;&gt;</span>
        <span class="l l-Scalar l-Scalar-Plain">&lt;h1 align=&quot;center&quot;&gt;Welcome to Green Deployment&lt;/h1&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">&lt;/body&gt;</span>
<span class="l l-Scalar l-Scalar-Plain">&lt;/html&gt;</span>
</code></pre></div></li> </ul> </li> <li>We want to deploy the new version of production site with green deployment.</li> <li>The playbook looks very simple as follows, it will update the configuration and reloads the haproxy service to serve the new production deployment. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Updating to GREEN deployment</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">proxyserver</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span> 
  
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating proxy configuration</span>
      <span class=nt>template</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">haproxy.cfg.j2</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/haproxy/haproxy.cfg</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">updating the service</span>
      <span class=nt>service</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">haproxy</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">reloaded</span>

    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;GREEN</span><span class=nv> </span><span class=s>deployment</span><span class=nv> </span><span class=s>successful.</span><span class=nv> </span><span class=s>Please</span><span class=nv> </span><span class=s>check</span><span class=nv> </span><span class=s>your</span><span class=nv> </span><span class=s>server</span><span class=nv> </span><span class=s>:)&quot;</span>
</code></pre></div></li> </ul> <h2 id=continuous-security-scanning-for-docker-containers>Continuous Security Scanning for Docker Containers<a class=headerlink href=#continuous-security-scanning-for-docker-containers title="Permanent link">&para;</a></h2> <ul> <li>Docker containers are the new way developers package applications. </li> <li>The best feature of containers is the fact that they contain the code, runtime, system libraries, and all the settings that are required for the application to work. </li> <li>Due to the ease of use and deployment, more and more applications are getting deployed in containers for production use. </li> <li>With so many moving parts, it becomes imperative that we have the capability to continuously scan Docker containers for security issues.</li> </ul> <h3 id=understanding-continuous-security-concepts>Understanding continuous security concepts<a class=headerlink href=#understanding-continuous-security-concepts title="Permanent link">&para;</a></h3> <ul> <li>One of the key approaches to emerge out of DevOps is the idea of immutable infrastructure. </li> <li>It means that every time there needs to be a <strong>runtime change</strong>, either in application code or configuration, the containers are built and deployed again and the existing running ones are torn down. </li> <li>Since that allows for predictability, resilience, and simplifies deployment choices at runtime, it is no surprise that many operations teams are moving toward it. </li> <li>With that comes the question of when these containers should be tested for security and compliance. </li> <li>By embracing the process of continuous security scanning and monitoring, you can automate for a variety of workloads and workflows. </li> </ul> <h3 id=automating-vulnerability-assessments-of-docker-containers-using-ansible>Automating vulnerability assessments of Docker containers using Ansible<a class=headerlink href=#automating-vulnerability-assessments-of-docker-containers-using-ansible title="Permanent link">&para;</a></h3> <ul> <li><strong>Tool: Description</strong></li> <li>There are many different ways of evaluating the security of containers. </li> <li>Docker Bench: A security shell script to perform checks based on CIS</li> <li>Clair: A tool to perform vulnerability analysis based on the CVE database</li> <li>Anchore: A tool to perform security evaluation and make runtime policy decisions</li> <li>vuls: An agent-less vulnerability scanner with CVE, OVAL database</li> <li>osquery: OS instrumentation framework for OS analytics to do HIDS-type activities</li> </ul> <h3 id=docker-bench-for-security>Docker Bench for Security<a class=headerlink href=#docker-bench-for-security title="Permanent link">&para;</a></h3> <ul> <li>Docker Bench for Security is a shell script to perform multiple checks against the Docker container environment. </li> <li>It will give a more detailed view of the security configuration based on CIS benchmarks. </li> <li>This script supports most of the Unix operating systems as it was built based on the POSIX 2004 compliant.</li> <li>The following are the high-level areas of checks this script will perform:<ul> <li>Host configuration</li> <li>Docker daemon configuration and files</li> <li>Docker container images</li> <li>Docker runtime</li> <li>Docker security operations</li> <li>Docker swarm configuration <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Docker bench security playbook</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>
  <span class=nt>remote_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">make sure git installed</span>
      <span class=nt>apt</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">download the docker bench security</span>
      <span class=nt>git</span><span class=p>:</span>
        <span class=nt>repo</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/docker/docker-bench-security.git</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/opt/docker-bench-security</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running docker-bench-security scan</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">docker-bench-security.sh -l /tmp/output.log</span>
      <span class=nt>args</span><span class=p>:</span>
        <span class=nt>chdir</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/opt/docker-bench-security/</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">downloading report locally</span>
      <span class=nt>fetch</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/output.log</span>
        <span class=nt>dest</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>playbook_dir</span><span class=nv> </span><span class=s>}}/{{</span><span class=nv> </span><span class=s>inventory_hostname</span><span class=nv> </span><span class=s>}}-docker-report-{{</span><span class=nv> </span><span class=s>ansible_date_time.date</span><span class=nv> </span><span class=s>}}.log&quot;</span>
        <span class=nt>flat</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">report location</span>
      <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;Report</span><span class=nv> </span><span class=s>can</span><span class=nv> </span><span class=s>be</span><span class=nv> </span><span class=s>found</span><span class=nv> </span><span class=s>at</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>playbook_dir</span><span class=nv> </span><span class=s>}}/{{</span><span class=nv> </span><span class=s>inventory_hostname</span><span class=nv> </span><span class=s>}}-docker-report-{{</span><span class=nv> </span><span class=s>ansible_date_time.date</span><span class=nv> </span><span class=s>}}.log&quot;</span><span class="l l-Scalar l-Scalar-Plain">&lt;/mark&gt;</span>
</code></pre></div></li> </ul> </li> <li>The output of the playbook will download and scan the containers based on the CIS benchmark and store the results in a log file</li> </ul> <h3 id=clair>Clair<a class=headerlink href=#clair title="Permanent link">&para;</a></h3> <ul> <li>Clair allows us to perform static vulnerability analysis against containers by checking with the existing vulnerability database. </li> <li>It allows us to perform vulnerability analysis checks against our Docker container images using the Clair database. </li> <li>Setting up Clair itself is really difficult and scanning using the API with Docker images makes more difficult. </li> <li>Here comes <a href=https://github.com/arminc/clair-scanner>clair-scanner</a>, it makes really simple to set up and perform scans using the REST API.</li> <li>Clair-scanner can trigger a simple scan against a container based on certain events, to check for existing vulnerabilities. </li> <li>Furthermore, this report can be forwarded to perform the team responsible for fixes and so on. <div class=highlight><pre><span></span><code><span class=c1># It assumes that the target system has Docker and the required libraries installed</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Clair Scanner Server Setup</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>
  <span class=nt>remote_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">setting up clair-db</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">clair_db</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">arminc/clair-db</span>
        <span class=nt>exposed_ports</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5432</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">setting up clair-local-scan</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">clair</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">arminc/clair-local-scan:v2.0.1</span>
        <span class=nt>ports</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;6060:6060&quot;</span>
        <span class=nt>links</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;clair_db:postgres&quot;</span>
<span class=c1># Setting up clair-scanner with Docker containers using Ansible</span>
<span class=c1># It will take a while to download and setup the CVE database after playbook execution.</span>
</code></pre></div></li> <li>This playbook will be used to run clair-scanner to perform an analysis on the containers by making an API request to the server. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Scanning containers using clair-scanner</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>
  <span class=nt>remote_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>image_to_scan</span><span class=p>:</span> <span class=s>&quot;debian:sid&quot;</span>   <span class=c1># container to scan for vulnerabilities</span>
    <span class=nt>clair_server</span><span class=p>:</span> <span class=s>&quot;http://192.168.1.10:6060&quot;</span>    <span class=c1># clair server api endpoint</span>
  
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">downloading and setting up clair-scanner binary</span>
      <span class=nt>get_url</span><span class=p>:</span>
        <span class=nt>url</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/arminc/clair-scanner/releases/download/v6/clair-scanner_linux_amd64</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/clair-scanner</span>
        <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0755</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">scanning {{ image_to_scan }} container for vulnerabilities</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">clair-scanner -r /tmp/{{ image_to_scan }}-scan-report.json -c {{ clair_server }} --ip 0.0.0.0 {{ image_to_scan }}</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">scan_output</span>
      <span class=nt>ignore_errors</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">downloading the report locally</span>
      <span class=nt>fetch</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/{{ image_to_scan }}-scan-report.json</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="p p-Indicator">{{</span> <span class=nv>playbook_dir</span> <span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">/{{ image_to_scan }}-scan-report.json</span>
        <span class=nt>flat</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div></li> </ul> <h3 id=scheduled-scans-using-ansible-tower-for-docker-security>Scheduled scans using Ansible Tower for Docker security<a class=headerlink href=#scheduled-scans-using-ansible-tower-for-docker-security title="Permanent link">&para;</a></h3> <ul> <li>Continuous security processes are all about the <strong>loop of planning, doing, measuring, and acting</strong></li> <li>By following standard checklists and benchmarks and using Ansible to execute them on containers, we can check for security issues and act on them. </li> </ul> <h3 id=anchore--open-container-compliance-platform>Anchore – open container compliance platform<a class=headerlink href=#anchore--open-container-compliance-platform title="Permanent link">&para;</a></h3> <ul> <li>Anchore is one of the most popular tools and services to perform analysis, inspection, and certification of container images. </li> <li>Anchore is an analysis and inspection platform for containers.</li> <li>It provides multiple services and platforms to set up, the most stable and powerful way is to set up the local service using Anchore Engine, which can be accessed via the REST API.</li> <li>High level operations Anchore can perform:<ul> <li>Policy evaluation operations</li> <li>Image operations</li> <li>Policy operations</li> <li>Registry operations</li> <li>Subscription operations</li> <li>System operations</li> </ul> </li> </ul> <h3 id=anchore-engine-service-setup>Anchore Engine service setup<a class=headerlink href=#anchore-engine-service-setup title="Permanent link">&para;</a></h3> <ul> <li>This playbook will set up the Anchore Engine service, which contains the engine container as well as the postgres to store database information. </li> <li>The admin_password variable is the admin user password to access the REST API of Anchore. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore server setup</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>db_password</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">changeme</span>
    <span class=nt>admin_password</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">secretpassword</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">creating volumes</span>
      <span class=nt>file</span><span class=p>:</span>
        <span class=nt>path</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>recurse</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">directory</span>
      
      <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/root/aevolume/db</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/root/aevolume/config</span>
      
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">copying anchore-engine configuration</span>
      <span class=nt>template</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">config.yaml.j2</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/root/aevolume/config/config.yaml</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">starting anchore-db container</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore-db</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:9</span>
        <span class=nt>volumes</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/aevolume/db/:/var/lib/postgresql/data/pgdata/&quot;</span>
        <span class=nt>env</span><span class=p>:</span>
          <span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>db_password</span><span class=nv> </span><span class=s>}}&quot;</span>
          <span class=nt>PGDATA</span><span class=p>:</span> <span class=s>&quot;/var/lib/postgresql/data/pgdata/&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">starting anchore-engine container</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore-engine</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore/anchore-engine</span>
        <span class=nt>ports</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8228:8228</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8338:8338</span>
        <span class=nt>volumes</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/aevolume/config/config.yaml:/config/config.yaml:ro&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span>
        <span class=nt>links</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">anchore-db:anchore-db</span>
</code></pre></div></li> </ul> <h3 id=anchore-cli-scanner>Anchore CLI scanner<a class=headerlink href=#anchore-cli-scanner title="Permanent link">&para;</a></h3> <ul> <li>Now that we have the Anchore Engine service REST API with access details, we can use this to perform the scanning of container images in any host. </li> <li>The following steps are the Ansible Tower setup to perform continuous scanning of container images for vulnerabilities. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore-cli scan</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">anchore</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>scan_image_name</span><span class=p>:</span> <span class=s>&quot;docker.io/library/ubuntu:latest&quot;</span>
    <span class=nt>anchore_vars</span><span class=p>:</span>
      <span class=nt>ANCHORE_CLI_URL</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http://localhost:8228/v1</span>
      <span class=nt>ANCHORE_CLI_USER</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
      <span class=nt>ANCHORE_CLI_PASS</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">secretpassword</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing anchore-cli</span>
      <span class=nt>pip</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>

      <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">anchorecli</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pyyaml</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">downloading image</span>
      <span class=nt>docker_image</span><span class=p>:</span> 
        <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>scan_image_name</span><span class=nv> </span><span class=s>}}&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">adding image for analysis</span>
      <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;anchore-cli</span><span class=nv> </span><span class=s>image</span><span class=nv> </span><span class=s>add</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>scan_image_name</span><span class=nv> </span><span class=s>}}&quot;</span>
      <span class=nt>environment</span><span class=p>:</span> <span class=s>&quot;{{anchore_vars}}&quot;</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">wait for analysis to compelte</span>
      <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;anchore-cli</span><span class=nv> </span><span class=s>image</span><span class=nv> </span><span class=s>content</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>scan_image_name</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>os&quot;</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">analysis</span>
      <span class=nt>until</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">analysis.rc != 1</span>
      <span class=nt>retries</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class=nt>delay</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class=nt>ignore_errors</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class=nt>environment</span><span class=p>:</span> <span class=s>&quot;{{anchore_vars}}&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vulnerabilities results</span>
      <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;anchore-cli</span><span class=nv> </span><span class=s>image</span><span class=nv> </span><span class=s>vuln</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>scan_image_name</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>os&quot;</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuln_output</span>
      <span class=nt>environment</span><span class=p>:</span> <span class=s>&quot;{{anchore_vars}}&quot;</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;vulnerabilities</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>scan_image_name</span><span class=nv> </span><span class=s>}}&quot;</span>
      <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuln_output.stdout_lines</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div></li> </ul> <h3 id=scheduled-scans-using-ansible-tower-for-operating-systems-and-kernel-security>Scheduled scans using Ansible Tower for operating systems and kernel security<a class=headerlink href=#scheduled-scans-using-ansible-tower-for-operating-systems-and-kernel-security title="Permanent link">&para;</a></h3> <ul> <li>While most of the discussed tools can be used for scanning and maintaining a benchmark for security, we should think about the entire process of the incident response and threat detection workflow:<ul> <li>Preparation</li> <li>Detection and analysis</li> <li>Containment, eradication, and recovery</li> <li>Post-incident activity</li> </ul> </li> <li>Setting up all such scanners is our preparation. </li> <li>Using the output of these scanners gives us the ability to detect and analyze. </li> <li>Both containment and recovery are beyond the scope of such tools. </li> <li>For the process of recovery and post-incident activity, you may want to consider playbooks that can trash the current infrastructure and recreate it as it is. </li> <li>As part of our preparation, it may be useful to get familiar with the following terms as you will see them being used repeatedly in the world of vulnerability scanners and vulnerability management tools:</li> <li><strong>Term: Full form (if any): Description of the term</strong></li> <li>CVE: Common Vulnerabilities and Exposures: It is a list of cybersecurity vulnerability identifiers. Usage typically includes CVE IDs.</li> <li>OVAL: Open Vulnerability and Assessment Language: A language for finding out and naming vulnerabilities and configuration issues in computer systems.</li> <li>CWE: Common Weakness Enumeration: A common list of software security weaknesses.</li> <li>NVD: National Vulnerability Database: A US government vulnerability management database available for public use in XML format.</li> </ul> <h3 id=vuls--vulnerability-scanner>Vuls – vulnerability scanner<a class=headerlink href=#vuls--vulnerability-scanner title="Permanent link">&para;</a></h3> <ul> <li>Vuls is an agent-less scanner written in golang. </li> <li>It supports a different variety of Linux operating systems.</li> <li>It performs the complete end-to-end security system administrative tasks such as scanning for security vulnerabilities and security software updates. </li> <li>It analyzes the system for required security vulnerabilities, performs security risk analysis based on the CVE score, sends notifications via Slack and email, and also provides a simple web report with historical data.</li> <li>The playbook has mainly two roles for setting up vuls using Docker containers.<ul> <li>vuls_containers_download</li> <li>vuls_database_download <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">setting up vuls using docker containers</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vuls_containers_download</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vuls_database_download</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># Pulling the Docker containers locally using the docker_image module:</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">pulling containers locally</span>
  <span class=nt>docker_image</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
    <span class=nt>pull</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  
  <span class=nt>with_items</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vuls/go-cve-dictionary</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vuls/goval-dictionary</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vuls/vuls</span>

<span class=c1># Then downloading the CVE and OVAL databases for the required operating systems and distributions versions</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fetching NVD database locally</span>
  <span class=nt>docker_container</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;cve-{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
    <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/go-cve-dictionary</span>
    <span class=nt>auto_remove</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fetchnvd -years &quot;{{ item }}&quot;</span>
    <span class=nt>volumes</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}/go-cve-dictionary-log:/var/log/vuls&quot;</span>
  <span class=nt>with_sequence</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">start=2002 end=&quot;{{ nvd_database_years }}&quot;</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fetching redhat oval data</span>
  <span class=nt>docker_container</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;redhat-oval-{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
    <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/goval-dictionary</span>
    <span class=nt>auto_remove</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fetch-redhat &quot;{{ item }}&quot;</span>
    <span class=nt>volumes</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}/goval-dictionary-log:/var/log/vuls&quot;</span>
  <span class=nt>with_items</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>redhat_oval_versions</span><span class=nv> </span><span class=s>}}&quot;</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fetching ubuntu oval data</span>
  <span class=nt>docker_container</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;ubuntu-oval-{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
    <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/goval-dictionary</span>
    <span class=nt>auto_remove</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;fetch-ubuntu</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
    <span class=nt>volumes</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}/goval-dictionary-log:/var/log/vuls&quot;</span>
  <span class=nt>with_items</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>ubuntu_oval_versions</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div></li> </ul> </li> <li>The global variables file looks as follows. We can add more redhat_oval_versions, such as 5. The nvd_database_years will download the CVE database up until the end of 2017: <div class=highlight><pre><span></span><code><span class=nt>vuls_data_directory</span><span class=p>:</span> <span class=s>&quot;/vuls_data&quot;</span>
<span class=nt>nvd_database_years</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2017</span>
<span class=nt>redhat_oval_versions</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">6</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">7</span>
<span class=nt>ubuntu_oval_versions</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">12</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">16</span>
</code></pre></div></li> <li>Now, it's time to perform the scanning and reporting using the vuls Docker containers. </li> <li>The following playbook contains simple steps to perform the vuls scan against virtual machines and containers, and send the report to slack and web: <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">scanning and reporting using vuls</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>vuls_data_directory</span><span class=p>:</span> <span class=s>&quot;/vuls_data&quot;</span>
    <span class=nt>slack_web_hook_url</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://hooks.slack.com/services/XXXXXXX/XXXXXXXXXXXXXXXXXXXXX</span>
    <span class=nt>slack_channel</span><span class=p>:</span> <span class=s>&quot;#vuls&quot;</span>
    <span class=nt>slack_emoji</span><span class=p>:</span> <span class=s>&quot;:ghost:&quot;</span>
    <span class=nt>server_to_scan</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.33.80</span>
    <span class=nt>server_username</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
    <span class=nt>server_key_file_name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">192-168-33-80</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">copying configuraiton file and ssh keys</span>
      <span class=nt>template</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.src</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>dest</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.dst</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0400</span>
      
      <span class=nt>with_items</span><span class=p>:</span>
         <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class=nt> src</span><span class=p>:</span> <span class=s>&#39;config.toml&#39;</span><span class="p p-Indicator">,</span><span class=nt> dst</span><span class=p>:</span> <span class=s>&#39;/root/config.toml&#39;</span> <span class="p p-Indicator">}</span>
         <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class=nt> src</span><span class=p>:</span> <span class=s>&#39;192-168-33-80&#39;</span><span class="p p-Indicator">,</span><span class=nt> dst</span><span class=p>:</span> <span class=s>&#39;/root/.ssh/192-168-33-80&#39;</span> <span class="p p-Indicator">}</span> 

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running config test</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">configtest</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/vuls</span>
        <span class=nt>auto_remove</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
        <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">configtest -config=/root/config.toml</span>
        <span class=nt>volumes</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/.ssh:/root/.ssh:ro&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}/vuls-log:/var/log/vuls&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/config.toml:/root/config.toml:ro&quot;</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running vuls scanner</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vulsscan</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/vuls</span>
        <span class=nt>auto_remove</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
        <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">scan -config=/root/config.toml</span>
        <span class=nt>volumes</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/.ssh:/root/.ssh:ro&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}/vuls-log:/var/log/vuls&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/config.toml:/root/config.toml:ro&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/etc/localtime:/etc/localtime:ro&quot;</span>
        <span class=nt>env</span><span class=p>:</span>
          <span class=nt>TZ</span><span class=p>:</span> <span class=s>&quot;Asia/Kolkata&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">sending slack report</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vulsreport</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/vuls</span>
        <span class=nt>auto_remove</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
        <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">report -cvedb-path=/vuls/cve.sqlite3 -ovaldb-path=/vuls/oval.sqlite3 --to-slack -config=/root/config.toml</span>
        <span class=nt>volumes</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/.ssh:/root/.ssh:ro&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}/vuls-log:/var/log/vuls&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/root/config.toml:/root/config.toml:ro&quot;</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;/etc/localtime:/etc/localtime:ro&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls webui report</span>
      <span class=nt>docker_container</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vulswebui</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vuls/vulsrepo</span>
        <span class=nt>interactive</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>volumes</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vuls_data_directory</span><span class=nv> </span><span class=s>}}:/vuls&quot;</span>
        <span class=nt>ports</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;80:5111&quot;</span>
</code></pre></div></li> <li>The following file is the configuration file for vuls to perform the scanning. This holds the configuration for slack alerting and also the server to perform scanning. This can be configured very effectively as required using vuls documentation: <div class=highlight><pre><span></span><code><span class="p p-Indicator">[</span><span class=nv>slack</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">hookURL = &quot;{{ slack_web_hook_url}}&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">channel = &quot;{{ slack_channel }}&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">iconEmoji = &quot;{{ slack_emoji }}&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">[servers]</span>

<span class="l l-Scalar l-Scalar-Plain">[servers.{{ server_key_file_name }}]</span>
<span class="l l-Scalar l-Scalar-Plain">host = &quot;{{ server_to_scan }}&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">user = &quot;{{ server_username }}&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">keyPath = &quot;/root/.ssh/{{ server_key_file_name }}&quot;</span>
</code></pre></div></li> <li>We can also visit the web UI interface of the vuls server IP address to see the detailed results in tabular and portable format. This is very useful to manage large amount of servers and patches at scale.</li> <li>This can be part of the CI/CD life cycle as an infrastructure code and then we can run this as a scheduled scan using Ansible Tower or Jenkins.</li> </ul> <h3 id=scheduled-scans-for-file-integrity-checks-host-level-monitoring-using-ansible-for-various-compliance-initiatives>Scheduled scans for file integrity checks, host-level monitoring using Ansible for various compliance initiatives<a class=headerlink href=#scheduled-scans-for-file-integrity-checks-host-level-monitoring-using-ansible-for-various-compliance-initiatives title="Permanent link">&para;</a></h3> <ul> <li>One of the many advantages of being able to execute commands on the host using Ansible is the ability to get internal system information, such as:<ul> <li>File hashes</li> <li>Network connections</li> <li>List of running processes</li> </ul> </li> <li>It can act as a lightweight Host-Based Intrusion Detection System (HIDS). </li> <li>While this may not eliminate the case for a purpose-built HIDS in many cases, we can execute the same kind of security tasks using a tool such as Facebook's osquery along with Ansible. </li> </ul> <h3 id=osquery>osquery<a class=headerlink href=#osquery title="Permanent link">&para;</a></h3> <ul> <li>osquery is an operating system instrumentation framework by Facebook and written in C++, that supports Windows, Linux, OS X (macOS), and other operating systems. </li> <li>It provides an interface to query an operating system using an SQL like syntax. </li> <li>By using this, we can perform low-level activities such as running processes, kernel configurations, network connections, and file integrity checks. Overall it's like a host-based intrusion detection system (HIDS) endpoint security. </li> <li>It provides osquery as a service, system interactive shell, and so on. </li> <li>Hence we can use this to perform centralized monitoring and security management solutions. </li> <li>This playbook is to set up and configure the osquery agent in your Linux servers to monitor and look for vulnerabilities, file integrity monitoring, and many other compliance activities, and then log them for sending to a centralized logging monitoring system.</li> <li>The reference tutorial can be followed at <a href=https://www.digitalocean.com/community/tutorials/how-to-monitor-your-system-security-with-osquery-on-ubuntu-16-04>DigitalOcean</a>. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">setting up osquery</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">linuxservers</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing osquery</span>
      <span class=nt>apt</span><span class=p>:</span>
        <span class=nt>deb</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://pkg.osquery.io/deb/osquery_2.10.2_1.linux.amd64.deb</span>
        <span class=nt>update_cache</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">adding osquery configuration</span>
      <span class=nt>template</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.src</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>dest</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.dst</span><span class=nv> </span><span class=s>}}&quot;</span>
      
      <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class=nt> src</span><span class=p>:</span> <span class=nv>fim.conf</span><span class="p p-Indicator">,</span><span class=nt> dst</span><span class=p>:</span> <span class=nv>/usr/share/osquery/packs/fim.conf</span> <span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class=nt> src</span><span class=p>:</span> <span class=nv>osquery.conf</span><span class="p p-Indicator">,</span><span class=nt> dst</span><span class=p>:</span> <span class=nv>/etc/osquery/osquery.conf</span> <span class="p p-Indicator">}</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">starting and enabling osquery service</span>
      <span class=nt>service</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">osqueryd</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
        <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div></li> <li>The following <code>fim.conf</code> code snippet is the pack for file integrity monitoring and it monitors for file events in the /home, /etc, and /tmp directories every 300 seconds. It uses Secure Hash Algorithm (SHA) checksum to validate the changes. This can be used to find out whether attackers add their own SSH keys or audit log changes against system configuration changes for compliance and other activities. <div class=highlight><pre><span></span><code><span class=p>{</span>
  <span class=nt>&quot;queries&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;file_events&quot;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;select * from file_events;&quot;</span><span class=p>,</span>
      <span class=nt>&quot;removed&quot;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
      <span class=nt>&quot;interval&quot;</span><span class=p>:</span> <span class=mi>300</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>&quot;file_paths&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;homes&quot;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&quot;/root/.ssh/%%&quot;</span><span class=p>,</span>
      <span class=s2>&quot;/home/%/.ssh/%%&quot;</span>
    <span class=p>],</span>
      <span class=nt>&quot;etc&quot;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&quot;/etc/%%&quot;</span>
    <span class=p>],</span>
      <span class=nt>&quot;home&quot;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&quot;/home/%%&quot;</span>
    <span class=p>],</span>
      <span class=nt>&quot;tmp&quot;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&quot;/tmp/%%&quot;</span>
    <span class=p>]</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li> <li>The following code snippet is the osquery service configuration. This can be modified as required to monitor and log by osquery service. <div class=highlight><pre><span></span><code><span class=p>{</span>
  <span class=nt>&quot;options&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;config_plugin&quot;</span><span class=p>:</span> <span class=s2>&quot;filesystem&quot;</span><span class=p>,</span>
    <span class=nt>&quot;logger_plugin&quot;</span><span class=p>:</span> <span class=s2>&quot;filesystem&quot;</span><span class=p>,</span>
    <span class=nt>&quot;logger_path&quot;</span><span class=p>:</span> <span class=s2>&quot;/var/log/osquery&quot;</span><span class=p>,</span>
    <span class=nt>&quot;disable_logging&quot;</span><span class=p>:</span> <span class=s2>&quot;false&quot;</span><span class=p>,</span>
    <span class=nt>&quot;log_result_events&quot;</span><span class=p>:</span> <span class=s2>&quot;true&quot;</span><span class=p>,</span>
    <span class=nt>&quot;schedule_splay_percent&quot;</span><span class=p>:</span> <span class=s2>&quot;10&quot;</span><span class=p>,</span>
    <span class=nt>&quot;pidfile&quot;</span><span class=p>:</span> <span class=s2>&quot;/var/osquery/osquery.pidfile&quot;</span><span class=p>,</span>
    <span class=nt>&quot;events_expiry&quot;</span><span class=p>:</span> <span class=s2>&quot;3600&quot;</span><span class=p>,</span>
    <span class=nt>&quot;database_path&quot;</span><span class=p>:</span> <span class=s2>&quot;/var/osquery/osquery.db&quot;</span><span class=p>,</span>
    <span class=nt>&quot;verbose&quot;</span><span class=p>:</span> <span class=s2>&quot;false&quot;</span><span class=p>,</span>
    <span class=nt>&quot;worker_threads&quot;</span><span class=p>:</span> <span class=s2>&quot;2&quot;</span><span class=p>,</span>
    <span class=nt>&quot;enable_monitor&quot;</span><span class=p>:</span> <span class=s2>&quot;true&quot;</span><span class=p>,</span>
    <span class=nt>&quot;disable_events&quot;</span><span class=p>:</span> <span class=s2>&quot;false&quot;</span><span class=p>,</span>
    <span class=nt>&quot;disable_audit&quot;</span><span class=p>:</span> <span class=s2>&quot;false&quot;</span><span class=p>,</span>
    <span class=nt>&quot;audit_allow_config&quot;</span><span class=p>:</span> <span class=s2>&quot;true&quot;</span><span class=p>,</span>
    <span class=nt>&quot;host_identifier&quot;</span><span class=p>:</span> <span class=s2>&quot;hostname&quot;</span><span class=p>,</span>
    <span class=nt>&quot;enable_syslog&quot;</span><span class=p>:</span> <span class=s2>&quot;true&quot;</span><span class=p>,</span>
    <span class=nt>&quot;audit_allow_sockets&quot;</span><span class=p>:</span> <span class=s2>&quot;true&quot;</span><span class=p>,</span>
    <span class=nt>&quot;schedule_default_interval&quot;</span><span class=p>:</span> <span class=s2>&quot;3600&quot;</span> 
  <span class=p>},</span>
  <span class=nt>&quot;schedule&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;crontab&quot;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;SELECT * FROM crontab;&quot;</span><span class=p>,</span>
      <span class=nt>&quot;interval&quot;</span><span class=p>:</span> <span class=mi>300</span>
    <span class=p>},</span>
    <span class=nt>&quot;system_profile&quot;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;SELECT * FROM osquery_schedule;&quot;</span>
    <span class=p>},</span> 
    <span class=nt>&quot;system_info&quot;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;SELECT hostname, cpu_brand, physical_memory FROM system_info;&quot;</span><span class=p>,</span>
      <span class=nt>&quot;interval&quot;</span><span class=p>:</span> <span class=mi>3600</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>&quot;decorators&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;load&quot;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&quot;SELECT uuid AS host_uuid FROM system_info;&quot;</span><span class=p>,</span>
      <span class=s2>&quot;SELECT user AS username FROM logged_in_users ORDER BY time DESC LIMIT 1;&quot;</span>
    <span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&quot;packs&quot;</span><span class=p>:</span> <span class=p>{</span>
     <span class=nt>&quot;fim&quot;</span><span class=p>:</span> <span class=s2>&quot;/usr/share/osquery/packs/fim.conf&quot;</span><span class=p>,</span>
     <span class=nt>&quot;osquery-monitoring&quot;</span><span class=p>:</span> <span class=s2>&quot;/usr/share/osquery/packs/osquery-monitoring.conf&quot;</span><span class=p>,</span>
     <span class=nt>&quot;incident-response&quot;</span><span class=p>:</span> <span class=s2>&quot;/usr/share/osquery/packs/incident-response.conf&quot;</span><span class=p>,</span>
     <span class=nt>&quot;it-compliance&quot;</span><span class=p>:</span> <span class=s2>&quot;/usr/share/osquery/packs/it-compliance.conf&quot;</span><span class=p>,</span>
     <span class=nt>&quot;vuln-management&quot;</span><span class=p>:</span> <span class=s2>&quot;/usr/share/osquery/packs/vuln-management.conf&quot;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li> <li>The goal is not just setting up osquery, we can use the logs to build a centralized real-time monitoring system using our Elastic stack. </li> <li>We can use the Filebeat agent to forward these logs to our Elastic stack and we can view them and build a centralized dashboard for alerting and monitoring.</li> <li>This idea can be extended for building some automated defences by taking actions against attacks by using automated Ansible playbooks for known actions.</li> <li>The world is moving toward containers and this kind of monitoring gives us a look at low-level things such as kernel security checks, and file integrity checks on host level. </li> <li>When attackers try to bypass containers and get access to hosts to escalate privileges, we can detect and defend them using this kind of setup.</li> </ul> <h3 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h3> <ul> <li>Containers are rapidly changing the world of developers and operations teams. </li> <li>The rate of change is accelerating, and in this new world, security automation gets to play a front and center role. </li> <li>By leveraging our knowledge of using Ansible for scripting play-by-play commands along with excellent tools such as <strong>Anchore and osquery</strong>, we can measure, analyze, and benchmark our containers for security. </li> <li>This allows us to build end-to-end automatic processes of securing, scanning and remediating containers. </li> </ul> <h2 id=automating-lab-setups-for-forensics-collection-and-malware-analysis>Automating Lab Setups for Forensics Collection and Malware Analysis<a class=headerlink href=#automating-lab-setups-for-forensics-collection-and-malware-analysis title="Permanent link">&para;</a></h2> <ul> <li>Malware is one of the biggest challenges faced by the security community. </li> <li>It impacts everyone who gets to interact with information systems. </li> <li>While there is a massive effort required in keeping computers safe from malware for operational systems, a big chunk of work in malware defenses is about understanding where they come from and what they are capable of.</li> <li>Another important aspect of malware analysis is the ability to collaborate and share threats using the Malware Information Sharing Platform (MISP). </li> <li>One of the initial phases of malware analysis is identification and classification. </li> <li>The most popular source is using VirusTotal to scan and get the results of the malware samples, domain information, and so on. </li> <li>It has a very rich API and a lot of people have written custom apps that leverage the API to perform the automated scans using the API key for identifying the malware type. </li> <li>It generally checks using more than 60 antivirus scanners and tools and provides detailed information.</li> </ul> <h3 id=virustotal--api-tool-set-up>VirusTotal API tool set up<a class=headerlink href=#virustotal--api-tool-set-up title="Permanent link">&para;</a></h3> <ul> <li>The following playbook will set up the <a href=https://github.com/doomedraven/VirusTotalApi>VirusTotal API tool</a> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">setting up VirusTotal</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">malware</span>
  <span class=nt>remote_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing pip</span>
      <span class=nt>apt</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
        
      <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python-pip</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">unzip</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">checking if vt already exists</span>
      <span class=nt>stat</span><span class=p>:</span>
        <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/vt</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vt_status</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">downloading VirusTotal api tool repo</span>
      <span class=nt>unarchive</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class=s>&quot;https://github.com/doomedraven/VirusTotalApi/archive/master.zip&quot;</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/</span>
        <span class=nt>remote_src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vt_status.stat.exists == False</span> 

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing the dependencies</span>
      <span class=nt>pip</span><span class=p>:</span>
        <span class=nt>requirements</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/VirusTotalApi-master/requirements.txt</span>
      <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vt_status.stat.exists == False</span> 
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing vt</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">python /tmp/VirusTotalApi-master/setup.py install</span>
      <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vt_status.stat.exists == False</span>
</code></pre></div></li> <li>The playbook execution will download the repository and set up the VirusTotal API tool.</li> <li>The following playbook will find and copy the local malware samples to a remote system and scan them recursively and return the results. </li> <li>Once the scan has been completed, it will remove the samples from the remote system. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">scanning file in VirusTotal</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">malware</span>
  <span class=nt>remote_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>vt_api_key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span> <span class=c1>#use Ansible-vault</span>
    <span class=nt>vt_api_type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">public</span> <span class=c1># public/private</span>
    <span class=nt>vt_intelligence_access</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">False</span> <span class=c1># True/False</span>
    <span class=nt>files_in_local_system</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/samples/</span>
    <span class=nt>files_in_remote_system</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/sample-file/</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">creating samples directory</span>
      <span class=nt>file</span><span class=p>:</span>
        <span class=nt>path</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>files_in_remote_system</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">directory</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">copying file to remote system</span>
      <span class=nt>copy</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>files_in_local_system</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>dest</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>files_in_remote_system</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>directory_mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">copying configuration</span>
      <span class=nt>template</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">config.j2</span>
        <span class=nt>dest</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>files_in_remote_system</span><span class=nv> </span><span class=s>}}/.vtapi&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running VirusTotal scan</span>
      <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;vt</span><span class=nv> </span><span class=s>-fr</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>files_in_remote_system</span><span class=nv> </span><span class=s>}}&quot;</span>
      <span class=nt>args</span><span class=p>:</span>
        <span class=nt>chdir</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>files_in_remote_system</span><span class=nv> </span><span class=s>}}&quot;</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">vt_scan</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">removing the samples</span>
      <span class=nt>file</span><span class=p>:</span>
        <span class=nt>path</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>files_in_remote_system</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">VirusTotal scan results</span>
      <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>vt_scan.stdout_lines</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div></li> </ul> <h3 id=creating-ansible-playbooks-for-collection-and-storage-with-secure-backup-of-forensic-artifacts>Creating Ansible playbooks for collection and storage with secure backup of forensic artifacts<a class=headerlink href=#creating-ansible-playbooks-for-collection-and-storage-with-secure-backup-of-forensic-artifacts title="Permanent link">&para;</a></h3> <ul> <li>Ansible is an apt replacement for all kinds of bash scripts. Typically, for most activities that require analysis, we follow a set pattern:<ul> <li>Collect logs from running processes into files with a path we already know</li> <li>Copy the content from these log files periodically to a secure storage locally or accessible remotely over SSH or a network file share</li> <li>Once copied successfully, rotate the logs</li> </ul> </li> <li>Since there is a bit of network activity involved, our bash scripts are usually written to be fault tolerant with regard to network connections and become complex very soon. </li> <li>Ansible playbooks can be used to do all of that while being simple to read for everyone. </li> </ul> <h3 id=collecting-log-artifacts-for-incident-response>Collecting log artifacts for incident response<a class=headerlink href=#collecting-log-artifacts-for-incident-response title="Permanent link">&para;</a></h3> <ul> <li>The key phase in incident response is log analysis. </li> <li>This playbook will collect the logs from all the hosts and store it locally.</li> <li>This allows responders to perform the further analysis. <div class=highlight><pre><span></span><code><span class=c1># Reference https://www.Ansible.com/security-automation-with-Ansible</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Gather log files</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">servers</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">List files to grab</span>
      <span class=nt>find</span><span class=p>:</span>
        <span class=nt>paths</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/var/log</span>
        <span class=nt>patterns</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&#39;*.log*&#39;</span>
        <span class=nt>recurse</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">log_files</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Grab files</span>
      <span class=nt>fetch</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.path</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>dest</span><span class=p>:</span> <span class=s>&quot;/tmp/LOGS_{{</span><span class=nv> </span><span class=s>Ansible_fqdn</span><span class=nv> </span><span class=s>}}/&quot;</span>
      <span class=nt>with_items</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>log_files.files</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div></li> <li>This playbook execution will collect a list of logs in specified locations in remote hosts using Ansible modules and store them in the local system.</li> </ul> <h3 id=secure-backups-for-data-collection>Secure backups for data collection<a class=headerlink href=#secure-backups-for-data-collection title="Permanent link">&para;</a></h3> <ul> <li>When collecting multiple sets of data from servers, it's important to store them securely with encrypted backups. </li> <li>This can be achieved by backing up the data to storage services such as S3. This Ansible playbook allows us to install and copy the collected data to the AWS S3 service with encryption enabled. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backing up the log data</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>s3_access_key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">XXXXXXX</span> <span class=c1># Use Ansible-vault to encrypt</span>
    <span class=nt>s3_access_secret</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">XXXXXXX</span> <span class=c1># Use Ansible-vault to encrypt</span>
    <span class=nt>localfolder</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/LOGS/</span> <span class=c1># Trailing slash is important</span>
    <span class=nt>remotebucket</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">secretforensicsdatausingAnsible</span> <span class=c1># This should be unique in s3</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">installing s3cmd if not installed</span>
      <span class=nt>apt</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class=nt>update_cache</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      
      <span class=nt>with_items</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python-magic</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python-dateutil</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">s3cmd</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">create s3cmd config file</span>
      <span class=nt>template</span><span class=p>:</span>
        <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">s3cmd.j2</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/root/.s3cfg</span>
        <span class=nt>owner</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class=nt>group</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0640</span>
    
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">make sure &quot;{{ remotebucket }}&quot; is avilable</span>
      <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;s3cmd</span><span class=nv> </span><span class=s>mb</span><span class=nv> </span><span class=s>s3://{{</span><span class=nv> </span><span class=s>remotebucket</span><span class=nv> </span><span class=s>}}/</span><span class=nv> </span><span class=s>-c</span><span class=nv> </span><span class=s>/root/.s3cfg&quot;</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">running the s3 backup to &quot;{{ remotebucket }}&quot;</span>
      <span class=nt>command</span><span class=p>:</span> <span class=s>&quot;s3cmd</span><span class=nv> </span><span class=s>sync</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>localfolder</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>--preserve</span><span class=nv> </span><span class=s>s3://{{</span><span class=nv> </span><span class=s>remotebucket</span><span class=nv> </span><span class=s>}}/</span><span class=nv> </span><span class=s>-c</span><span class=nv> </span><span class=s>/root/.s3cfg&quot;</span>
</code></pre></div></li> <li>The Ansible playbook installing s3cmd, creating the new bucket called secretforensicsdatausingAnsible, and copying the local log data to the remote S3 bucket.</li> <li>The configuration file looks like the following for the s3cmd configuration <div class=highlight><pre><span></span><code><span class="p p-Indicator">[</span><span class=nv>default</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">access_key = {{ s3_access_key }}</span>
<span class="l l-Scalar l-Scalar-Plain">secret_key = {{ s3_access_secret }}</span>
<span class="l l-Scalar l-Scalar-Plain">host_base = s3.amazonaws.com</span>
<span class="l l-Scalar l-Scalar-Plain">host_bucket = %(bucket)s.s3.amazonaws.com</span>
<span class="l l-Scalar l-Scalar-Plain">website_endpoint = http://%(bucket)s.s3-website-%(location)s.amazonaws.com/</span>
<span class="l l-Scalar l-Scalar-Plain">use_https = True</span>
<span class="l l-Scalar l-Scalar-Plain">signature_v2 = True</span>
</code></pre></div></li> <li>We can see that the logs are successfully uploaded into the secretforensicsdatausingAnsible S3 bucket in AWS S3. <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div> <div class=highlight><pre><span></span><code>
</code></pre></div></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2018 - 2019 Leslie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> with emoji by <a href=https://github.com/twitter/twemoji target=_blank rel=noopener> Twemoji </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script> <script src=../../../assets/javascripts/bundle.ca5457b8.min.js></script> </body> </html>