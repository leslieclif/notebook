<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Leslie><link href=https://leslieclif.github.io/notebook/learning/ansible/troubleshooting/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-7.0.3"><title>Troubleshooting - Leslie's Online Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/main.1655a90d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.7fa14f5b.min.css><script src=../../../assets/extra.js type=text/javascript></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/extra.css></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#troubleshooting class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Leslie's Online Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Troubleshooting </span> </div> </div> </div> <div class=md-header__options> <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon"> <a href=javascript:toggleScheme(); title="Dark mode" class=dark-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg> </a> <a href=javascript:toggleScheme(); title="Light mode" class=light-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg> </a> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> Leslie's Online Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../developer/ class=md-nav__link> Developer Setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> IDE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDE data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> IDE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ide/ class=md-nav__link> IDE Tips and Tricks </a> </li> <li class=md-nav__item> <a href=../../../ide/markdown/ class=md-nav__link> Markdown </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Server <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Server data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../server/ class=md-nav__link> Server Details </a> </li> <li class=md-nav__item> <a href=../../../server/install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../server/mobile/ class=md-nav__link> Mobile </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ansible data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ansible/ class=md-nav__link> Ansible </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../k8s/install/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Learning <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Learning data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../git/ class=md-nav__link> Git </a> </li> <li class=md-nav__item> <a href=../../python/ class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../vagrant/ class=md-nav__link> Vagrant </a> </li> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../docker/docker-notes/ class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=../../k8s/k8s-notes/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../linux/linux/ class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../linux/security/ class=md-nav__link> Linux_Security </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Devops data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/ class=md-nav__link> Index </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> Troubleshooting </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#digging-into-playbook-execution-problems class=md-nav__link> Digging into playbook execution problems </a> </li> <li class=md-nav__item> <a href=#using-host-facts-to-diagnose-failures class=md-nav__link> Using host facts to diagnose failures </a> </li> <li class=md-nav__item> <a href=#testing-with-a-playbook class=md-nav__link> Testing with a playbook </a> </li> <li class=md-nav__item> <a href=#using-check-mode class=md-nav__link> Using check mode </a> </li> <li class=md-nav__item> <a href=#solving-host-connection-issues class=md-nav__link> Solving host connection issues </a> </li> <li class=md-nav__item> <a href=#passing-working-variables-via-the-cli class=md-nav__link> Passing working variables via the CLI </a> </li> <li class=md-nav__item> <a href=#limiting-the-hosts-execution class=md-nav__link> Limiting the host's execution </a> </li> <li class=md-nav__item> <a href=#flushing-the-code-cache class=md-nav__link> Flushing the code cache </a> </li> <li class=md-nav__item> <a href=#checking-for-bad-syntax class=md-nav__link> Checking for bad syntax </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Troubleshooting</h1> <h2 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h2> <ul> <li>It's also important to remember that, due to its nature, in Ansible code, we describe the <strong>desired state</strong> rather than stating a sequence of steps to obtain the desired state.</li> <li>This difference means that the system is less prone to logical errors.</li> <li>Nevertheless, a bug in a Playbook could mean a potential misconfiguration on all of your machines. This should be taken very seriously. </li> <li>It is even more critical when critical parts of the system are changed, such as SSH daemon or sudo configuration, since the risk is you locking yourself out of the system.</li> </ul> <h3 id=digging-into-playbook-execution-problems>Digging into playbook execution problems<a class=headerlink href=#digging-into-playbook-execution-problems title="Permanent link">&para;</a></h3> <ul> <li>There are cases where an Ansible execution will interrupt. Many things can cause these situations.</li> <li>The single most frequent cause of problems I've found while executing Ansible playbooks is the network. </li> <li>Since the machine that is issuing the commands and the one that is performing them are usually linked through the network, a problem in the network will immediately show itself as an Ansible execution problem.</li> <li>For instance, if you run the /bin/false command, it will always return 1. To execute this in a playbook so that you can avoid it blocking there, you can write something like the following: <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Run a command that will return 1</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
  <span class=nt>ignore_errors</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div></li> <li>Be aware that this is a particular case, and often, the best approach is to fix your application so that you're following UNIX standards and return 0 if the application runs appropriately, instead of putting a workaround in your Playbooks.</li> </ul> <h3 id=using-host-facts-to-diagnose-failures>Using host facts to diagnose failures<a class=headerlink href=#using-host-facts-to-diagnose-failures title="Permanent link">&para;</a></h3> <ul> <li>Some execution failures derive from the state of the target machine. </li> <li>The most common problem of this kind is the case where Ansible expects a file or variable to be present, but it's not.</li> <li>Sometimes, it can be enough to print the machine facts to find the problem. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">target_host</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Display all variables/facts known for a host</span>
      <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>var</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hostvars[inventory_hostname]</span>
</code></pre></div></li> <li>This technique will give you a lot of information about the state of the target machine during Ansible execution.</li> </ul> <h3 id=testing-with-a-playbook>Testing with a playbook<a class=headerlink href=#testing-with-a-playbook title="Permanent link">&para;</a></h3> <ul> <li>One of the most complex things in the IT field is not creating software and systems, but debugging them when they have problems. Ansible is not an exception.</li> <li>No matter how good you are at creating Ansible playbooks, sooner or later, you'll find yourself debugging a playbook that is not behaving as you thought it would.</li> <li>The simplest way of performing basic tests is to print out the values of variables during execution. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/uptime</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>var</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>
</code></pre></div></li> <li>The debug module is the module that allows you to print the value of a variable (by using the var option) or a fixed string (by using the msg option) during Ansible's execution.</li> <li>The debug module also provides the verbosity option. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/uptime</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
       <span class=nt>var</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>
       <span class=nt>verbosity</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div></li> <li>We set the minimum required verbosity to 2, and by default, Ansible runs with a verbosity of 0.</li> <li>To see the result of using the debug module with this new playbook <div class=highlight><pre><span></span><code>ansible-playbook debug2.yaml -vv
</code></pre></div></li> <li>By putting two -v options in the command line, we will be running Ansible with verbosity of 2. </li> <li>This will not only affect this specific module but all the modules (or Ansible itself) that are set to behave differently at different debug levels.</li> </ul> <h3 id=using-check-mode>Using check mode<a class=headerlink href=#using-check-mode title="Permanent link">&para;</a></h3> <ul> <li>Although you might be confident in the code you have written, it still pays to test it before running it for real in a production environment. </li> <li>In such cases, it is a good idea to be able to run your code, but with a safety net in place. This is what check mode is for. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Touch a file</span>
      <span class=nt>file</span><span class=p>:</span>
        <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/myfile</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
</code></pre></div> <div class=highlight><pre><span></span><code>ansible-playbook check-mode.yaml --check
</code></pre></div></li> <li>Ansible check mode is usually called a dry run. The idea is that the run won't change the state of the machine and will only highlight the differences between the current status and the status declared in the playbook.</li> <li>Not all modules support check mode, but all major modules do, and more and more modules are being added at every release. In particular, note that the command and shell modules do not support it because it is impossible for the module to tell what commands will result in a change, and what won't. Therefore, these modules will always return changed when they're run outside of check mode because they assume a change has been made. </li> <li>A similar feature to check mode is the &ndash;diff flag. What this flag allows us to do is track what exactly changed during an Ansible execution. <div class=highlight><pre><span></span><code>ansible-playbook check-mode.yaml --diff
</code></pre></div></li> <li>The output says changed, which means that something was changed (more specifically, the file was created), and in the output, we can see a diff-like output that tells us that the state moved from absent to touch, which means the file was created. mtime and atime also changed, but this is probably due to how files are created and checked.</li> </ul> <h3 id=solving-host-connection-issues>Solving host connection issues<a class=headerlink href=#solving-host-connection-issues title="Permanent link">&para;</a></h3> <ul> <li>Ansible is often used to manage remote hosts or systems. To do this, Ansible will need to be able to connect to the remote host, and only after that will it be able to issue commands. </li> <li>Sometimes, the problem is that Ansible is unable to connect to the remote host. A typical example of this is when you try to manage a machine that hasn't booted yet. Being able to quickly recognize these kinds of problems and fix them promptly will help you save a lot of time. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Touch a file</span>
      <span class=nt>file</span><span class=p>:</span>
        <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/myfile</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
</code></pre></div></li> <li>We can try to run the remote.yaml playbook against a non-existent FQDN <div class=highlight><pre><span></span><code>ansible-playbook -i host.example.com, remote.yaml
</code></pre></div></li> <li>The output will clearly inform us that the SSH service did not reply in time.</li> <li>SSH connections usually fail for one of two reasons:<ul> <li>The SSH client is unable to establish a connection with the SSH server</li> <li>The SSH server refuses the credentials provided by the SSH client</li> </ul> </li> <li>It's very probable that the IP address or the port is wrong, so the TCP connection isn't feasible. </li> <li>Usually, double-checking the IP and the hostname (if it's a DNS, check that it resolves to the right IP) solves the problem.</li> <li>To investigate this further, you can try performing an SSH connection from the same machine to check if there are problems. <div class=highlight><pre><span></span><code>ssh host.example.com -vvv
</code></pre></div></li> <li>The second problem might be a little bit more complex to debug since it can happen for multiple reasons. </li> <li>One of those is that you are trying to connect to the wrong host and you don't have the credentials for that machine. </li> <li>Another common case is that the username is wrong. To debug it, you can take the user@host address that is shown in the error (in my case, <a href=mailto:fale@host.example.com>&#102;&#97;&#108;&#101;&#64;&#104;&#111;&#115;&#116;&#46;&#101;&#120;&#97;&#109;&#112;&#108;&#101;&#46;&#99;&#111;&#109;</a>) and use the same command you used previously. <div class=highlight><pre><span></span><code>ssh fale@host.example.com -vvv
</code></pre></div></li> <li>This should raise the same error that Ansible reported to you, but with much more details.</li> </ul> <h3 id=passing-working-variables-via-the-cli>Passing working variables via the CLI<a class=headerlink href=#passing-working-variables-via-the-cli title="Permanent link">&para;</a></h3> <ul> <li>One thing that can help during debugging, and definitely helps for code reusability, is passing variables to playbooks via the command line.</li> <li>Every time your application – either an Ansible playbook or any kind of application – receives an input from a third party (a human, in this case), it should ensure that the value is reasonable. </li> <li>An example of this would be to check that the variable has been set and therefore is not an empty string. </li> <li><strong>This is a security golden rule, but should also be applied when the user is trusted since the user might mistype the variable name</strong>. </li> <li>The application should identify this and protect the whole system by protecting itself. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
       <span class=nt>var</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">variable</span>
</code></pre></div></li> <li>Now that we have an Ansible playbook that allows us to see if a variable has been set to what we were expecting, let's run it with variable declared in the execution statement. <div class=highlight><pre><span></span><code>ansible-playbook printvar.yaml --extra-vars<span class=o>=</span><span class=s1>&#39;{&quot;variable&quot;: &quot;Hello, World!&quot;}&#39;</span>
</code></pre></div></li> <li>Ansible allows variables to be set in various modes and with different priorities. More specifically, you can set them with the following.<ul> <li>Command-line values (lowest priority)</li> <li>Role defaults</li> <li>Inventory files or script group vars</li> <li>Inventory group_vars/all</li> <li>Playbook group_vars/all</li> <li>Inventory group_vars/*</li> <li>Playbook group_vars/*</li> <li>Inventory files or script host vars</li> <li>Inventory host_vars/*</li> <li>Playbook host_vars/*</li> <li>Host facts/cached set_facts</li> <li>Play vars</li> <li>Play vars_prompt</li> <li>Play vars_files</li> <li>Role vars (defined in role/vars/main.yml)</li> <li>Block vars (only for tasks in block)</li> <li>Task vars (only for the task)</li> <li>include_vars</li> <li>set_facts/registered vars</li> <li>Role (and include_role) params</li> <li>include params</li> <li>Extra vars (highest priority)</li> </ul> </li> </ul> <h3 id=limiting-the-hosts-execution>Limiting the host's execution<a class=headerlink href=#limiting-the-hosts-execution title="Permanent link">&para;</a></h3> <ul> <li>While testing a playbook, it might make sense to test on a restricted number of machines; for instance, just one. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;Hello,</span><span class=nv> </span><span class=s>World!&quot;</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class="p p-Indicator">[</span><span class=nv>hosts</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">host1.example.com</span>
<span class="l l-Scalar l-Scalar-Plain">host2.example.com</span>
<span class="l l-Scalar l-Scalar-Plain">host3.example.com</span>
</code></pre></div></li> <li>If we just want to run it against host3.example.com, we will need to specify this on the command line. <div class=highlight><pre><span></span><code>ansible-playbook -i inventory helloworld.yaml --limit<span class=o>=</span>host3.example.com
</code></pre></div></li> <li>By using the &ndash;limit keyword, we can force Ansible to ignore all the hosts that are outside what is specified in the limit parameter.</li> <li>It's possible to specify multiple hosts as a list or with patterns, so both of the following commands will execute the playbook against host2.example.com and host3.example.com <div class=highlight><pre><span></span><code>ansible-playbook -i inventory helloworld.yaml --limit<span class=o>=</span>host2.example.com,host3.example.com

ansible-playbook -i inventory helloworld.yaml --limit<span class=o>=</span>host<span class=o>[</span><span class=m>2</span>-3<span class=o>]</span>.example.com
</code></pre></div></li> </ul> <h3 id=flushing-the-code-cache>Flushing the code cache<a class=headerlink href=#flushing-the-code-cache title="Permanent link">&para;</a></h3> <ul> <li>Everywhere in IT, caches are used to speed up operations, and Ansible is not an exception.</li> <li>Usually, caches are good, and for this reason, they are heavily used ubiquitously. </li> <li>However, they might create some problems if they cache a value they should not have cached or if they are not flushed, even if the value has changed.</li> <li>Flushing caches in Ansible is very straightforward, and it's enough to run ansible-playbook, which we are already running, with the addition of the &ndash;flush-cache option <div class=highlight><pre><span></span><code>ansible-playbook -i inventory helloworld.yaml --flush-cache
</code></pre></div></li> <li>Ansible uses Redis to save host variables, as well as execution variables. Sometimes, those variables might be left behind and influence the following executions. When Ansible finds a variable that should be set in the step it just started, Ansible might assume that the step has already been completed, and therefore pick up that old variable as if it has just been created. </li> <li>By using the &ndash;flush-cache option, we can avoid this since it will ensure that Ansible flushes the Redis cache during its execution.</li> </ul> <h3 id=checking-for-bad-syntax>Checking for bad syntax<a class=headerlink href=#checking-for-bad-syntax title="Permanent link">&para;</a></h3> <ul> <li>Defining whether a file has the right syntax or not is fairly easy for a machine, but might be more complex for humans. </li> <li>This does not mean that machines are able to fix the code for you, but they can quickly identify whether a problem is present or not. </li> <li>To use Ansible's built-in syntax checker, we need a playbook with a syntax error. <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
      <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;Hello,</span><span class=nv> </span><span class=s>World!&quot;</span>
</code></pre></div></li> <li>We can use the &ndash;syntax-check command <div class=highlight><pre><span></span><code>ansible-playbook syntaxcheck.yaml --syntax-check
</code></pre></div></li> <li>Since Ansible knows all the supported options in all the supported modules, it can quickly read your code and validate whether the YAML you provided contains all the required fields and that it does not contain any unsupported fields.</li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2018 - 2019 Leslie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> with emoji by <a href=https://github.com/twitter/twemoji target=_blank rel=noopener> Twemoji </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script> <script src=../../../assets/javascripts/bundle.ca5457b8.min.js></script> </body> </html>