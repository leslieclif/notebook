<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Leslie><link href=https://leslieclif.github.io/notebook/learning/tools/terraform/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.1, mkdocs-material-7.0.3"><title>Terraform - Leslie's Online Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/main.1655a90d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.7fa14f5b.min.css><script src=../../../assets/extra.js type=text/javascript></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/extra.css></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#terraform class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Leslie's Online Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Terraform </span> </div> </div> </div> <div class=md-header__options> <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon"> <a href=javascript:toggleScheme(); title="Dark mode" class=dark-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg> </a> <a href=javascript:toggleScheme(); title="Light mode" class=light-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg> </a> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> Leslie's Online Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../developer/ class=md-nav__link> Developer Setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Devops data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/ class=md-nav__link> Devops </a> </li> <li class=md-nav__item> <a href=../../../devops/ci/ class=md-nav__link> CI </a> </li> <li class=md-nav__item> <a href=../../../devops/cd/ class=md-nav__link> CD </a> </li> <li class=md-nav__item> <a href=../../../devops/iac/ class=md-nav__link> IAC </a> </li> <li class=md-nav__item> <a href=../../../devops/gitops/ class=md-nav__link> GitOps </a> </li> <li class=md-nav__item> <a href=../../../devops/devops-engineer/ class=md-nav__link> Skills </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> IDE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDE data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> IDE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ide/ class=md-nav__link> IDE Tips and Tricks </a> </li> <li class=md-nav__item> <a href=../../../ide/markdown/ class=md-nav__link> Markdown </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Server <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Server data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../server/ class=md-nav__link> Server Details </a> </li> <li class=md-nav__item> <a href=../../../server/install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../server/mobile/ class=md-nav__link> Mobile </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ansible data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ansible/ansible/ class=md-nav__link> Ansible </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../k8s/install/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Learning <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Learning data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../git/ class=md-nav__link> Git </a> </li> <li class=md-nav__item> <a href=../../python/ class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../vagrant/ class=md-nav__link> Vagrant </a> </li> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../docker/docker-notes/ class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=../../k8s/k8s-notes/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../linux/linux/ class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../linux/security/ class=md-nav__link> Linux_Security </a> </li> <li class=md-nav__item> <a href=../../linux/firewall/ class=md-nav__link> Linux_Firewall </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#terraform class=md-nav__link> Terraform </a> <nav class=md-nav aria-label=Terraform> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tldr class=md-nav__link> TL;DR </a> </li> <li class=md-nav__item> <a href=#modules class=md-nav__link> Modules </a> <nav class=md-nav aria-label=Modules> <ul class=md-nav__list> <li class=md-nav__item> <a href=#useful-internal-variables class=md-nav__link> Useful internal variables </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#versioning class=md-nav__link> Versioning </a> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> Troubleshooting </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#count-vs-for_each class=md-nav__link> count vs for_each </a> </li> <li class=md-nav__item> <a href=#conditional-creation-of-a-resource class=md-nav__link> Conditional creation of a resource </a> </li> <li class=md-nav__item> <a href=#force-the-recreation-of-specific-resources class=md-nav__link> Force the recreation of specific resources </a> </li> <li class=md-nav__item> <a href=#error-at-least-1-features-blocks-are-required class=md-nav__link> Error: at least 1 "features" blocks are required </a> </li> <li class=md-nav__item> <a href=#addsubtract-time class=md-nav__link> Add/subtract time </a> </li> <li class=md-nav__item> <a href=#export-the-contents-of-a-tfvars-file-as-shell-variables class=md-nav__link> Export the contents of a tfvars file as shell variables </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#further-readings class=md-nav__link> Further readings </a> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> Sources </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Terraform</h1> <h2 id=terraform>Terraform<a class=headerlink href=#terraform title="Permanent link">&para;</a></h2> <ol> <li><a href=#tldr>TL;DR</a></li> <li><a href=#modules>Modules</a></li> <li><a href=#useful-internal-variables>Useful internal variables</a></li> <li><a href=#versioning>Versioning</a></li> <li><a href=#troubleshooting>Troubleshooting</a></li> <li><a href=#count-vs-for_each><code>count</code> vs <code>for_each</code></a></li> <li><a href=#conditional-creation-of-a-resource>Conditional creation of a resource</a></li> <li><a href=#force-the-recreation-of-specific-resources>Force the recreation of specific resources</a></li> <li><a href=#error-at-least-1-features-blocks-are-required>Error: at least 1 "features" blocks are required</a></li> <li><a href=#addsubtract-time>Add/subtract time</a></li> <li><a href=#export-the-contents-of-a-tfvars-file-as-shell-variables>Export the contents of a tfvars file as shell variables</a></li> <li><a href=#further-readings>Further readings</a></li> <li><a href=#sources>Sources</a></li> </ol> <h3 id=tldr>TL;DR<a class=headerlink href=#tldr title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1># Initialization.</span>
terraform init
terraform init -reconfigure

<span class=c1># Validate files.</span>
terraform validate

<span class=c1># Show what would be done.</span>
terraform plan
terraform plan -state <span class=s1>&#39;path/to/file.tfstate&#39;</span> -var-file <span class=s1>&#39;path/to/var.tfvars&#39;</span>
terraform plan -out <span class=s1>&#39;path/to/file.tfstate&#39;</span> -parallelism <span class=s1>&#39;50&#39;</span>

<span class=c1># Make the changes.</span>
terraform apply
terraform apply -auto-approve -backup -parallelism <span class=s1>&#39;25&#39;</span> <span class=s1>&#39;path/to/plan.tfstate&#39;</span>

<span class=c1># Destroy everything.</span>
<span class=c1># `destroy` is an alias of `apply -destroy` and is being deprecated.</span>
terraform destroy
terraform apply -destroy

<span class=c1># Unlock a state file.</span>
terraform force-unlock <span class=s1>&#39;lock_id&#39;</span>

<span class=c1># Format files.</span>
terraform fmt
terraform fmt -check -diff -recursive

<span class=c1># Create a dependency graph.</span>
<span class=c1># Requires `dot` from &#39;graphviz&#39; for image generation.</span>
terraform graph
terraform graph <span class=p>|</span> dot -Tsvg &gt; <span class=s1>&#39;graph.svg&#39;</span>

<span class=c1># Show an existing resource.</span>
terraform state show <span class=s1>&#39;packet_device.worker&#39;</span>
terraform state show <span class=s1>&#39;packet_device.worker[&quot;example&quot;]&#39;</span>
terraform state show <span class=s1>&#39;module.foo.packet_device.worker&#39;</span>

<span class=c1># Recursively update all modules.</span>
<span class=c1># `get` is being deprecated in favour of `init`</span>
terraform get -update -no-color
</code></pre></div> <h3 id=modules>Modules<a class=headerlink href=#modules title="Permanent link">&para;</a></h3> <p>Include a module in the configuration with the <code>module</code> keyword:</p> <div class=highlight><pre><span></span><code>module &quot;remote_vpc_module&quot; {

  # module settings
  source  = &quot;terraform-aws-modules/vpc/aws&quot;  # required
  version = &quot;2.21.0&quot;

  # module variables
  …

}

module &quot;local_vpc_module&quot; {

  # module settings
  source = &quot;./modules/aws_vpc&quot;  # required

  # module variables
  …

}
</code></pre></div> <p>Run <code>terraform init</code> or <code>terraform get</code> to install the modules.<br> Modules are installed in the <code>.terraform/modules</code> directory inside the configuration's working directory; local modules are symlinked from there.</p> <p>When terraform processes a module block, that block will inherit the provider from the enclosing configuration.</p> <p>A module's output can be accessed from the configuration that calls the module through the syntax <code>module.$moduleName.$outputName</code>. Module outputs are read-only attributes.</p> <h4 id=useful-internal-variables>Useful internal variables<a class=headerlink href=#useful-internal-variables title="Permanent link">&para;</a></h4> <table> <thead> <tr> <th>Name</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>path.root</code></td> <td>filesystem path of the root module of the configuration</td> </tr> <tr> <td><code>path.module</code></td> <td>filesystem path of the module where the expression is placed</td> </tr> <tr> <td><code>path.cwd</code></td> <td>filesystem path of the current working directory</td> </tr> <tr> <td><code>terraform.workspace</code></td> <td>name of the currently selected workspace</td> </tr> </tbody> </table> <h3 id=versioning>Versioning<a class=headerlink href=#versioning title="Permanent link">&para;</a></h3> <p>Use a <em>string</em> literal containing one or more conditions separated by commas:</p> <div class=highlight><pre><span></span><code><span class=na>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&gt;= 1.2.0, &lt; 2.0.0&quot;</span><span class=w></span>
<span class=na>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;~&gt; 1.3, &lt; 1.9.5&quot;</span><span class=w></span>
</code></pre></div> <p>Each condition must consist of an operator and a version number. The available operators are as follow:</p> <table> <thead> <tr> <th>Operator</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>=</code> or not present</td> <td>Specify the <strong>exact</strong> version number. It cannot be combined with other conditions.</td> </tr> <tr> <td><code>!=</code></td> <td>Exclude the <strong>exact</strong> version number.</td> </tr> <tr> <td><code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code></td> <td>Compare the available versions against the one specified and allow those for which the comparison is true.</td> </tr> <tr> <td><code>~&gt;</code></td> <td>Allow only the <strong>rightmost</strong> version component to be incremented.</td> </tr> </tbody> </table> <h3 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h3> <h4 id=count-vs-for_each><code>count</code> vs <code>for_each</code><a class=headerlink href=#count-vs-for_each title="Permanent link">&para;</a></h4> <p><code>count</code> creates an unordered list of objects, while <code>for_each</code> creates a map.</p> <p><code>count</code> is sensitive to any changes in the list order and this means that if for some reason order of the list is changed terraform will force the replacement of all resources for which the index in the list has changed:</p> <div class=highlight><pre><span></span><code><span class=w>variable &quot;my_list&quot; {</span>
<span class=gd>-  default = [&quot;first&quot;, &quot;second&quot;, &quot;third&quot;]</span><span class=w></span>
<span class=gi>+  default = [&quot;zeroth&quot;, &quot;first&quot;, &quot;second&quot;, &quot;third&quot;]</span><span class=w></span>
<span class=w>}</span>
</code></pre></div> <div class=highlight><pre><span></span><code>Terraform will perform the following actions:

# null_resource.default[0] must be replaced
-/+ resource &quot;null_resource&quot; &quot;default&quot; {
      ~ id       = &quot;4074861383382414527&quot; -&gt; (known after apply)
      ~ triggers = { # forces replacement
            &quot;list_index&quot; = &quot;0&quot;
          ~ &quot;list_value&quot; = &quot;first&quot; -&gt; &quot;zeroth&quot;
        }
    }
…
# null_resource.default[3] will be created
  + resource &quot;null_resource&quot; &quot;default&quot; {
      + id       = (known after apply)
      + triggers = {
          + &quot;list_index&quot; = &quot;3&quot;
          + &quot;list_value&quot; = &quot;third&quot;
        }
    }
</code></pre></div> <h4 id=conditional-creation-of-a-resource>Conditional creation of a resource<a class=headerlink href=#conditional-creation-of-a-resource title="Permanent link">&para;</a></h4> <p>You can conditionally create one or more resources.<br> There are 2 ways to do this:</p> <ul> <li>with <code>count</code>:</li> </ul> <div class=highlight><pre><span></span><code>resource &quot;cloudflare_record&quot; &quot;record&quot; {
  count = var.cloudflare_enabled ? 1 : 0
  …
}
</code></pre></div> <ul> <li>with <code>for_each</code>:</li> </ul> <div class=highlight><pre><span></span><code>resource &quot;cloudflare_record&quot; &quot;record&quot; {
  for_each = length(var.cloudflare_records_map) &gt; 0 ? var.cloudflare_records_map : {}
  …
}
</code></pre></div> <p>Mind the type of object in the line, and the gotchas for each method.</p> <h4 id=force-the-recreation-of-specific-resources>Force the recreation of specific resources<a class=headerlink href=#force-the-recreation-of-specific-resources title="Permanent link">&para;</a></h4> <p>Use the <code>-replace=resource_path</code> option during a <code>plan</code> or <code>apply</code>:</p> <div class=highlight><pre><span></span><code>terraform apply -replace<span class=o>=</span>aws_instance.example
</code></pre></div> <div class=highlight><pre><span></span><code># aws_instance.example will be replaced, as requested
-/+ resource &quot;aws_instance&quot; &quot;example&quot; {
      …
    }
</code></pre></div> <h4 id=error-at-least-1-features-blocks-are-required>Error: at least 1 "features" blocks are required<a class=headerlink href=#error-at-least-1-features-blocks-are-required title="Permanent link">&para;</a></h4> <p>The <code>azurerm</code> provider needs to be configured with at least the following lines:</p> <div class=highlight><pre><span></span><code>provider &quot;azurerm&quot; {
  features {}
}
</code></pre></div> <h4 id=addsubtract-time>Add/subtract time<a class=headerlink href=#addsubtract-time title="Permanent link">&para;</a></h4> <p>Instead of using the <code>timeadd()</code> function, it is advisable to use the <code>time_offset</code> resource:</p> <div class=highlight><pre><span></span><code>resource &quot;time_offset&quot; &quot;one_year_from_now&quot; {
  offset_years = 1
}
resource &quot;azurerm_key_vault_key&quot; &quot;key&quot; {
  expiration_date = time_offset.one_year_from_now.rfc3339
  …
}
</code></pre></div> <h4 id=export-the-contents-of-a-tfvars-file-as-shell-variables>Export the contents of a tfvars file as shell variables<a class=headerlink href=#export-the-contents-of-a-tfvars-file-as-shell-variables title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=c1># As normal shell variables.</span>
<span class=nb>eval</span> <span class=s2>&quot;export </span><span class=k>$(</span>sed -E <span class=s1>&#39;s/[[:blank:]]*//g&#39;</span> file.tfvars<span class=k>)</span><span class=s2>&quot;</span>

<span class=c1># As TF shell variables (TF_VAR_*).</span>
<span class=nb>eval</span> <span class=s2>&quot;export </span><span class=k>$(</span>sed -E <span class=s1>&#39;s/([[:graph:]]+)[[:blank:]]*=[[:blank:]]*([[:graph:]]+)/TF_VAR_\1=\2/&#39;</span> file.tfvars<span class=k>)</span><span class=s2>&quot;</span>
</code></pre></div> <h3 id=further-readings>Further readings<a class=headerlink href=#further-readings title="Permanent link">&para;</a></h3> <ul> <li><a href=https://www.terraform.io/docs/cli/ >CLI Documentation</a></li> <li><a href=https://www.terraform.io/language/providers/requirements#best-practices-for-provider-versions>Providers best practices</a></li> <li><a href=https://www.terraform.io/language/expressions/version-constraints>Version constraints</a></li> <li><a href=https://www.terraform.io/language/expressions/references>References to Named Values</a></li> <li><a href=https://www.terraform.io/cli/config/environment-variables>Environment Variables</a></li> <li><a href=https://www.terraform.io/cli/state/taint>Forcing Re-creation of Resources</a></li> </ul> <h3 id=sources>Sources<a class=headerlink href=#sources title="Permanent link">&para;</a></h3> <ul> <li><a href=https://medium.com/@business_99069/terraform-count-vs-for-each-b7ada2c0b186>for_each vs count</a></li> <li><a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs>Azure Provider</a></li> <li><a href=https://stackoverflow.com/questions/60231309/terraform-conditional-creation-of-a-resource-based-on-a-variable-in-tfvars>Conditional creation of a resource based on a variable in .tfvars</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2022 - Leslie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> with emoji by <a href=https://github.com/twitter/twemoji target=_blank rel=noopener> Twemoji </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.fb4a9340.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.ca5457b8.min.js></script> </body> </html>