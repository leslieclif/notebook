<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Leslie><link href=https://leslieclif.github.io/notebook/learning/docker/docker-notes/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-7.0.3"><title>Docker - Leslie's Online Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/main.1655a90d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.7fa14f5b.min.css><script src=../../../assets/extra.js type=text/javascript></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/extra.css></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#creating-and-using-containers-like-a-boss class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Leslie's Online Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Docker </span> </div> </div> </div> <div class=md-header__options> <div class="md-header-nav__scheme md-header-nav__button md-source__icon md-icon"> <a href=javascript:toggleScheme(); title="Dark mode" class=dark-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg> </a> <a href=javascript:toggleScheme(); title="Light mode" class=light-mode> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg> </a> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://leslieclif.github.io/notebook/ title="Leslie's Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> Leslie's Online Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../developer/ class=md-nav__link> Developer Setup </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> IDE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDE data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> IDE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ide/ class=md-nav__link> IDE Tips and Tricks </a> </li> <li class=md-nav__item> <a href=../../../ide/markdown/ class=md-nav__link> Markdown </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Server <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Server data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Server </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../server/ class=md-nav__link> Server Details </a> </li> <li class=md-nav__item> <a href=../../../server/install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../../server/mobile/ class=md-nav__link> Mobile </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/ class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../k8s/install/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> Learning <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Learning data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Learning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/ class=md-nav__link> Linux </a> </li> <li class=md-nav__item> <a href=../../git/ class=md-nav__link> Git </a> </li> <li class=md-nav__item> <a href=../../python/ class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../vagrant/ class=md-nav__link> Vagrant </a> </li> <li class=md-nav__item> <a href=../../ansible/ class=md-nav__link> Ansible </a> </li> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Terraform </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Docker <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Docker </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#creating-and-using-containers-like-a-boss class=md-nav__link> Creating and Using Containers Like a Boss </a> <nav class=md-nav aria-label="Creating and Using Containers Like a Boss"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#check-our-docker-install-and-config class=md-nav__link> Check Our Docker Install and Config </a> </li> <li class=md-nav__item> <a href=#image-vs-container class=md-nav__link> Image vs. Container </a> </li> <li class=md-nav__item> <a href=#container-vs-vm-its-just-a-process class=md-nav__link> Container VS. VM: It's Just a Process </a> </li> <li class=md-nav__item> <a href=#the-mighty-hub-using-docker-hub-registry-images class=md-nav__link> The Mighty Hub: Using Docker Hub Registry Images </a> </li> <li class=md-nav__item> <a href=#images-and-their-layers-discover-the-image-cache class=md-nav__link> Images and Their Layers: Discover the Image Cache </a> </li> <li class=md-nav__item> <a href=#image-tagging-and-pushing-to-docker-hub class=md-nav__link> Image Tagging and Pushing to Docker Hub </a> </li> <li class=md-nav__item> <a href=#getting-a-shell-inside-containers-no-need-for-ssh class=md-nav__link> Getting a Shell Inside Containers: No Need for SSH </a> </li> <li class=md-nav__item> <a href=#cleaning-docker-images class=md-nav__link> Cleaning Docker images </a> </li> <li class=md-nav__item> <a href=#docker-networks-concepts-for-private-and-public-comms-in-containers class=md-nav__link> Docker Networks: Concepts for Private and Public Comms in Containers </a> </li> <li class=md-nav__item> <a href=#docker-networks-cli-management-of-virtual-networks class=md-nav__link> Docker Networks: CLI Management of Virtual Networks </a> </li> <li class=md-nav__item> <a href=#docker-networks-dns-and-how-containers-find-each-other class=md-nav__link> Docker Networks: DNS and How Containers Find Each Other </a> </li> <li class=md-nav__item> <a href=#dns-round-robin-testing class=md-nav__link> DNS Round Robin Testing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#container-lifetime--persistent-data-volumes-volumes-volumes class=md-nav__link> Container Lifetime &amp; Persistent Data: Volumes, Volumes, Volumes </a> <nav class=md-nav aria-label="Container Lifetime & Persistent Data: Volumes, Volumes, Volumes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#persistent-data-data-volumes class=md-nav__link> Persistent Data: Data Volumes </a> </li> <li class=md-nav__item> <a href=#persistent-data-bind-mounting class=md-nav__link> Persistent Data: Bind Mounting </a> </li> <li class=md-nav__item> <a href=#database-passwords-in-containers class=md-nav__link> Database Passwords in Containers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#making-it-easier-with-docker-compose-the-multi-container-tool class=md-nav__link> Making It Easier with Docker Compose: The Multi-Container Tool </a> <nav class=md-nav aria-label="Making It Easier with Docker Compose: The Multi-Container Tool"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#trying-out-basic-compose-commands class=md-nav__link> Trying Out Basic Compose Commands </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#swarm-intro-and-creating-a-3-node-swarm-cluster class=md-nav__link> Swarm Intro and Creating a 3-Node Swarm Cluster </a> <nav class=md-nav aria-label="Swarm Intro and Creating a 3-Node Swarm Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-swarm-init-what-just-happened class=md-nav__link> docker swarm init: What Just Happened? </a> </li> <li class=md-nav__item> <a href=#create-your-first-service-and-scale-it-locally class=md-nav__link> Create Your First Service and Scale it Locally </a> </li> <li class=md-nav__item> <a href=#creating-a-3-node-swarm-cluster class=md-nav__link> Creating a 3-Node Swarm Cluster </a> </li> <li class=md-nav__item> <a href=#scaling-out-with-overlay-networking class=md-nav__link> Scaling Out with Overlay Networking </a> </li> <li class=md-nav__item> <a href=#scaling-out-with-routing-mesh class=md-nav__link> Scaling Out with Routing Mesh </a> </li> <li class=md-nav__item> <a href=#create-a-multi-service-multi-node-web-app class=md-nav__link> Create a Multi-Service Multi-Node Web App </a> </li> <li class=md-nav__item> <a href=#swarm-stacks-and-production-grade-compose class=md-nav__link> Swarm Stacks and Production Grade Compose </a> </li> <li class=md-nav__item> <a href=#using-secrets-in-swarm-services class=md-nav__link> Using Secrets in Swarm Services </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#swarm-app-lifecycle class=md-nav__link> Swarm App Lifecycle </a> <nav class=md-nav aria-label="Swarm App Lifecycle"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#full-app-lifecycle-dev-build-and-deploy-with-a-single-compose-design class=md-nav__link> Full App Lifecycle: Dev, Build and Deploy With a Single Compose Design </a> </li> <li class=md-nav__item> <a href=#service-updates-changing-things-in-flight class=md-nav__link> Service Updates: Changing Things In Flight </a> </li> <li class=md-nav__item> <a href=#healthchecks-in-dockerfiles class=md-nav__link> Healthchecks in Dockerfiles </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#container-registries-image-storage-and-distribution class=md-nav__link> Container Registries: Image Storage and Distribution </a> <nav class=md-nav aria-label="Container Registries: Image Storage and Distribution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#run-a-private-docker-registry class=md-nav__link> Run a Private Docker Registry </a> </li> <li class=md-nav__item> <a href=#using-docker-registry-with-swarm class=md-nav__link> Using Docker Registry With Swarm </a> </li> <li class=md-nav__item> <a href=#using-docker-in-production class=md-nav__link> Using Docker in Production </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-security class=md-nav__link> Docker Security </a> </li> <li class=md-nav__item> <a href=#docker-context class=md-nav__link> Docker Context </a> </li> <li class=md-nav__item> <a href=#recommendations class=md-nav__link> Recommendations </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../k8s/k8s-notes/ class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Devops data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/ class=md-nav__link> Index </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#creating-and-using-containers-like-a-boss class=md-nav__link> Creating and Using Containers Like a Boss </a> <nav class=md-nav aria-label="Creating and Using Containers Like a Boss"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#check-our-docker-install-and-config class=md-nav__link> Check Our Docker Install and Config </a> </li> <li class=md-nav__item> <a href=#image-vs-container class=md-nav__link> Image vs. Container </a> </li> <li class=md-nav__item> <a href=#container-vs-vm-its-just-a-process class=md-nav__link> Container VS. VM: It's Just a Process </a> </li> <li class=md-nav__item> <a href=#the-mighty-hub-using-docker-hub-registry-images class=md-nav__link> The Mighty Hub: Using Docker Hub Registry Images </a> </li> <li class=md-nav__item> <a href=#images-and-their-layers-discover-the-image-cache class=md-nav__link> Images and Their Layers: Discover the Image Cache </a> </li> <li class=md-nav__item> <a href=#image-tagging-and-pushing-to-docker-hub class=md-nav__link> Image Tagging and Pushing to Docker Hub </a> </li> <li class=md-nav__item> <a href=#getting-a-shell-inside-containers-no-need-for-ssh class=md-nav__link> Getting a Shell Inside Containers: No Need for SSH </a> </li> <li class=md-nav__item> <a href=#cleaning-docker-images class=md-nav__link> Cleaning Docker images </a> </li> <li class=md-nav__item> <a href=#docker-networks-concepts-for-private-and-public-comms-in-containers class=md-nav__link> Docker Networks: Concepts for Private and Public Comms in Containers </a> </li> <li class=md-nav__item> <a href=#docker-networks-cli-management-of-virtual-networks class=md-nav__link> Docker Networks: CLI Management of Virtual Networks </a> </li> <li class=md-nav__item> <a href=#docker-networks-dns-and-how-containers-find-each-other class=md-nav__link> Docker Networks: DNS and How Containers Find Each Other </a> </li> <li class=md-nav__item> <a href=#dns-round-robin-testing class=md-nav__link> DNS Round Robin Testing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#container-lifetime--persistent-data-volumes-volumes-volumes class=md-nav__link> Container Lifetime &amp; Persistent Data: Volumes, Volumes, Volumes </a> <nav class=md-nav aria-label="Container Lifetime & Persistent Data: Volumes, Volumes, Volumes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#persistent-data-data-volumes class=md-nav__link> Persistent Data: Data Volumes </a> </li> <li class=md-nav__item> <a href=#persistent-data-bind-mounting class=md-nav__link> Persistent Data: Bind Mounting </a> </li> <li class=md-nav__item> <a href=#database-passwords-in-containers class=md-nav__link> Database Passwords in Containers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#making-it-easier-with-docker-compose-the-multi-container-tool class=md-nav__link> Making It Easier with Docker Compose: The Multi-Container Tool </a> <nav class=md-nav aria-label="Making It Easier with Docker Compose: The Multi-Container Tool"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#trying-out-basic-compose-commands class=md-nav__link> Trying Out Basic Compose Commands </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#swarm-intro-and-creating-a-3-node-swarm-cluster class=md-nav__link> Swarm Intro and Creating a 3-Node Swarm Cluster </a> <nav class=md-nav aria-label="Swarm Intro and Creating a 3-Node Swarm Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-swarm-init-what-just-happened class=md-nav__link> docker swarm init: What Just Happened? </a> </li> <li class=md-nav__item> <a href=#create-your-first-service-and-scale-it-locally class=md-nav__link> Create Your First Service and Scale it Locally </a> </li> <li class=md-nav__item> <a href=#creating-a-3-node-swarm-cluster class=md-nav__link> Creating a 3-Node Swarm Cluster </a> </li> <li class=md-nav__item> <a href=#scaling-out-with-overlay-networking class=md-nav__link> Scaling Out with Overlay Networking </a> </li> <li class=md-nav__item> <a href=#scaling-out-with-routing-mesh class=md-nav__link> Scaling Out with Routing Mesh </a> </li> <li class=md-nav__item> <a href=#create-a-multi-service-multi-node-web-app class=md-nav__link> Create a Multi-Service Multi-Node Web App </a> </li> <li class=md-nav__item> <a href=#swarm-stacks-and-production-grade-compose class=md-nav__link> Swarm Stacks and Production Grade Compose </a> </li> <li class=md-nav__item> <a href=#using-secrets-in-swarm-services class=md-nav__link> Using Secrets in Swarm Services </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#swarm-app-lifecycle class=md-nav__link> Swarm App Lifecycle </a> <nav class=md-nav aria-label="Swarm App Lifecycle"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#full-app-lifecycle-dev-build-and-deploy-with-a-single-compose-design class=md-nav__link> Full App Lifecycle: Dev, Build and Deploy With a Single Compose Design </a> </li> <li class=md-nav__item> <a href=#service-updates-changing-things-in-flight class=md-nav__link> Service Updates: Changing Things In Flight </a> </li> <li class=md-nav__item> <a href=#healthchecks-in-dockerfiles class=md-nav__link> Healthchecks in Dockerfiles </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#container-registries-image-storage-and-distribution class=md-nav__link> Container Registries: Image Storage and Distribution </a> <nav class=md-nav aria-label="Container Registries: Image Storage and Distribution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#run-a-private-docker-registry class=md-nav__link> Run a Private Docker Registry </a> </li> <li class=md-nav__item> <a href=#using-docker-registry-with-swarm class=md-nav__link> Using Docker Registry With Swarm </a> </li> <li class=md-nav__item> <a href=#using-docker-in-production class=md-nav__link> Using Docker in Production </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-security class=md-nav__link> Docker Security </a> </li> <li class=md-nav__item> <a href=#docker-context class=md-nav__link> Docker Context </a> </li> <li class=md-nav__item> <a href=#recommendations class=md-nav__link> Recommendations </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Docker</h1> <details class=note open=open><summary>Important Links</summary><details class=summary><summary>Docker Projects</summary><ul> <li><a href=https://github.com/veggiemonk/awesome-docker#hosting-images-registries>Master list of Docker Resources and Projects</a></li> <li><a href=http://training.play-with-docker.com/ >Play With Docker</a>, a great resource for web-based docker testing and also has a library of labs built by Docker Captains and others, and supported by Docker Inc. </li> <li><a href=http://labs.play-with-docker.com/ >Play With Docker Labs</a></li> <li><a href=https://docs.docker.com/registry/recipes/ >DockerHub Recipes</a></li> <li><a href=https://cloud.docker.com>Docker Cloud: CI/CD and Server Ops</a></li> <li><a href=https://blog.alexellis.io/tag/raspberry-pi/ >Docker and Pi Projects</a></li> </ul> </details> <details class=summary><summary>Docker Training Content</summary><ul> <li><a href=https://github.com/bretfisher/udemy-docker-mastery>Docker Mastery</a></li> <li><a href=https://podcast.bretfisher.com/episodes>Bret's Podcast</a></li> <li><a href=https://www.youtube.com/channel/UC0NErq0RhP51iXx64ZmyVfg>Bret's Youtube</a></li> <li><a href=https://www.bretfisher.com/shell/ >Docker Shell Config</a></li> <li><a href="https://www.youtube.com/watch?v=yeZqoh3-cME">Docker Devops</a></li> <li><a href=https://github.com/mikegcoleman/docker101/blob/master/Docker_eBook_Jan_2017.pdf>Containers vs VM ebook</a></li> </ul> </details> <details class=summary><summary>Docker Refernce</summary><ul> <li><a href=https://www.bretfisher.com/docker-certified-associate/ >Docker Certificated Associate</a></li> <li><a href=https://docs.docker.com/engine/reference/builder/ >Dockerfile Reference</a></li> <li><a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ >Dockerfile Best Practice</a></li> <li><a href=https://docs.docker.com/config/formatting/ >Formatting Docker CLI Output</a></li> <li><a href=https://github.com/moby/moby/blob/master/image/spec/v1.md>Docker Image</a></li> <li><a href=https://docs.docker.com/registry/configuration/ >Docker Registry Config</a></li> <li><a href=https://docs.docker.com/registry/garbage-collection/ >Docker Registry Garbage Collection</a></li> <li><a href=https://docs.docker.com/registry/recipes/mirror/ >Docker Registry as cache</a></li> <li><a href=https://docs.docker.com/storage/ >Docker Storage</a></li> <li><a href=https://docs.docker.com/engine/swarm/secrets/ >Docker secrets</a></li> <li><a href=https://kubernetes.io/docs/reference/kubectl/docker-cli-to-kubectl/ >Docker CLI to kubectl</a></li> </ul> </details> <details class=summary><summary>Software Design</summary><ul> <li><a href=https://www.oreilly.com/radar/an-introduction-to-immutable-infrastructure/ >Immutable Software</a></li> <li><a href=https://12factor.net/ >12 factor App</a></li> <li><a href=https://medium.com/@kelseyhightower/12-fractured-apps-1080c73d481c#.cjvkgw4b3>12 Fractured Apps</a></li> <li><a href=https://github.com/kamranahmedse/developer-roadmap#devops-roadmap>Devops Roadmap</a></li> </ul> </details> <details class=summary><summary>Docker Best Practises</summary><ul> <li><a href=https://github.com/BretFisher/node-docker-good-defaults>Docker Best practise inside a code repo</a></li> <li><a href=https://docs.docker.com/engine/reference/builder/#healthcheck>Healthcheck in Dockerfile</a></li> </ul> </details> </details> <div class=highlight><pre><span></span><code>Starting container process caused <span class=s2>&quot;exec: \&quot;ping\&quot;: executable file not found in </span><span class=nv>$PATH</span><span class=s2>&quot;</span>: unknown

apt-get update <span class=o>&amp;&amp;</span> apt-get install -y iputils-ping
</code></pre></div> <div class=highlight><pre><span></span><code>Starting mysql container and running ps causes <span class=s2>&quot;ps: command not found&quot;</span>
apt-get update <span class=o>&amp;&amp;</span> apt-get install procps
</code></pre></div> <h2 id=creating-and-using-containers-like-a-boss>Creating and Using Containers Like a Boss<a class=headerlink href=#creating-and-using-containers-like-a-boss title="Permanent link">&para;</a></h2> <h3 id=check-our-docker-install-and-config>Check Our Docker Install and Config<a class=headerlink href=#check-our-docker-install-and-config title="Permanent link">&para;</a></h3> <ul> <li><code>docker version</code> - verified cli can talk to engine</li> <li><code>docker info</code> - most config values of engine</li> </ul> <h3 id=image-vs-container>Image vs. Container<a class=headerlink href=#image-vs-container title="Permanent link">&para;</a></h3> <ul> <li>An Image is the application we want to run</li> <li>A Container is an instance of that image running as a process</li> <li>You can have many containers running off the same image</li> <li>Docker's default image "registry" is called <strong>Docker Hub</strong></li> </ul> <div class=highlight><pre><span></span><code>docker container run --publish <span class=m>80</span>:80 --detach --name webhost nginx
docker container run -it # start new container interactively
docker container <span class=nb>exec</span> -it # run additional <span class=nb>command</span> <span class=k>in</span> existing container
docker container ls -a
docker container logs webhost
</code></pre></div> <h3 id=container-vs-vm-its-just-a-process>Container VS. VM: It's Just a Process<a class=headerlink href=#container-vs-vm-its-just-a-process title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker run --name mongo -d mongo
docker container top - process list <span class=k>in</span> one container
docker stop mongo
docker ps
docker start mongo
docker container inspect - details of one container config
docker container stats - performance stats <span class=k>for</span> all containers
</code></pre></div> <h3 id=the-mighty-hub-using-docker-hub-registry-images>The Mighty Hub: Using Docker Hub Registry Images<a class=headerlink href=#the-mighty-hub-using-docker-hub-registry-images title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker pull nginx
docker image ls
</code></pre></div> <h3 id=images-and-their-layers-discover-the-image-cache>Images and Their Layers: Discover the Image Cache<a class=headerlink href=#images-and-their-layers-discover-the-image-cache title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker <span class=nb>history</span> nginx:latest
docker image inspect nginx
</code></pre></div> <h3 id=image-tagging-and-pushing-to-docker-hub>Image Tagging and Pushing to Docker Hub<a class=headerlink href=#image-tagging-and-pushing-to-docker-hub title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker pull nginx:latest
docker image ls
docker image tag nginx bretfisher/nginx
docker login
cat .docker/config.json
docker image push bretfisher/nginx
docker image push bretfisher/nginx bretfisher/nginx:testing
</code></pre></div> <h3 id=getting-a-shell-inside-containers-no-need-for-ssh>Getting a Shell Inside Containers: No Need for SSH<a class=headerlink href=#getting-a-shell-inside-containers-no-need-for-ssh title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker container <span class=nb>exec</span> -it mysql -- bash
docker container run -it alpine -- bash
docker container run -it alpine -- sh
</code></pre></div> <h3 id=cleaning-docker-images>Cleaning Docker images<a class=headerlink href=#cleaning-docker-images title="Permanent link">&para;</a></h3> <ul> <li>Use <code>docker system df</code> to see space usage. </li> <li><code>docker image prune</code> to clean up just "dangling" images.</li> <li>The big one is usually <code>docker image prune -a</code> which will remove all images you're not using. </li> <li><code>docker volume prune</code> to remove unused volumes</li> <li><code>docker system prune</code> will clean up everything (Nuke everything that is not used currently).</li> <li><code>docker system prune -a</code> wipe everything.</li> </ul> <h3 id=docker-networks-concepts-for-private-and-public-comms-in-containers>Docker Networks: Concepts for Private and Public Comms in Containers<a class=headerlink href=#docker-networks-concepts-for-private-and-public-comms-in-containers title="Permanent link">&para;</a></h3> <ul> <li>Each container connected to a private virtual network "bridge"</li> <li>Each virtual network routes through NAT firewall on host IP</li> <li>All containers on a virtual network can talk to each other without -p</li> <li>Best practice is to create a new virtual network for each app:</li> <li>network "my_web_app" for mysql and php/apache containers</li> <li>network "my_api" for mongo and nodejs containers <div class=highlight><pre><span></span><code>docker container run -p <span class=m>80</span>:80 --name webhost -d nginx
docker container port webhost
docker container inspect --format <span class=s1>&#39;{{ .NetworkSettings.IPAddress }}&#39;</span> webhost
</code></pre></div></li> </ul> <h3 id=docker-networks-cli-management-of-virtual-networks>Docker Networks: CLI Management of Virtual Networks<a class=headerlink href=#docker-networks-cli-management-of-virtual-networks title="Permanent link">&para;</a></h3> <ul> <li>Show networks <code>docker network ls</code></li> <li>Inspect a network <code>docker network inspect</code></li> <li>Create a network <code>docker network create --driver</code></li> <li>Attach a network to container <code>docker network connect</code></li> <li>Detach a network from container <code>docker network disconnect</code> <div class=highlight><pre><span></span><code>docker network ls
docker network inspect bridge
docker network create my_app_net
docker container run -d --name new_nginx --network my_app_net nginx
docker network inspect my_app_net
docker network connect &lt;new network id&gt; &lt;container id&gt;
docker container disconnect &lt;new network id&gt; &lt;container id&gt;
</code></pre></div></li> </ul> <h3 id=docker-networks-dns-and-how-containers-find-each-other>Docker Networks: DNS and How Containers Find Each Other<a class=headerlink href=#docker-networks-dns-and-how-containers-find-each-other title="Permanent link">&para;</a></h3> <ul> <li>Create your apps so frontend/backend sit on same Docker network</li> <li>Their inter-communication never leaves host</li> <li>All externally exposed ports closed by default</li> <li>You must manually expose via -p , which is better default security!</li> <li>Containers shouldn't rely on IP's for inter-communication</li> <li>DNS for friendly names is built-in if you use custom networks <div class=highlight><pre><span></span><code>docker container run -d --name my_nginx --network my_app_net nginx
docker container <span class=nb>exec</span> -it my_nginx ping new_nginx
docker container <span class=nb>exec</span> -it new_nginx ping my_nginx
</code></pre></div></li> </ul> <h3 id=dns-round-robin-testing>DNS Round Robin Testing<a class=headerlink href=#dns-round-robin-testing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker network create dude
docker container run -d --net dude --net-alias search elasticsearch:2
docker container ls
docker container run --rm -- net dude alpine nslookup search
docker container run --rm --net dude centos curl -s search:9200
</code></pre></div> <h2 id=container-lifetime--persistent-data-volumes-volumes-volumes>Container Lifetime &amp; Persistent Data: Volumes, Volumes, Volumes<a class=headerlink href=#container-lifetime--persistent-data-volumes-volumes-volumes title="Permanent link">&para;</a></h2> <h3 id=persistent-data-data-volumes>Persistent Data: Data Volumes<a class=headerlink href=#persistent-data-data-volumes title="Permanent link">&para;</a></h3> <ul> <li>Containers are usually immutable and ephemeral</li> <li>"immutable infrastructure": only re-deploy containers, never change</li> <li>This is the ideal scenario, but what about databases, or unique data?</li> <li>Docker gives us features to ensure these "separation of concerns"</li> <li>This is known as "persistent data"</li> <li>Two ways: Volumes and Bind Mounts</li> <li><em>Volumes</em>: make special location outside of container UFS</li> <li><em>Bind Mounts</em>: link container path to host path <div class=highlight><pre><span></span><code>docker container run -d --name mysql -e <span class=nv>MYSQL_ALLOW_EMPTY_PASSWORD</span><span class=o>=</span>True -v mysql-db:/var/lib/mysql mysql
docker volume ls
docker volume inspect mysql-db
</code></pre></div></li> </ul> <h3 id=persistent-data-bind-mounting>Persistent Data: Bind Mounting<a class=headerlink href=#persistent-data-bind-mounting title="Permanent link">&para;</a></h3> <ul> <li>Used for local development</li> <li>Usecase: When you are changing files on laptop which you want to serve in the app</li> <li>It can be run only during <code>docker run</code> as there is no explicit volume command in the dockerfile</li> <li>the volume will be mounted in the working directory of the container <div class=highlight><pre><span></span><code>docker container run -d --name nginx -p <span class=m>80</span>:80 -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:/usr/share/nginx/html nginx
docker container <span class=nb>exec</span> -it nginx -- bash
<span class=nb>cd</span> /usr/share/nginx/html <span class=o>&amp;&amp;</span> ls -la
</code></pre></div></li> <li>docker log streaming <div class=highlight><pre><span></span><code>docker container logs -f &lt;container name&gt;
</code></pre></div></li> </ul> <h3 id=database-passwords-in-containers>Database Passwords in Containers<a class=headerlink href=#database-passwords-in-containers title="Permanent link">&para;</a></h3> <ul> <li>When running postgres now, you'll need to either set a password, or tell it to allow any connection (which was the default before this change). -you need to either set a password with the environment variable: <code>POSTGRES_PASSWORD=mypasswd</code></li> <li>Or tell it to ignore passwords with the environment variable: <code>POSTGRES_HOST_AUTH_METHOD=trust</code></li> </ul> <h2 id=making-it-easier-with-docker-compose-the-multi-container-tool>Making It Easier with Docker Compose: The Multi-Container Tool<a class=headerlink href=#making-it-easier-with-docker-compose-the-multi-container-tool title="Permanent link">&para;</a></h2> <ul> <li>Why: configure relationships between containers</li> <li>Why: save our docker container run settings in easy-to-read file</li> <li>Why: create one-liner developer environment startups</li> <li>YAML-formatted file that describes our solution options for: containers, networks, volumes</li> <li>A CLI tool <code>docker-compose</code> used for local dev/test automation with those YAML files</li> <li><code>docker-compose.yml</code> is default filename, but any can be used with <code>docker-compose -f</code></li> <li>Not a production-grade tool but ideal for local development and test</li> <li>Two most common commands are: <div class=highlight><pre><span></span><code>docker-compose up # setup volumes/networks and start all containers
docker-compose down # stop all containers and remove cont/vol/net
</code></pre></div></li> </ul> <h3 id=trying-out-basic-compose-commands>Trying Out Basic Compose Commands<a class=headerlink href=#trying-out-basic-compose-commands title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker-compose up
docker-compose up -d  # Running compose <span class=k>in</span> bacground
docker-compose down
docker-compose down -v --rmi local/all # Removes images and volumes
<span class=c># Compose operations</span>
docker-compose logs
docker-compose ps
docker-compose top

docker-compose build # Build images or
docker-compose up --build
</code></pre></div> <h2 id=swarm-intro-and-creating-a-3-node-swarm-cluster>Swarm Intro and Creating a 3-Node Swarm Cluster<a class=headerlink href=#swarm-intro-and-creating-a-3-node-swarm-cluster title="Permanent link">&para;</a></h2> <ul> <li>Swarm Mode is a clustering solution built inside Docker</li> <li>Not enabled by default</li> </ul> <h3 id=docker-swarm-init-what-just-happened>docker swarm init: What Just Happened?<a class=headerlink href=#docker-swarm-init-what-just-happened title="Permanent link">&para;</a></h3> <ul> <li>Lots of PKI and security automation</li> <li>Root Signing Certificate created for our Swarm</li> <li>Certificate is issued for first Manager node</li> <li>Join tokens are created</li> <li>Raft database created to store root CA, configs and secrets</li> <li>Encrypted by default on disk (1.13+)</li> <li>No need for another key/value system to hold orchestration/secrets</li> <li>Replicates logs amongst Managers via mutual TLS in "control plane"</li> </ul> <h3 id=create-your-first-service-and-scale-it-locally>Create Your First Service and Scale it Locally<a class=headerlink href=#create-your-first-service-and-scale-it-locally title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker info # swarm is down by default
docker swarm init # start swarm
docker node ls
docker service create alpine ping <span class=m>8</span>.8.8.8 # creates service frosty_newton
docker service ls
docker service ps frosty_newton
docker container ls
docker service update frosty_newton --replicas <span class=m>3</span> # creates <span class=m>3</span> replicas
docker service ls
docker service rm frosty_newton # deletes the service
docker service ls
docker container ls
</code></pre></div> <h3 id=creating-a-3-node-swarm-cluster>Creating a 3-Node Swarm Cluster<a class=headerlink href=#creating-a-3-node-swarm-cluster title="Permanent link">&para;</a></h3> <p><em>docker-machine + VirtualBox</em> - Free and runs locally, but requires a machine with 8GB memory <div class=highlight><pre><span></span><code>docker-machine create node1
docker-machine ssh node1
docker-machine env node1
</code></pre></div> <div class=highlight><pre><span></span><code>docker swarm init
docker swarm init --advertise-addr node1
docker node ls
docker node update --role manager node2 # Update role to existing node
docker swarm join-token manager # Shows join token <span class=k>for</span> manager role
docker service create --replicas <span class=m>3</span> alpine ping <span class=m>8</span>.8.8.8 # Creates service with <span class=m>3</span> replicas and starts ping process
</code></pre></div> <div class=highlight><pre><span></span><code>docker service ls
docker service ps &lt;service name&gt;
docker node ps
docker node ps node2
</code></pre></div></p> <h3 id=scaling-out-with-overlay-networking>Scaling Out with Overlay Networking<a class=headerlink href=#scaling-out-with-overlay-networking title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c># Create Backend network</span>
docker network create --driver overlay mydrupal
docker network ls
docker service create --name psql --netowrk mydrupal -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>mypass postgres
docker service ls
docker service ps psql
docker container logs psql &lt;container name&gt;
<span class=c># Create Frontend network</span>
docker service create --name drupal --network mydrupal -p <span class=m>80</span>:80 drupal
docker service inspect drupal
</code></pre></div> <h3 id=scaling-out-with-routing-mesh>Scaling Out with Routing Mesh<a class=headerlink href=#scaling-out-with-routing-mesh title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker service create --name search --replicas <span class=m>3</span> -p <span class=m>9200</span>:9200 elasticsearch:2
docker service ps search
</code></pre></div> <h3 id=create-a-multi-service-multi-node-web-app>Create a Multi-Service Multi-Node Web App<a class=headerlink href=#create-a-multi-service-multi-node-web-app title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker network create -d overlay backend
docker network create -d overlay frontend
docker service create --name vote -p <span class=m>80</span>:80 --network frontend <span class=se>\</span>
-- replica <span class=m>2</span> dockersamples/examplevotingapp_vote:before
docker service create --name redis --network frontend <span class=se>\</span>
--replica <span class=m>1</span> redis:3.2
docker service create --name worker --network frontend --network backend dockersamples/examplevotingapp_worker
docker service create --name db --network backend <span class=se>\</span>
--mount <span class=nv>type</span><span class=o>=</span>volume,source<span class=o>=</span>db-data,target<span class=o>=</span>/var/lib/postgresql/data postgres:9.4 
docker service create --name result --network backend -p <span class=m>5001</span>:80 COPY INFO
docker service ls
docker service logs worker
</code></pre></div> <h3 id=swarm-stacks-and-production-grade-compose>Swarm Stacks and Production Grade Compose<a class=headerlink href=#swarm-stacks-and-production-grade-compose title="Permanent link">&para;</a></h3> <ul> <li>Docker adds a new layer of abstraction to Swarm called Stacks</li> <li>Stacks accept Compose files as their declarative definition for services, networks, and volumes</li> <li>We use <code>docker stack deploy</code> rather then <code>docker service create</code></li> <li>Stacks manages all those objects for us, including overlay network per stack. Adds stack name to start of their name</li> <li>Compose now ignores <code>deploy:</code>, Swarm ignores <code>build:</code> <div class=highlight><pre><span></span><code>docker stack deploy -c example-voting-app-stack.yml voteapp
docker stack ls
docker stack services voteapp
docker stack ps voteapp
</code></pre></div></li> </ul> <h3 id=using-secrets-in-swarm-services>Using Secrets in Swarm Services<a class=headerlink href=#using-secrets-in-swarm-services title="Permanent link">&para;</a></h3> <p>What is a Secret? - Usernames and passwords - TLS certificates and keys - SSH keys - Any data you would prefer not be "on front page of news" <div class=highlight><pre><span></span><code>docker secret create psql_usr psql_usr.txt
<span class=nb>echo</span> <span class=s2>&quot;myDBpassWORD&quot;</span> <span class=p>|</span> docker secret create psql_pass - TAB COMPLETION
docker secret inspect psql_usr
docker service create --name psql --secret psql_user <span class=se>\</span>
--secret psql_pass -e <span class=nv>POSTGRES_PASSWORD_FILE</span><span class=o>=</span>/run/secrets/psql_pass <span class=se>\</span>
-e <span class=nv>POSTGRES_USER_FILE</span><span class=o>=</span>/run/secrets/psql_user postgres
docker <span class=nb>exec</span> -it &lt;container name&gt; bash
cat /run/secrets/psql_user
</code></pre></div></p> <h2 id=swarm-app-lifecycle>Swarm App Lifecycle<a class=headerlink href=#swarm-app-lifecycle title="Permanent link">&para;</a></h2> <h3 id=full-app-lifecycle-dev-build-and-deploy-with-a-single-compose-design>Full App Lifecycle: Dev, Build and Deploy With a Single Compose Design<a class=headerlink href=#full-app-lifecycle-dev-build-and-deploy-with-a-single-compose-design title="Permanent link">&para;</a></h3> <p>Single set of Compose files for: - Local <code>docker-compose up</code> development environment - Remote <code>docker-compose up</code> CI environment - Remote <code>docker stack deploy</code> production environment <div class=highlight><pre><span></span><code>docker-compose -f docker-compose.yml -f docker-compose.test.yml up -d
docker-compose -f docker-compose.yml -f docker-compose.prod.yml config
</code></pre></div></p> <h3 id=service-updates-changing-things-in-flight>Service Updates: Changing Things In Flight<a class=headerlink href=#service-updates-changing-things-in-flight title="Permanent link">&para;</a></h3> <ul> <li>Provides rolling replacement of tasks/containers in a service</li> <li>Limits downtime (be careful with "prevents" downtime)</li> <li>Will replace containers for most changes</li> <li>Has many, many cli options to control the update</li> <li>Create options will usually change, adding -add or -rm to them</li> <li>Includes rollback and healthcheck options</li> <li>Also has scale &amp; rollback subcommand for quicker access <code>docker service scale web=4</code> and <code>docker service rollback web</code></li> <li>Just update the image used to a newer version <code>docker service update --image myapp:1.2.1 &lt;servicename&gt;</code></li> <li>Adding an environment variable and remove a port <code>docker service update --env-add NODE_ENV=production --publish-rm 8080</code></li> <li>Change number of replicas of two services <code>docker service scale web=8 api=6</code> <div class=highlight><pre><span></span><code>docker service create -p <span class=m>8088</span>:80 --name web nginx:1.13.7
docker service scale <span class=nv>web</span><span class=o>=</span><span class=m>5</span>
docker service update --image nginx:1.13.6 web
docker service update --publish-rm <span class=m>8088</span> --publish-add <span class=m>9090</span>:80
docker service update --force web # forces rebalancing of the service without changing anything
docker service rm web
</code></pre></div></li> </ul> <h3 id=healthchecks-in-dockerfiles>Healthchecks in Dockerfiles<a class=headerlink href=#healthchecks-in-dockerfiles title="Permanent link">&para;</a></h3> <ul> <li>HEALTHCHECK was added in 1.12</li> <li>Supported in Dockerfile, Compose YAML, docker run, and Swarm Services</li> <li>Docker engine will exec's the command in the container (e.g. curl localhost)</li> <li>It expects exit 0 (OK) or exit 1 (Error)</li> <li>Three container states: starting, healthy, unhealthy</li> <li>Much better then "is binary still running?"</li> <li>Options for healthcheck command <div class=highlight><pre><span></span><code>--interval<span class=o>=</span>DURATION <span class=o>(</span>default: 30s<span class=o>)</span>
--timeout<span class=o>=</span>DURATION <span class=o>(</span>default: 30s<span class=o>)</span>
--start-period<span class=o>=</span>DURATION <span class=o>(</span>default: 0s<span class=o>)</span> <span class=o>(</span><span class=m>17</span>.09+<span class=o>)</span>
--retries<span class=o>=</span>N <span class=o>(</span>default: <span class=m>3</span><span class=o>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code>docker container run --name p2 -d --health-cmd<span class=o>=</span><span class=s2>&quot;pg_isready \</span>
<span class=s2>-U postgres || exit 1&quot;</span> postgres
docker service create --name p2 --health-cmd<span class=o>=</span><span class=s2>&quot;pg_isready \</span>
<span class=s2>-U postgres || exit 1&quot;</span> postgres
</code></pre></div></li> </ul> <h2 id=container-registries-image-storage-and-distribution>Container Registries: Image Storage and Distribution<a class=headerlink href=#container-registries-image-storage-and-distribution title="Permanent link">&para;</a></h2> <h3 id=run-a-private-docker-registry>Run a Private Docker Registry<a class=headerlink href=#run-a-private-docker-registry title="Permanent link">&para;</a></h3> <ul> <li>Secure your Registry with TLS</li> <li>Storage cleanup via Garbage Collection</li> <li>Enable Hub caching via "&ndash;registry-mirror"</li> </ul> <div class=highlight><pre><span></span><code><span class=c># Run the registry image</span>
docker container run -d -p <span class=m>5000</span>:5000 --name registry registry
<span class=c># Re-tag an existing image and push it to your new registry</span>
docker pull hello-world
docker run hello-world
docker tag hello-world <span class=m>127</span>.0.0.1:5000/hello-world
docker push <span class=m>127</span>.0.0.1:5000/hello-world
<span class=c># Remove that image from local cache and pull it from new registry</span>
docker image remove hello-world
docker image remove <span class=m>127</span>.0.0.1:5000/hello-world
docker pull <span class=m>127</span>.0.0.1:5000/hello-world:latest
<span class=c># Re-create registry using a bind mount and see how it stores data</span>
docker container <span class=nb>kill</span> registry
docker container rm registry
docker container run -d -p <span class=m>5000</span>:5000 --name registry -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/registry-data:/var/lib/registry registry
</code></pre></div> <h3 id=using-docker-registry-with-swarm>Using Docker Registry With Swarm<a class=headerlink href=#using-docker-registry-with-swarm title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>docker node ls
docker service create --name registry --publish <span class=m>5000</span>:5000 registry
docker service ps registry
docker pull nginx
docker tag nginx <span class=m>127</span>.0.0.1:5000/nginx
docker push <span class=m>127</span>.0.0.1:5000/nginx
docker service create --name nginx -p <span class=m>80</span>:80 --replicas <span class=m>5</span> --detach<span class=o>=</span><span class=nb>false</span> <span class=m>127</span>.0.0.1:5000/nginx
docker service ps nginx
</code></pre></div> <h3 id=using-docker-in-production>Using Docker in Production<a class=headerlink href=#using-docker-in-production title="Permanent link">&para;</a></h3> <ul> <li>Focus on Dockerfiles first. </li> <li>Study ENTRYPOINT of Hub official images. Use it for config of images before CMD is executed.</li> <li>use ENTRYPOINT to set default values for all environments and then overide using ENV values.</li> <li><a href=http://www.johnzaccone.io/entrypoint-vs-cmd-back-to-basics/ >EntryPoint vs CMD</a></li> <li>FROM official distros.</li> <li>Make it == start, log all things in stdout/stderr, documented in file, lean and scale.</li> <li>Using SaaS for - Image Registry, Logging, Monitoring, Look at CNCF Landscape</li> <li>Using Layer 7 Reverse Proxy if port 80 and 443 are used by multiple apps</li> </ul> <h2 id=docker-security>Docker Security<a class=headerlink href=#docker-security title="Permanent link">&para;</a></h2> <ul> <li><a href=https://github.com/BretFisher/ama/issues/17>Docker Security Checklist</a></li> <li><a href=https://docs.docker.com/engine/security/ >Docker Engine Security</a></li> <li><a href=https://sysdig.com/blog/20-docker-security-tools/ >Docker Security Tools</a></li> <li><a href=https://docs.docker.com/engine/security/seccomp/ >Seccomp</a></li> <li><a href=https://docs.docker.com/engine/security/apparmor/ >App Armor</a></li> <li><a href=https://github.com/docker/docker-bench-security>Docker Bench</a></li> <li><a href=https://www.cisecurity.org/benchmark/docker/ >CIS Docker checklist</a></li> <li>Running Docker as non root user <div class=highlight><pre><span></span><code><span class=c># Creating non root user in alpine</span>
<span class=k>RUN</span> addgroup -g <span class=m>1000</span> node <span class=se>\</span>
    <span class=o>&amp;&amp;</span> adduser -u <span class=m>1000</span> -G node -s /bin/sh -D node
<span class=c># Creating non root user in stretch</span>
<span class=k>RUN</span> groupadd --gid <span class=m>1000</span> node <span class=se>\</span>
  <span class=o>&amp;&amp;</span> useradd --uid <span class=m>1000</span> --gid node --shell /bin/bash --create-home node
</code></pre></div></li> <li>Sample Dockerfile with <a href=https://github.com/BretFisher/dockercon19/blob/master/1.Dockerfile>USER</a></li> <li><a href=https://integratedcode.us/2015/10/13/user-namespaces-have-arrived-in-docker/ >User Namespaces</a></li> <li><a href=https://www.paloaltonetworks.com/prisma/cloud>Shift Left Security</a></li> <li><a href=https://github.com/aquasecurity/trivy#os-packages>Trivy - Image Scanning</a></li> <li><a href=https://sysdig.com/opensource/falco/ >Sysdig Falco</a></li> <li><a href=https://docs.docker.com/engine/security/apparmor/ >Appamror Profiles</a></li> <li><a href=https://docs.docker.com/engine/security/seccomp/ >Seccomp Profile</a></li> </ul> <h2 id=docker-context>Docker Context<a class=headerlink href=#docker-context title="Permanent link">&para;</a></h2> <ul> <li>Start a node on paly with Docker</li> <li>Copy the IP of the node</li> <li>Set the Docker Context with the Host Name of the node and port 2375</li> <li>Contexts are created in the home folder of user called <code>.docker/context</code></li> </ul> <div class=highlight><pre><span></span><code>docker context create --docker <span class=s2>&quot;host=tcp://&lt;Host Name&gt;:2375&quot;</span> &lt;context-name&gt;
docker context ls
docker context use &lt;context-name&gt;
docker ps # Should show the new context of play with docker
<span class=c># Overriding Context to default in commandline</span>
docker -c default ps
docker -c &lt;context-name&gt; ps
<span class=c># Looping through all the context and executing ps</span>
<span class=k>for</span> c <span class=k>in</span> <span class=sb>`</span>docker context ls -q<span class=sb>`</span><span class=p>;</span> <span class=k>do</span> <span class=sb>`</span>docker -c <span class=nv>$c</span> ps<span class=sb>`</span><span class=p>;</span> <span class=k>done</span>
<span class=c># Creates the image in all context</span>
<span class=k>for</span> c <span class=k>in</span> <span class=sb>`</span>docker context ls -q<span class=sb>`</span><span class=p>;</span> <span class=k>do</span> <span class=sb>`</span>docker -c <span class=nv>$c</span> run hello-world<span class=sb>`</span><span class=p>;</span> <span class=k>done</span>
</code></pre></div> <h2 id=recommendations>Recommendations<a class=headerlink href=#recommendations title="Permanent link">&para;</a></h2> <ul> <li>To change permissions on file system (chown or chmod) use a Entrypoint script. Look up to official images for examples for Entrypoint</li> <li>One App or Website use one container, specially if using an orchestrator like K8s or Docker Swarm. Scaling is also a benefit due to one-one relationship.</li> <li><a href=https://serverfault.com/questions/916941/configuring-docker-to-not-use-the-172-17-0-0-range/942176#942176>Changing Docker IP range</a></li> <li>Use Cloud DB as service instead of in containers</li> <li>Run one process per container</li> <li>Strict Separation of Config from Code. Use Env variables to achieve this. <a href=https://www.oreilly.com/content/3-docker-compose-features-for-improving-team-development-workflow/ >Using Development workflow in Compose</a></li> <li>Write all the ENV variables at the top of Dockerfile</li> <li>Using Env variables in <a href=https://github.com/BretFisher/php-docker-good-defaults/blob/master/Dockerfile>Dockerfile</a></li> <li>Override Env variables in <a href=https://github.com/BretFisher/php-docker-good-defaults/blob/master/docker-compose.yml>Docker Compose file</a> say for Dev testing</li> <li>Using Env variables in <a href=https://github.com/BretFisher/php-docker-good-defaults/blob/master/docker-php-entrypoint>Docker Entrypoint</a> to write into Application config files during start up.</li> <li>Secrets and Application specific config goes into specific ENV var blocks. Tis can be changed. Defaults or data specific to SERVER or LANGUAGE goes to another ENV block and can be kept static. This avoids them being set for each ENV.</li> <li>Encrypting traffic for local development use <a href=https://letsencrypt.org/docs/certificates-for-localhost/ >Lets Encrypt</a> ad store them in .cert folder in Home Directory.</li> <li>Encrypting traffic for production use Lets Encrypt and maybe <a href=https://traefik.io/ >Traefik</a> as Front proxy. See <a href=https://github.com/BretFisher/dogvscat>example</a> using Swarm</li> <li>COPY vs ADD. Use COPY to copy artefacts in the same repo to the image. Use ADD when you want to download something from the Internet or to untar or unzip. You can also replace using wget statements with ADD.</li> <li>Combine multiple RUN into a single statement. </li> <li>Delete packages which are downloaded and installed also in a single command to save image size.</li> <li>No secrets like configs, certificates should be saved in Image. Pass them during runtime.</li> <li>Always have a CMD in the image, even if its inheriting it from BASE image</li> <li>Version apt packages and BASE images</li> <li>Use multistage Dokcer builds to have Dev dependencies and Prod dependencies separate.</li> <li>Have healthchecks in K8s instead of Dockerfile</li> <li>Use DNS RoundRobin for Database inside Compose file so it switches of Virtual IP on the Overlay network and gives direct access from FrontEnd Service to Backend container.</li> <li>Setting resource limits inside Compose file</li> <li>DRY your compose files using templates</li> </ul> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../terraform/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Terraform </div> </div> </a> <a href=../../k8s/k8s-notes/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Kubernetes </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2018 - 2019 Leslie </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> with emoji by <a href=https://github.com/twitter/twemoji target=_blank rel=noopener> Twemoji </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script> <script src=../../../assets/javascripts/bundle.ca5457b8.min.js></script> </body> </html>