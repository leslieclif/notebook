
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Leslie">
      
      
        <link rel="canonical" href="https://leslieclif.github.io/notebook/learning/k8s/ks8-notes/">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.3">
    
    
      
        <title>Ks8 notes - Leslie's Online Notebook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1655a90d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#why-kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://leslieclif.github.io/notebook/" title="Leslie&#39;s Online Notebook" class="md-header__button md-logo" aria-label="Leslie's Online Notebook">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Leslie's Online Notebook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ks8 notes
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://leslieclif.github.io/notebook/" title="Leslie&#39;s Online Notebook" class="md-nav__button md-logo" aria-label="Leslie's Online Notebook">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Leslie's Online Notebook
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        Home
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer/" class="md-nav__link">
        Setup
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Server
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Server" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../server/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../server/install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../server/mobile/" class="md-nav__link">
        Mobile
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Devops
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Devops" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Devops
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../k8s/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../k8s/install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        IDE
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="IDE" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          IDE
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../ide/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../ide/markdown/" class="md-nav__link">
        Markdown
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Learning
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Learning" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Learning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../git/" class="md-nav__link">
        Git
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../python/" class="md-nav__link">
        Python
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../vagrant/" class="md-nav__link">
        Vagrant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ansible/" class="md-nav__link">
        Ansible
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../terraform/" class="md-nav__link">
        Terraform
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker-notes/" class="md-nav__link">
        Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../k8s-notes.md" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#k8s-learning-resources" class="md-nav__link">
    K8s Learning Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-kubernetes" class="md-nav__link">
    Install Kubernetes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-container-abstractions" class="md-nav__link">
    Kubernetes Container Abstractions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#our-first-pod-with-kubectl-run" class="md-nav__link">
    Our First Pod With Kubectl run
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-replicasets" class="md-nav__link">
    Scaling ReplicaSets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspecting-kubernetes-objects" class="md-nav__link">
    Inspecting Kubernetes Objects
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <ul>
<li><a href="https://github.com/wercker/stern">Tailing logs from multiple containers on laptop</a></li>
<li><a href="https://kubernetes.io/docs/tutorials/">K8s Tutorials</a></li>
<li><a href="https://github.com/kubernetes/dns/blob/master/docs/specification.md">K8s DNS</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/conventions/">Kubectl Usage Convention</a></li>
<li><a href="https://kubernetes.io/docs/reference/#api-reference">K8s API Reference</a></li>
<li><a href="https://operatorhub.io/">Operator Hub</a></li>
<li><a href="https://github.com/operator-framework/awesome-operators">Awesome Operator List</a></li>
<li></li>
</ul>
<h1 id="why-kubernetes">Why Kubernetes</h1>
<ul>
<li>Orchestration: Next logical step in journey to faster DevOps</li>
<li>First, understand why you <em>may</em> need orchestration</li>
<li>Not every solution needs orchestration</li>
<li>Servers + Change Rate = Benefit of orchestration</li>
</ul>
<h2 id="k8s-learning-resources">K8s Learning Resources</h2>
<ul>
<li><a href="http://play-with-k8s.com">Play with k8s</a></li>
<li><a href="katacoda.com">Katacoda</a></li>
</ul>
<h2 id="install-kubernetes">Install Kubernetes</h2>
<ul>
<li>
<p>Linux - Microk8s
Install SNAP first using apt-get
<div class="highlight"><pre><span></span><code>sudo snap install microk8s --classic --channel<span class="o">=</span><span class="m">1</span>.17/stable # Install specific k8s version
microk8s.enable dns # Enbale DNS 
microk8s.status # Check status
</code></pre></div></p>
</li>
<li>
<p>Windows - Minikube
<div class="highlight"><pre><span></span><code>minikube start --kubernetes-version<span class="o">=</span><span class="s1">&#39;1.17.4&#39;</span> # Install specific k8s version
minikube ip # IP of the machine
minikube status # Check status 
minikube stop # Stop minkube service    
</code></pre></div></p>
</li>
</ul>
<h2 id="kubernetes-container-abstractions">Kubernetes Container Abstractions</h2>
<ul>
<li>Pod: one or more containers running together on one Node. Basic unit of deployment. Containers are always in pods</li>
<li>Controller: For creating/updating pods and other objects. Many types of Controllers inc. Deployment, ReplicaSet, StatefulSet, DaemonSet, Job, CronJob, etc.</li>
<li>Service: network endpoint to connect to a pod</li>
<li>Namespace: Filtered group of objects in cluster - Secrets, ConfigMaps, and more.</li>
</ul>
<h2 id="our-first-pod-with-kubectl-run">Our First Pod With Kubectl run</h2>
<ul>
<li>Two ways to deploy Pods (containers): Via commands, or via YAML</li>
<li>Object hieracrhy - Pods -&gt; ReplicaSet -&gt; Deployment
<div class="highlight"><pre><span></span><code>kubectl run my-nginx --image nginx # Creates a single pod
kubectl run nginx-pod --generator<span class="o">=</span>run-pod/v1 --
image nginx # Another way to create pod
kubectl get pods # list the pod
kubectl create deployment nginx --image nginx # Creates a deployment
kubectl deployment deployment nginx # Deletes a deployment
kubectl create deployment nginx --image nginx --dry-run --port <span class="m">80</span> --
<span class="k">expose</span><span class="s"> # Using Dry run option</span>
</code></pre></div></li>
</ul>
<h2 id="scaling-replicasets">Scaling ReplicaSets</h2>
<div class="highlight"><pre><span></span><code>kubectl create deployment my-apache --image httpd
kubectl scale deploy/my-apache --replicas <span class="m">2</span> # Scale up by <span class="m">2</span>
kubectl scale deployment my-apache --replicas <span class="m">2</span> # Scale up by <span class="m">2</span>
kubectl get all
</code></pre></div>
<h2 id="inspecting-kubernetes-objects">Inspecting Kubernetes Objects</h2>
<div class="highlight"><pre><span></span><code>kubectl get deploy,pods # Get multiple resources <span class="k">in</span> one line
kubectl get pods -o wide # Get all pods, <span class="k">in</span> wide format <span class="o">(</span>gives more info<span class="o">)</span>
kubectl get pods --show-labels # Get all pods and show labels
kubectl logs deployment/my-apache 
kubectl logs deployment/my-apache --follow --tail <span class="m">1</span> # Show the last line
kubectl logs -l <span class="nv">run</span><span class="o">=</span>my-apache # Show logs using label
kubectl describe pod/my-apache-&lt;pod id&gt; # Shows the pod configuration including events
kubectl get pods -w # Watches the pods <span class="k">in</span> real time
kubectl delete pod/my-apache-&lt;pod id&gt; # Deletes a single instance
</code></pre></div>
<h1 id="exposing-kubernetes-ports">Exposing Kubernetes Ports</h1>
<ul>
<li>A service is a stable address for pod(s)</li>
<li>If we want to connect to pod(s), we need a service</li>
<li>CoreDNS allows us to resolve services by name</li>
<li>There are different types of services</li>
<li>ClusterIP</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>ExternalName</li>
<li>ClusterIP and NodePort services are always available in Kubernetes</li>
<li><code>kubectl expose</code> creates a service for existing pods</li>
</ul>
<h2 id="basic-service-types">Basic Service Types</h2>
<ol>
<li>ClusterIP (default)</li>
<li>Single, internal virtual IP allocated</li>
<li>Only reachable from within cluster (nodes and pods)</li>
<li>Pods can reach service on apps port number</li>
<li>NodePort</li>
<li>High port allocated on each node</li>
<li>Port is open on every node’s IP</li>
<li>Anyone can connect (if they can reach node)</li>
<li>Other pods need to be updated to this port</li>
<li>LoadBalancer</li>
<li>Controls a LB endpoint external to the cluster</li>
<li>Only available when infra provider gives you a LB (AWS ELB, etc)</li>
<li>Creates NodePort+ClusterIP services, tells LB to send to NodePort</li>
<li>ExternalName</li>
<li>Adds CNAME DNS record to CoreDNS only</li>
<li>Not used for Pods, but for giving pods a DNS name to use for something outside Kubernetes</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c"># To show how to reach a ClusterIP deployment which is only accessible from the cluster in a Laptop</span>
kubectl create deployment httpenv --image<span class="o">=</span>bretfisher/httpenv # simple http server
kubectl scale deployment/httpenv --replicas<span class="o">=</span><span class="m">5</span>
kubectl expose deployment/httpenv --port <span class="m">8888</span> # Create a ClusterIP service <span class="o">(</span>default<span class="o">)</span>
kubectl get service # Shows services
<span class="c"># Uses Generator option and launches the pod and gives BASH terminal</span>
kubectl run --generator run-pod/v1 tmp-shell --rm -it --image bretfisher/netshoot -- bash # Launch another pod to run curl
curl httpenv:8888
curl <span class="o">[</span>ip of service<span class="o">]</span>:8888 # 
</code></pre></div>
<h2 id="creating-a-nodeport-and-loadbalancer-service">Creating a NodePort and LoadBalancer Service</h2>
<ul>
<li>Nodeport Port Range: 30000 to 32767</li>
<li>Did you know that a NodePort service also creates a ClusterIP?</li>
<li>These three service types are additive, each one
creates the ones above it:</li>
<li>ClusterIP</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>If you're on Docker Desktop, it provides a built-in LoadBalancer
that publishes the --port on localhost</li>
<li>If you're on kubeadm, minikube, or microk8s</li>
<li>No built-in LB</li>
<li>You can still run the command, it'll just stay at</li>
<li>LoadBalancer recieves the packet on 8888, then transfers it to the Nodeport of the Node and then to the ClusterIP of the service.
"pending" (but its NodePort works)
<div class="highlight"><pre><span></span><code>kubectl expose deployment/httpenv --port <span class="m">8888</span> --name httpenv-np --type NodePort
kubectl get services
curl localhost:&lt;Node Port&gt; # Get this from svc output
kubectl expose deployment/httpenv --port <span class="m">8888</span> --name httpenv-lb --type LoadBalancer
kubectl get services
curl localhost:8888 # Pod Port
kubectl delete service/httpenv service/httpenv-np
kubectl delete service/httpenv-lb deployment/httpenv
</code></pre></div></li>
</ul>
<h2 id="kubernetes-services-dns">Kubernetes Services DNS</h2>
<ul>
<li>Internal DNS is provided by CoreDNS</li>
<li>Services also have a FQDN<blockquote>
<p>curl <code>&lt;hostname&gt;.&lt;namespace&gt;.svc.cluster.local</code>
<div class="highlight"><pre><span></span><code>curl &lt;hostname&gt;
kubectl get namespaces
curl &lt;hostname&gt;.&lt;namespace&gt;.svc.cluster.local
</code></pre></div></p>
</blockquote>
</li>
</ul>
<h1 id="kubernetes-management-techniques">Kubernetes Management Techniques</h1>
<h2 id="run-expose-and-create-generators">Run, Expose and Create Generators</h2>
<ul>
<li>These commands use helper templates called "generators"</li>
<li>Every resource in Kubernetes has a specification or "spec"</li>
<li>You can output those templates with --dry-run -o yaml<blockquote>
<p>kubectl create deployment sample --image nginx --dry-run -o yaml</p>
</blockquote>
</li>
<li>You can use those YAML defaults as a starting point</li>
<li>Generators are "opinionated defaults"</li>
</ul>
<h3 id="generator-examples">Generator Examples</h3>
<p>• Using dry-run with yaml output we can see the generators</p>
<blockquote>
<p>kubectl create deployment test --image nginx --dry-run -o yaml
kubectl create job test --image nginx --dry-run -o yaml
kubectl expose deployment/test --port 80 --dry-run -o yaml
- You need the deployment to exist before this works</p>
</blockquote>
<h2 id="imperative-vs-declarative">Imperative vs. Declarative</h2>
<blockquote>
<p><strong>Imperative</strong>: Focus on how a program operates</p>
<p><strong>Declarative</strong>: Focus on what a program should accomplish
- Example: "I'd like a cup of coffee"
<strong>Imperative</strong>: I boil water, scoop out 42 grams of medium-fine
grounds, poor over 700 grams of water, etc.</p>
<p><strong>Declarative</strong>: "Barista, I'd like a a cup of coffee".
(Barista is the engine that works through the
steps, including retrying to make a cup, and is
only finished when I have a cup)</p>
</blockquote>
<h3 id="kubernetes-imperative">Kubernetes Imperative</h3>
<ul>
<li>Examples: <blockquote>
<p>kubectl run, kubectl create deployment, kubectl update</p>
</blockquote>
</li>
<li>We start with a state we know (no deployment exists)</li>
<li>We ask kubectl run to create a deployment</li>
<li>Different commands are required to change that deployment</li>
<li>Different commands are required per object</li>
<li>Imperative is easier when you know the state</li>
<li>Imperative is easier to get started</li>
<li>Imperative is easier for humans at the CLI</li>
<li>Imperative is NOT easy to automate</li>
</ul>
<h3 id="kubernetes-declarative">Kubernetes Declarative</h3>
<ul>
<li>Example: <blockquote>
<p>kubectl apply -f my-resources.yaml</p>
</blockquote>
</li>
<li>We don't know the current state</li>
<li>We only know what we want the end result to be (yaml contents)</li>
<li>Same command each time (tiny exception for delete)</li>
<li>Resources can be all in a file, or many files (apply a whole dir)</li>
<li>Requires understanding the YAML keys and values</li>
<li>More work than <code>kubectl run</code> for just starting a pod</li>
<li>The easiest way to automate</li>
<li>The eventual path to GitOps happiness</li>
</ul>
<h2 id="three-management-approaches">Three Management Approaches</h2>
<ol>
<li>Imperative commands:<blockquote>
<p>run, expose, scale, edit, create deployment</p>
</blockquote>
</li>
<li>Best for dev/learning/personal projects</li>
<li>Easy to learn, hardest to manage over time</li>
<li><a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/imperative-command/">Imperative Commands</a></li>
<li>Imperative objects: <blockquote>
<p>create -f file.yml, replace -f file.yml, delete...</p>
</blockquote>
</li>
<li>Good for prod of small environments, single file per command</li>
<li>Store your changes in git-based yaml files</li>
<li>Hard to automate</li>
<li><a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Config File</a></li>
<li>Declarative objects: apply -f file.yml or dir\, diff</li>
<li>Best for prod, easier to automate</li>
<li>Harder to understand and predict changes</li>
<li><a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/">Declarative Config File</a></li>
</ol>
<h2 id="recommendations">Recommendations</h2>
<ol>
<li><strong>Most Important Rule</strong>: Don't mix the three approaches</li>
<li>Recommendations:</li>
<li>Learn the Imperative CLI for easy control of local and test setups</li>
<li>Move to apply -f file.yml and apply -f directory for prod</li>
<li>Store yaml in git, git commit each change before
you apply</li>
<li>This trains you for later doing GitOps (where git
commits are automatically applied to clusters)</li>
</ol>
<h1 id="moving-to-declarative-kubernetes-yaml">Moving to Declarative Kubernetes YAML</h1>
<h2 id="using-kubectl-apply">Using kubectl apply</h2>
<ul>
<li>
<p>create/update resources in a file</p>
<blockquote>
<p>kubectl apply -f myfile.yaml</p>
</blockquote>
</li>
<li>
<p>create/update a whole directory of yaml</p>
<blockquote>
<p>kubectl apply -f myyaml/</p>
</blockquote>
</li>
<li>
<p>create/update from a URL</p>
<blockquote>
<p>kubectl apply -f <a href="https://bret.run/pod.yml">https://bret.run/pod.yml</a></p>
</blockquote>
</li>
<li>
<p>Be careful, lets look at it first (browser or curl)
<div class="highlight"><pre><span></span><code><span class="c1"># Using Shell </span>
curl -L https://bret.run/pod
<span class="c1"># Using Windows CMD </span>
Win PoSH? start https://bret.run/pod.yml
</code></pre></div></p>
</li>
</ul>
<h2 id="kubernetes-configuration-yaml">Kubernetes Configuration YAML</h2>
<ul>
<li>Kubernetes configuration file (YAML or JSON)</li>
<li>Each file contains one or more manifests</li>
<li>Each manifest describes an API object (deployment, job, secret)</li>
<li>Each manifest needs four parts (root key:values in the file)
<div class="highlight"><pre><span></span><code>apiVersion:
kind:
metadata:
spec:
</code></pre></div></li>
</ul>
<h2 id="building-your-yaml-files">Building Your YAML Files</h2>
<ol>
<li><strong>kind</strong>: We can get a list of resources the cluster supports<blockquote>
<p>kubectl api-resources</p>
</blockquote>
</li>
<li>Notice some resources have multiple API's (old vs. new)</li>
<li><strong>apiVersion</strong>: We can get the API versions the cluster supports<blockquote>
<p>kubectl api-versions</p>
</blockquote>
</li>
<li><strong>metadata</strong>: only name is required</li>
<li><strong>spec</strong>: Where all the action is at!</li>
</ol>
<h2 id="building-your-yaml-spec-explain-command">Building Your YAML spec - explain Command</h2>
<ul>
<li>We can get all the keys each kind supports<blockquote>
<p>kubectl explain services --recursive</p>
</blockquote>
</li>
<li>Oh boy! Let's slow down<blockquote>
<p>kubectl explain services.spec</p>
</blockquote>
</li>
<li>We can walk through the spec this way<blockquote>
<p>kubectl explain services.spec.type</p>
</blockquote>
</li>
<li>spec: can have sub spec: of other resources<blockquote>
<p>kubectl explain deployment.spec.template.spec.volumes.nfs.server</p>
</blockquote>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Use <code>kubectl api-versions</code> or <code>kubectl api-resources</code> along with <code>kubectl explain</code> as documentation on explain could be old</p>
</div>
<ul>
<li>We can also use docs<blockquote>
<p>kubernetes.io/docs/reference/#api-reference</p>
</blockquote>
</li>
</ul>
<h2 id="dry-runs-with-apply-yaml">Dry Runs With Apply YAML</h2>
<ul>
<li>dry-run a create (client side only)<blockquote>
<p>kubectl apply -f app.yml --dry-run</p>
</blockquote>
</li>
<li>dry-run a create/update on server<blockquote>
<p>kubectl apply -f app.yml --server-dry-run</p>
</blockquote>
</li>
<li>see a diff visually<blockquote>
<p>kubectl diff -f app.yml</p>
</blockquote>
</li>
<li><a href="https://kubernetes.io/blog/2019/01/14/apiserver-dry-run-and-kubectl-diff/">Difference between dry-run and diff</a></li>
</ul>
<h2 id="labels-and-label-selectors">Labels and Label Selectors</h2>
<ul>
<li><strong>Labels</strong> goes under metadata: in your YAML</li>
<li>Simple list of key: value for identifying your resource later by
selecting, grouping, or filtering for it</li>
<li>Common examples include tier: <blockquote>
<p>frontend, app: api, env: prod,
customer: acme.co</p>
</blockquote>
</li>
<li>Not meant to hold complex, large, or non-
identifying info, which is what <strong>annotations</strong> are for</li>
<li>filter a get command<blockquote>
<p>kubectl get pods -l app=nginx</p>
</blockquote>
</li>
<li>apply only matching labels<blockquote>
<p>kubectl apply -f myfile.yaml -l app=nginx</p>
</blockquote>
</li>
<li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/">Label Recommendation</a></li>
</ul>
<h3 id="label-selectors-use-case-for-labels">Label Selectors (Use case for Labels)</h3>
<ul>
<li>The "glue" telling Services and Deployments which pods are theirs</li>
<li>Many resources use Label Selectors to "link" resource dependencies</li>
<li>You'll see these match up in the <strong>Service and Deployment YAML</strong></li>
<li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors">Using Label selectors </a></li>
<li>Use Labels and Selectors to control which pods go to which nodes</li>
<li><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/">Assigning Pods to Nodes</a></li>
<li>Taints and Tolerations also control node placement</li>
<li><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">Taints and Tolerations</a></li>
</ul>
<h1 id="your-next-steps-and-the-future-of-kubernetes">Your Next Steps, and The Future of Kubernetes</h1>
<h2 id="storage-in-kubernetes">Storage in Kubernetes</h2>
<ul>
<li>Storage and stateful workloads are harder in all systems</li>
<li>Containers make it both harder and easier than before</li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a> is a new resource type, making Pods more sticky</li>
<li><strong>Recommendation</strong>: avoid stateful workloads for first few
deployments until you're good at the basics</li>
<li>Use db-as-a-service whenever you can</li>
</ul>
<h3 id="volumes-in-kubernetes">Volumes in Kubernetes</h3>
<ul>
<li>Creating and connecting Volumes: 2 types</li>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/">Volumes</a></li>
<li>Tied to lifecycle of a Pod</li>
<li>All containers in a single Pod can share them</li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/">PersistentVolumes</a></li>
<li>Created at the cluster level, outlives a Pod</li>
<li>Separates storage config from Pod using it</li>
<li>Multiple Pods can share them<blockquote>
<p>CSI plugins are the new way to connect to storage</p>
</blockquote>
</li>
</ul>
<h2 id="ingress"><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></h2>
<ul>
<li>None of our Service types work at OSI Layer 7 (HTTP)</li>
<li>How do we route outside connections based on hostname or URL?<blockquote>
<p>Example Usecase: app1.com and app2.com are 2 different deployments in the cluster and both listen on port 443. You will need Ingress to understand the DNS and route traffic to those apps</p>
</blockquote>
</li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a> (optional) do this with 3<sup>rd</sup> party proxies</li>
<li>Nginx is popular, but Traefik, HAProxy, F5, Envoy, Istio, etc.</li>
<li>Recommendation: Check out <a href="https://doc.traefik.io/traefik/v2.0/providers/kubernetes-crd/#traefik-ingressroute-definition">Traefik</a></li>
<li>Implementation is specific to Controller chosen</li>
<li>Why Controller - To configure LB which is outside the cluster</li>
</ul>
<h2 id="crds-and-the-operator-pattern"><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRD's</a> and <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">The Operator Pattern</a></h2>
<ul>
<li>You can add 3<sup>rd</sup> party Resources and Controllers</li>
<li>This extends Kubernetes API and CLI</li>
<li>A pattern is starting to emerge of using these together</li>
<li><strong>Operator</strong>: automate deployment and management of complex apps<blockquote>
<p>e.g. Databases, monitoring tools, backups, and custom ingresses</p>
</blockquote>
</li>
</ul>
<h2 id="higher-deployment-abstractions">Higher Deployment Abstractions</h2>
<ul>
<li>All our kubectl commands just talk to the Kubernetes API</li>
<li>Kubernetes has limited built-in templating, versioning, tracking,
and management of your apps</li>
<li><strong>Helm</strong> is the most popular</li>
<li><strong><a href="https://github.com/docker/compose-on-kubernetes/tree/master/docs">Compose on Kubernetes</a></strong> comes with Docker
Desktop</li>
<li>Remember these are optional, and your distro may have a preference</li>
<li>Most distros support Helm</li>
</ul>
<h3 id="templating-yaml">Templating YAML</h3>
<ul>
<li>Many of the deployment tools have templating options</li>
<li>You'll need a solution as the number of environments/apps grow</li>
<li>Helm was the first "winner" in this space, but can be complex</li>
<li>Official <a href="https://kubernetes.io/blog/2018/05/29/introducing-kustomize-template-free-configuration-customization-for-kubernetes/">Kustomize</a> feature works out-of-the-box (as of 1.14)</li>
<li>docker app and compose-on-kubernetes are Docker's way</li>
</ul>
<h2 id="kubernetes-dashboard"><a href="https://github.com/kubernetes/dashboard">Kubernetes Dashboard</a></h2>
<ul>
<li>Default GUI for "upstream" Kubernetes</li>
<li>Clouds don't have it by default</li>
<li>Let's you view resources and upload YAML</li>
<li>Safety first!</li>
</ul>
<h2 id="namespaces-and-context"><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">Namespaces</a> and <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">Context</a></h2>
<ul>
<li>Namespaces limit scope, aka "virtual clusters"</li>
<li>Not related to Docker/Linux namespaces</li>
<li>Won't need them in small clusters</li>
<li>There are some built-in, to hide system stuff from kubectl "users"<blockquote>
<p><code>kubectl get namespaces</code></p>
</blockquote>
</li>
</ul>
<blockquote>
<p><code>kubectl get all --all-namespaces</code>
- Context changes kubectl cluster and namespace
- See <code>~/.kube/config</code> file
<code>kubectl config get-contexts</code>
<div class="highlight"><pre><span></span><code><span class="c"># Selectively show output of Kube config</span>
kubectl config get-contexts -o name
</code></pre></div>
<code>kubectl config set*</code></p>
</blockquote>
<p><div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 - 2019 Leslie
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.ca5457b8.min.js"></script>
      
    
  </body>
</html>